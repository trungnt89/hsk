<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Reading Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system;
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }
    li {
      list-style: none;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 6px;
      cursor: pointer;
    }
    li.active {
      background: #e8f0ff;
      border-color: #4a7cff;
    }
    .controls, .play-modes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    select, button {
      padding: 8px;
      font-size: 15px;
    }
  </style>
</head>
<body>

<h1>ğŸ“– Japanese Reading Practice (Cached)</h1>

<div class="controls">
  <select id="voice">
    <option value="ja-JP-NanamiNeural">Ná»¯ â€“ Nanami</option>
    <option value="ja-JP-KeitaNeural" selected>Nam â€“ Keita</option>
  </select>

  <select id="rate">
    <option value="0.7">Ráº¥t cháº­m</option>
    <option value="0.85">Cháº­m</option>
    <option value="1.0">BÃ¬nh thÆ°á»ng</option>
    <option value="1.1">HÆ¡i nhanh</option>
    <option value="1.25">Nhanh</option>
  </select>
</div>

<div class="play-modes">
  <button onclick="playCurrent()">â–¶ï¸ Äá»c Ä‘oáº¡n</button>
  <button onclick="playAll()">â–¶ï¸â–¶ï¸ Äá»c láº§n lÆ°á»£t</button>
  <button onclick="toggleRepeatOne()">ğŸ”‚ Láº·p 1 Ä‘oáº¡n</button>
  <button onclick="toggleRepeatAll()">ğŸ” Láº·p cáº£ danh sÃ¡ch</button>
</div>

<ul id="list"></ul>

<audio id="audio" controls style="width:100%; margin-top:16px;"></audio>

<script>
/* ====================== CONFIG ====================== */
const API_URL = "https://hsk-gilt.vercel.app/api/tts1";
const DB_NAME = "tts-audio-cache";
const STORE_NAME = "audio";

/* ====================== SAMPLE TEXT ====================== */
const texts = [
  "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚",
  "ã¯ã˜ã‚ã¾ã—ã¦ã€‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚",
  "ã“ã‚Œã¯ç§ã®æœ¬ã§ã™ã€‚ã¨ã¦ã‚‚é¢ç™½ã„ã§ã™ã‚ˆã€‚",
  "æ˜¨æ—¥ã¯å¿™ã—ã‹ã£ãŸã§ã™ãŒã€æ¥½ã—ã‹ã£ãŸã§ã™ã€‚",
  "ã™ã¿ã¾ã›ã‚“ã€ã‚‚ã†ä¸€åº¦è¨€ã£ã¦ãã ã•ã„ã€‚",
  "æ—¥æœ¬èªã‚’å‹‰å¼·ã™ã‚‹ã®ã¯æ¥½ã—ã„ã§ã™ã€‚",
  "é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿã“ã“ã‹ã‚‰è¿‘ã„ã§ã™ã‹ã€‚",
  "ä»Šæ—¥ã¯ä»•äº‹ãŒçµ‚ã‚ã£ãŸã‚‰æ—©ãå¸°ã‚Šã¾ã™ã€‚",
  "ã‚³ãƒ¼ãƒ’ãƒ¼ã¨ã‚±ãƒ¼ã‚­ã‚’ä¸€ã¤ãŠé¡˜ã„ã—ã¾ã™ã€‚",
  "æ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚"
];

let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;

const audio = document.getElementById("audio");
const listEl = document.getElementById("list");

/* ====================== UI ====================== */
renderList();

function renderList() {
  listEl.innerHTML = "";
  texts.forEach((text, i) => {
    const li = document.createElement("li");
    li.textContent = text;
    li.onclick = () => {
      currentIndex = i;
      playCurrent();
    };
    listEl.appendChild(li);
  });
  highlight();
}

function highlight() {
  [...listEl.children].forEach((li, i) => {
    li.classList.toggle("active", i === currentIndex);
  });
}

/* ====================== INDEXED DB ====================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(STORE_NAME);
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = reject;
  });
}

async function getCachedAudio(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result || null);
  });
}

async function saveAudio(key, blob) {
  const db = await openDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).put(blob, key);
}

/* ====================== PLAY LOGIC ====================== */
function buildKey(text) {
  const voice = voiceEl().value;
  const rate = rateEl().value;
  return `ja-JP|${voice}|${rate}|${text}`;
}

function buildUrl(text) {
  return `${API_URL}?text=${encodeURIComponent(text)}`
    + `&lang=ja-JP`
    + `&voice=${voiceEl().value}`
    + `&rate=${rateEl().value}`;
}

async function playCurrent() {
  highlight();
  const text = texts[currentIndex];
  const key = buildKey(text);

  const cached = await getCachedAudio(key);
  if (cached) {
    audio.src = URL.createObjectURL(cached);
    audio.play();
    return;
  }

  const res = await fetch(buildUrl(text));
  const blob = await res.blob();
  await saveAudio(key, blob);

  audio.src = URL.createObjectURL(blob);
  audio.play();
}

function playAll() {
  repeatOne = false;
  playCurrent();
}

function toggleRepeatOne() {
  repeatOne = !repeatOne;
  repeatAll = false;
  alert("Láº·p 1 Ä‘oáº¡n: " + (repeatOne ? "Báº¬T" : "Táº®T"));
}

function toggleRepeatAll() {
  repeatAll = !repeatAll;
  repeatOne = false;
  alert("Láº·p cáº£ danh sÃ¡ch: " + (repeatAll ? "Báº¬T" : "Táº®T"));
}

audio.addEventListener("ended", () => {
  if (repeatOne) return playCurrent();

  currentIndex++;
  if (currentIndex >= texts.length) {
    if (repeatAll) currentIndex = 0;
    else return;
  }
  playCurrent();
});

/* ====================== HELPERS ====================== */
const voiceEl = () => document.getElementById("voice");
const rateEl = () => document.getElementById("rate");
</script>

</body>
</html>
