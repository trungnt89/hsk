<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Dashboard & Decimal Support</title>
    <style>
        :root { --work: #e74c3c; --break: #27ae60; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; margin-bottom: 20px; }
        
        .status-label { font-size: 1.1rem; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; color: #7f8c8d; }
        .timer-display { font-size: 5.5rem; font-weight: 800; color: var(--dark); margin: 5px 0; font-variant-numeric: tabular-nums; }
        
        .controls button { padding: 12px 24px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; border-radius: 12px; margin: 5px; transition: 0.3s; }
        #startBtn { background: #3498db; color: white; width: 140px; }
        #resetBtn { background: #eee; color: var(--dark); }
        #stopAlarmBtn { background: #f1c40f; color: #333; display: none; width: 100%; margin-top: 15px; animation: pulse 1s infinite; }

        .progress-section { margin-top: 25px; text-align: left; }
        .progress-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; margin-bottom: 8px; }
        .progress-container { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-bar { background: var(--break); height: 100%; width: 0%; transition: 1s cubic-bezier(0.4, 0, 0.2, 1); }

        .settings { margin-top: 25px; display: flex; justify-content: space-between; background: #fafafa; padding: 15px; border-radius: 12px; }
        .setting-group { display: flex; flex-direction: column; align-items: flex-start; }
        .setting-group label { font-size: 11px; color: #95a5a6; margin-bottom: 4px; text-transform: uppercase; }
        .setting-group input { width: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; outline: none; }

        /* Dashboard Styles */
        .dashboard { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; }
        .dashboard h3 { margin: 0 0 15px 0; font-size: 1.2rem; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .history-item:last-child { border: none; }
        .history-date { color: #7f8c8d; }
        .history-count { font-weight: bold; color: var(--break); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        body.work-mode { background: #fff5f5; }
        body.break-mode { background: #f0fff4; }
    </style>
</head>
<body class="work-mode">

<div class="container">
    <div id="status" class="status-label">S·∫µn s√†ng h·ªçc t·∫≠p</div>
    <div class="timer-display" id="timer">25:00</div>

    <div class="controls">
        <button id="startBtn" onclick="toggleTimer()">B·∫ÆT ƒê·∫¶U</button>
        <button id="resetBtn" onclick="resetTimer()">ƒê·∫∂T L·∫†I</button>
        <button id="stopAlarmBtn" onclick="stopAlarm()">D·ª™NG CHU√îNG üîî</button>
    </div>

    <div class="progress-section">
        <div class="progress-header">
            <span>Ti·∫øn ƒë·ªô ng√†y</span>
            <span id="pomoCount">0/4</span>
        </div>
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>
    </div>

    <div class="settings">
        <div class="setting-group">
            <label>L√†m vi·ªác (ph√∫t)</label>
            <input type="number" id="workInput" value="25" step="0.01" min="0.01" onchange="saveSettings()">
        </div>
        <div class="setting-group">
            <label>Ngh·ªâ ng∆°i (ph√∫t)</label>
            <input type="number" id="breakInput" value="5" step="0.01" min="0.01" onchange="saveSettings()">
        </div>
    </div>
</div>

<div class="dashboard">
    <h3>üìä L·ªãch s·ª≠ Pomodoro</h3>
    <div id="historyList" class="history-list">
        <p style="color:#999; font-size:12px">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠...</p>
    </div>
</div>

<audio id="alarmAudio" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
</audio>

<script>
    let timer, isRunning = false, isWorkMode = true, timeLeft;
    let pomoCompletedToday = 0;
    let db;

    // --- C·∫§U H√åNH INDEXEDDB ---
    const request = indexedDB.open("PomodoroV2", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        db.createObjectStore("settings", { keyPath: "id" });
        db.createObjectStore("history", { keyPath: "date" });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadData();
    };

    function loadData() {
        // Load Settings
        db.transaction("settings").objectStore("settings").get("config").onsuccess = (e) => {
            if(e.target.result) {
                document.getElementById('workInput').value = e.target.result.work;
                document.getElementById('breakInput').value = e.target.result.break;
                resetTimer();
            }
        };

        // Load Dashboard
        renderDashboard();
    }

    async function renderDashboard() {
        const listEl = document.getElementById('historyList');
        const tx = db.transaction("history", "readonly");
        const store = tx.objectStore("history");
        const request = store.getAll();

        request.onsuccess = () => {
            const data = request.result.sort((a,b) => new Date(b.date) - new Date(a.date));
            const todayStr = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD
            
            if(data.length > 0) {
                listEl.innerHTML = data.map(item => `
                    <div class="history-item">
                        <span class="history-date">${item.date === todayStr ? 'H√¥m nay' : item.date}</span>
                        <span class="history-count">${item.count} Pomodoro</span>
                    </div>
                `).join('');
                
                const todayData = data.find(i => i.date === todayStr);
                pomoCompletedToday = todayData ? todayData.count : 0;
                updateGoalUI();
            }
        };
    }

    function saveSettings() {
        const work = parseFloat(document.getElementById('workInput').value);
        const breakTime = parseFloat(document.getElementById('breakInput').value);
        
        const tx = db.transaction("settings", "readwrite");
        tx.objectStore("settings").put({ id: "config", work, break: breakTime });
        if(!isRunning) resetTimer();
    }

    function saveHistory() {
        const dateStr = new Date().toLocaleDateString('sv-SE');
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").put({ date: dateStr, count: pomoCompletedToday });
        tx.oncomplete = renderDashboard;
    }

    // --- LOGIC ƒê·∫æM NG∆Ø·ª¢C ---
    function updateDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = Math.floor(timeLeft % 60);
        const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        document.getElementById('timer').textContent = timeStr;
        document.title = `${timeStr} - Pomodoro`;
    }

    function toggleTimer() {
        if (isRunning) {
            clearInterval(timer);
            document.getElementById('startBtn').textContent = "TI·∫æP T·ª§C";
        } else {
            document.getElementById('startBtn').textContent = "T·∫†M D·ª™NG";
            timer = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    startAlarm();
                }
            }, 1000);
        }
        isRunning = !isRunning;
    }

    function startAlarm() {
        document.getElementById('alarmAudio').play();
        document.getElementById('stopAlarmBtn').style.display = 'block';
        document.getElementById('startBtn').style.display = 'none';
    }

    function stopAlarm() {
        const alarm = document.getElementById('alarmAudio');
        alarm.pause(); alarm.currentTime = 0;
        document.getElementById('stopAlarmBtn').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        
        if (isWorkMode) {
            pomoCompletedToday++;
            saveHistory();
        }
        switchMode();
    }

    function switchMode() {
        isWorkMode = !isWorkMode;
        if (isWorkMode) {
            timeLeft = parseFloat(document.getElementById('workInput').value) * 60;
            document.getElementById('status').textContent = "L√†m vi·ªác!";
            document.body.className = "work-mode";
        } else {
            timeLeft = parseFloat(document.getElementById('breakInput').value) * 60;
            document.getElementById('status').textContent = "Gi·∫£i lao th√¥i";
            document.body.className = "break-mode";
        }
        updateDisplay();
        isRunning = false;
        toggleTimer();
    }

    function updateGoalUI() {
        document.getElementById('pomoCount').textContent = `${pomoCompletedToday}/4`;
        const progress = Math.min((pomoCompletedToday / 4) * 100, 100);
        document.getElementById('progressBar').style.width = progress + "%";
    }

    function resetTimer() {
        clearInterval(timer);
        isRunning = false;
        isWorkMode = true;
        timeLeft = parseFloat(document.getElementById('workInput').value) * 60;
        document.getElementById('status').textContent = "S·∫µn s√†ng h·ªçc t·∫≠p";
        document.getElementById('startBtn').textContent = "B·∫ÆT ƒê·∫¶U";
        document.body.className = "work-mode";
        updateDisplay();
    }

    // Init
    timeLeft = 25 * 60;
    updateDisplay();
</script>
</body>
</html>