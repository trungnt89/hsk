<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Scheduler - Premium UI</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex; justify-content: center;
            padding: 40px 15px; margin: 0;
        }

        .container {
            background: var(--card);
            width: 100%; max-width: 900px;
            padding: 32px; border-radius: 24px;
            box-shadow: var(--shadow);
            border: 1px solid #f1f5f9;
        }

        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.4s ease-out; }

        .nav-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 28px; padding-bottom: 20px; border-bottom: 2px solid #f1f5f9;
        }

        h2 { margin: 0; font-size: 1.4rem; font-weight: 800; color: var(--text); letter-spacing: -0.02em; }

        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; }

        textarea {
            width: 100%; padding: 18px; border: 1px solid var(--border);
            border-radius: 14px; resize: vertical; box-sizing: border-box;
            font-family: inherit; font-size: 1rem; transition: all 0.2s;
            background: #fbfcfe;
        }
        textarea:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .quick-select { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }

        .btn-opt {
            padding: 12px; border: 1px solid var(--border); background: white;
            border-radius: 12px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-light);
            transition: all 0.2s;
        }
        .btn-opt.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .btn-opt:hover:not(.active) { border-color: var(--primary); color: var(--primary); }
        
        .btn-main {
            width: 100%; padding: 18px; background: var(--primary);
            color: white; border: none; border-radius: 14px; font-weight: 700;
            cursor: pointer; font-size: 1rem; transition: all 0.2s;
        }
        .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }

        /* Table UI */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; text-align: left; padding: 16px 12px; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: #334155; vertical-align: middle; }
        .content-cell { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        
        .badge { background: #f1f5f9; color: #475569; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 1px solid #e2e8f0; display: inline-flex; align-items: center; gap: 4px; }
        .badge-time { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Buttons */
        .btn-test { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; padding: 7px 14px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 700; }
        .btn-edit { background: #eff6ff; color: var(--primary); border: 1px solid #dbeafe; padding: 7px 14px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 700; margin: 0 4px; }
        .btn-delete { background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; padding: 7px 14px; border-radius: 8px; cursor: pointer; font-size: 0.75rem; font-weight: 700; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="view-list" class="view active">
        <div class="nav-header">
            <h2>Giao di·ªán G·ª≠i tin</h2>
            <button class="btn-main" style="width: auto; padding: 10px 24px;" onclick="openCreateView()">+ Th√™m c·∫•u h√¨nh</button>
        </div>
        <div id="schedule-list" style="overflow-x: auto;"></div>
    </div>

    <div id="view-form" class="view">
        <div class="nav-header">
            <h2 id="form-title">T·∫°o c·∫•u h√¨nh</h2>
            <button class="btn-opt" onclick="showView('view-list')">H·ªßy b·ªè</button>
        </div>
        
        <div class="form-group">
            <label>N·ªôi dung tin nh·∫Øn</label>
            <textarea id="msgContent" rows="5" placeholder="Nh·∫≠p n·ªôi dung c·∫ßn g·ª≠i..."></textarea>
        </div>

        <div class="form-group" style="background: #f8fafc; padding: 24px; border-radius: 18px; border: 1px solid #e2e8f0;">
            <label style="color: var(--primary); font-weight: 800; margin-bottom: 15px;">Ch·∫ø ƒë·ªô g·ª≠i tin</label>
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                    <input type="radio" name="scheduleMode" value="freq" checked onchange="toggleModeUI()" style="width:18px; height:18px; margin-right:8px;"> T·∫ßn su·∫•t (L·∫∑p l·∫°i)
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                    <input type="radio" name="scheduleMode" value="fixed" onchange="toggleModeUI()" style="width:18px; height:18px; margin-right:8px;"> Th·ªùi gian c·ªë ƒë·ªãnh
                </label>
            </div>

            <div id="freqSection">
                <label>T·∫ßn su·∫•t l·∫∑p l·∫°i</label>
                <div class="quick-select">
                    <button class="btn-opt active btn-q" onclick="setFreq(1, this)">1m</button>
                    <button class="btn-opt btn-q" onclick="setFreq(5, this)">5m</button>
                    <button class="btn-opt btn-q" onclick="setFreq(10, this)">10m</button>
                    <button class="btn-opt btn-q" onclick="setFreq(30, this)">30m</button>
                    <button class="btn-opt btn-q" id="btnCustom" onclick="toggleCustom(this)">...</button>
                </div>
                <div id="customGroup" style="display:none; gap:12px; margin-top:15px;">
                    <input type="number" id="freqValue" value="1" min="1" style="padding:12px; border:1px solid var(--border); border-radius:10px; width:100px;">
                    <select id="freqUnit" style="padding:12px; border:1px solid var(--border); border-radius:10px; flex-grow: 1;">
                        <option value="minutes">Ph√∫t (m)</option>
                        <option value="hours">Gi·ªù (h)</option>
                    </select>
                </div>
            </div>

            <div id="fixedSection" style="display:none;">
                <label>Th·ªùi gian g·ª≠i c·ªë ƒë·ªãnh h√†ng ng√†y</label>
                <input type="time" id="fixedTime" style="padding:14px; border:1px solid var(--border); border-radius:12px; width:100%; font-family:inherit; font-weight: 600;">
            </div>
        </div>

        <button class="btn-main" onclick="saveSchedule()">L∆∞u c·∫•u h√¨nh</button>
    </div>
</div>

<script>
    const DB_NAME = 'MessageSchedulerApp';
    const TABLE_NAME = 'config_table';
    const DATA_KEY = 'all_configs';
    let currentFreq = 1, currentUnit = 'minutes', isCustomMode = false, editingId = null, currentMode = 'freq';

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 2);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(TABLE_NAME)) db.createObjectStore(TABLE_NAME);
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-list') loadSchedules();
    }

    function toggleModeUI() {
        currentMode = document.querySelector('input[name="scheduleMode"]:checked').value;
        document.getElementById('freqSection').style.display = currentMode === 'freq' ? 'block' : 'none';
        document.getElementById('fixedSection').style.display = currentMode === 'fixed' ? 'block' : 'none';
    }

    function openCreateView() {
        resetForm();
        document.getElementById('form-title').innerText = "Th√™m c·∫•u h√¨nh m·ªõi";
        showView('view-form');
    }

    function setFreq(val, btn) {
        isCustomMode = false; currentFreq = val; currentUnit = 'minutes';
        document.getElementById('customGroup').style.display = 'none';
        updateActiveBtn(btn);
    }

    function toggleCustom(btn) {
        isCustomMode = true;
        document.getElementById('customGroup').style.display = 'flex';
        updateActiveBtn(btn);
    }

    function updateActiveBtn(btn) {
        document.querySelectorAll('.btn-q').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function saveSchedule() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

        const freq = isCustomMode ? document.getElementById('freqValue').value : currentFreq;
        const unit = isCustomMode ? document.getElementById('freqUnit').value : currentUnit;

        const db = await initDB();
        const tx = db.transaction(TABLE_NAME, 'readwrite');
        const store = tx.objectStore(TABLE_NAME);

        store.get(DATA_KEY).onsuccess = (e) => {
            let list = e.target.result || [];
            const data = { 
                id: editingId || `config_${Date.now()}`, 
                content, 
                mode: currentMode,
                frequency: currentMode === 'freq' ? parseInt(freq) : null, 
                unit: currentMode === 'freq' ? unit : null,
                fixedTime: currentMode === 'fixed' ? document.getElementById('fixedTime').value : null,
                enabled: editingId ? list.find(i => i.id === editingId).enabled : true,
                timestamp: Date.now() 
            };

            if (editingId) {
                list = list.map(item => item.id === editingId ? data : item);
            } else {
                list.push(data);
            }
            store.put(list, DATA_KEY);
            tx.oncomplete = () => showView('view-list');
        };
    }

    async function loadSchedules() {
        const db = await initDB();
        db.transaction(TABLE_NAME, 'readonly').objectStore(TABLE_NAME).get(DATA_KEY).onsuccess = (e) => {
            const results = e.target.result || [];
            const list = document.getElementById('schedule-list');
            if (results.length === 0) { 
                list.innerHTML = `<div style="text-align:center; padding:60px; color:var(--text-light); font-weight:500;">Ch∆∞a c√≥ c·∫•u h√¨nh n√†o.</div>`; 
                return; 
            }
            
            let html = `<table><thead><tr><th>B·∫≠t/T·∫Øt</th><th>N·ªôi dung</th><th>C·∫•u h√¨nh g·ª≠i</th><th>Thao t√°c</th></tr></thead><tbody>`;
            html += results.map(item => `
                <tr style="${!item.enabled ? 'opacity: 0.6;' : ''}">
                    <td>
                        <label class="switch">
                            <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleStatus('${item.id}')">
                            <span class="slider"></span>
                        </label>
                    </td>
                    <td class="content-cell" title="${item.content}">${item.content}</td>
                    <td>
                        ${item.mode === 'fixed' 
                            ? `<span class="badge badge-time">‚è∞ ${item.fixedTime}</span>` 
                            : `<span class="badge">üîÑ ${item.frequency}${item.unit === 'minutes' ? 'm' : 'h'}</span>`}
                    </td>
                    <td style="white-space: nowrap;">
                        <button class="btn-test" onclick="testSend('${item.content.replace(/'/g, "\\'")}')">Test</button>
                        <button class="btn-edit" onclick="editSchedule('${item.id}')">S·ª≠a</button>
                        <button class="btn-delete" onclick="deleteSchedule('${item.id}')">X√≥a</button>
                    </td>
                </tr>`).join('');
            list.innerHTML = html + `</tbody></table>`;
        };
    }

    async function toggleStatus(id) {
        const db = await initDB();
        const tx = db.transaction(TABLE_NAME, 'readwrite');
        const store = tx.objectStore(TABLE_NAME);
        store.get(DATA_KEY).onsuccess = (e) => {
            let list = e.target.result || [];
            list = list.map(item => item.id === id ? {...item, enabled: !item.enabled} : item);
            store.put(list, DATA_KEY).onsuccess = loadSchedules;
        };
    }

    async function deleteSchedule(id) {
        if (!confirm('X√≥a c·∫•u h√¨nh n√†y?')) return;
        const db = await initDB();
        const tx = db.transaction(TABLE_NAME, 'readwrite');
        const store = tx.objectStore(TABLE_NAME);
        store.get(DATA_KEY).onsuccess = (e) => {
            const list = e.target.result || [];
            const newList = list.filter(item => item.id !== id);
            store.put(newList, DATA_KEY).onsuccess = loadSchedules;
        };
    }

    async function editSchedule(id) {
        const db = await initDB();
        db.transaction(TABLE_NAME, 'readonly').objectStore(TABLE_NAME).get(DATA_KEY).onsuccess = (e) => {
            const list = e.target.result || [];
            const data = list.find(item => item.id === id);
            if (!data) return;
            
            document.getElementById('msgContent').value = data.content;
            editingId = data.id;
            document.getElementById('form-title').innerText = "C·∫≠p nh·∫≠t c·∫•u h√¨nh";
            
            // Restore Mode
            currentMode = data.mode || 'freq';
            document.querySelector(`input[name="scheduleMode"][value="${currentMode}"]`).checked = true;
            toggleModeUI();

            if(currentMode === 'freq') {
                toggleCustom(document.getElementById('btnCustom'));
                document.getElementById('freqValue').value = data.frequency;
                document.getElementById('freqUnit').value = data.unit;
            } else {
                document.getElementById('fixedTime').value = data.fixedTime;
            }
            showView('view-form');
        };
    }

    function testSend(content) { alert("üöÄ G·ª¨I TH·ª¨:\n\n" + content); }

    function resetForm() {
        editingId = null;
        document.getElementById('msgContent').value = '';
        currentMode = 'freq';
        document.querySelector('input[name="scheduleMode"][value="freq"]').checked = true;
        toggleModeUI();
        setFreq(1, document.querySelector('.btn-q'));
    }

    window.onload = loadSchedules;
</script>
</body>
</html>