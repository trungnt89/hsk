<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP MOBILE PRO V8</title>
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: var(--bg); display: flex; flex-direction: column; overflow: hidden; 
            overscroll-behavior: none;
        }

        /* --- NAVIGATION --- */
        .system-header { background: #fff; border-bottom: 0.5px solid #d1d1d6; flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .top-filter { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 16px 12px; }
        .tab-pill { 
            border: 1.5px solid #D1D1D6; padding: 8px 2px; border-radius: 12px; font-size: 11px; font-weight: 800; 
            background: #fff; text-align: center; color: #3A3A3C;
        }
        .tab-pill.active { background: #1C1C1E; color: white; border-color: #1C1C1E; }

        /* --- CAROUSEL CORE (FIXED) --- */
        .carousel-viewport { 
            flex-grow: 1; overflow: hidden; position: relative; width: 100%;
            touch-action: pan-y; /* Cho ph√©p cu·ªôn d·ªçc n·ªôi dung c√¢u h·ªèi, kh√≥a cu·ªôn ngang tr√¨nh duy·ªát */
        }
        .carousel-track { 
            display: flex; height: 100%; width: 100%;
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
        }
        .slide { 
            min-width: 100%; width: 100%; height: 100%; 
            box-sizing: border-box; flex-shrink: 0;
        }
        .main-card { 
            background: var(--card); margin: 10px 15px; border-radius: 20px; 
            height: calc(100% - 20px); overflow-y: auto; position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            -webkit-overflow-scrolling: touch;
        }
        
        .question-header { 
            padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 0.5px solid #f2f2f7; position: sticky; top: 0; background: #fff; z-index: 10;
        }
        .difficulty-segment { display: flex; background: #F2F2F7; padding: 3px; border-radius: 10px; }
        .btn-diff { border: none; padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; color: #8E8E93; background: transparent; }
        .btn-diff.selected-Easy { background: var(--easy) !important; color: white !important; }
        .btn-diff.selected-Medium { background: var(--medium) !important; color: white !important; }
        .btn-diff.selected-Hard { background: var(--hard) !important; color: white !important; }

        .question-body { padding: 16px; padding-bottom: 120px; }
        .option-item { padding: 16px; background: #F2F2F7; border-radius: 16px; margin-bottom: 12px; border: 2.5px solid transparent; transition: 0.2s; }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }

        /* --- TRANSLATE PANEL --- */
        #translation-panel {
            position: fixed; top: 25%; left: 8%; width: 84%; 
            background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 20px; border-radius: 24px; display: none; z-index: 9999;
        }

        /* --- BOTTOM NAV --- */
        .bottom-nav-container {
            position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9);
            backdrop-filter: blur(15px); border-top: 0.5px solid #d1d1d6; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-nav { height: 85px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; padding: 10px; }
        .nav-item { 
            border: 1.5px solid #D1D1D6; background: #fff; border-radius: 14px; 
            font-size: 8px; font-weight: 800; color: #8E8E93;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item.active-ui { border: 2.5px solid var(--primary) !important; color: var(--primary); background: #E5F1FF; }
    </style>
</head>
<body>

<header class="system-header">
    <div class="nav-row">
        <b>PMP MASTER PRO</b>
        <select id="set-select" onchange="changeSet(this.value)" style="background:#F2F2F7; border:none; padding:6px 12px; border-radius:10px; font-weight:bold; color:var(--primary);">
            <option value="DATA_SET_1">B·ªò ƒê·ªÄ 01</option>
            <option value="DATA_SET_2">B·ªò ƒê·ªÄ 02</option>
        </select>
    </div>
    <div class="top-filter" id="top-status"></div>
</header>

<main class="carousel-viewport" id="viewport">
    <div class="carousel-track" id="carousel-track"></div>
</main>

<div id="translation-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <span style="color:var(--easy); font-weight:bold; font-size:12px;">GOOGLE TRANSLATE</span>
        <span onclick="closeTrans()" style="font-size:20px;">‚úï</span>
    </div>
    <div id="trans-content" style="line-height:1.6;">ƒêang d·ªãch...</div>
</div>

<div class="bottom-nav-container">
    <nav class="bottom-nav">
        <button class="nav-item" onclick="flip('prev')">‚óÄ<br>L√ôI</button>
        <button class="nav-item" id="btn-ans" onclick="showAns()">üí°<br>GI·∫¢I</button>
        <button class="nav-item" id="nav-Easy" onclick="filterBy('Easy')">üçÉ<br>D·ªÑ<br><span id="cnt-Easy">0</span></button>
        <button class="nav-item" id="nav-Medium" onclick="filterBy('Medium')">‚ö°<br>V·ª™A<br><span id="cnt-Medium">0</span></button>
        <button class="nav-item" id="nav-Hard" onclick="filterBy('Hard')">üî•<br>KH√ì<br><span id="cnt-Hard">0</span></button>
        <button class="nav-item" onclick="flip('next')">‚ñ∂<br>TI·∫æP</button>
    </nav>
</div>

<script>
let pmpData = []; 
let filteredQuestions = []; 
let currentIndex = 0; 
let currentTab = localStorage.getItem('V8_TAB') || 'todo';
let currentSetName = localStorage.getItem('V8_SET') || 'DATA_SET_1';

const DB_LV = "V8_LV_"; const DB_ANS = "V8_ANS_"; const DB_NOTE = "V8_NOTE_";

document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('carousel-track');
    const viewport = document.getElementById('viewport');

    // --- LOGIC VU·ªêT M∆Ø·ª¢T ---
    let startX = 0;
    let isDragging = false;
    let startTime = 0;

    viewport.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        startTime = Date.now();
        isDragging = true;
        track.style.transition = 'none';
    }, {passive: true});

    viewport.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        const offset = -currentIndex * viewport.offsetWidth;
        track.style.transform = `translateX(${offset + diff}px)`;
    }, {passive: true});

    viewport.addEventListener('touchend', e => {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = 'transform 0.35s cubic-bezier(0.16, 1, 0.3, 1)';
        
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        const duration = Date.now() - startTime;

        // N·∫øu vu·ªët nhanh (flick) ho·∫∑c vu·ªët qu√£ng ƒë∆∞·ªùng ƒë·ªß d√†i (> 20% m√†n h√¨nh)
        if (Math.abs(diff) > viewport.offsetWidth * 0.2 || (Math.abs(diff) > 30 && duration < 250)) {
            if (diff > 0) flip('next');
            else flip('prev');
        } else {
            moveTrack();
        }
    });

    // D·ªãch thu·∫≠t
    document.addEventListener('touchend', triggerTrans);

    document.getElementById('set-select').value = currentSetName;
    changeSet(currentSetName);
});

async function triggerTrans() {
    let txt = window.getSelection().toString().trim();
    if (txt.length > 3) {
        document.getElementById('translation-panel').style.display = 'block';
        document.getElementById('trans-content').innerHTML = "<i>ƒêang k·∫øt n·ªëi Google...</i>";
        try {
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURI(txt)}`);
            const data = await res.json();
            document.getElementById('trans-content').innerText = data[0].map(x => x[0]).join('');
        } catch (e) { document.getElementById('trans-content').innerText = "L·ªói d·ªãch thu·∫≠t."; }
    }
}

function closeTrans() { document.getElementById('translation-panel').style.display = 'none'; window.getSelection().removeAllRanges(); }

function changeSet(v) {
    currentSetName = v;
    localStorage.setItem('V8_SET', v);
    pmpData = window[v] || [];
    updateData(true);
}

function updateData(reRender) {
    let lvData = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    let ansData = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    
    let counts = { todo: 0, done: 0, 'not-done': 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => {
        let lv = lvData[q.id];
        if (!lv) counts.todo++; else counts[lv]++;
        ansData[q.id] ? counts.done++ : counts['not-done']++;
    });

    const lbls = { todo: "M·ªöI", done: "ƒê√É H·ªåC", 'not-done': "CH∆ØA H·ªåC" };
    document.getElementById('top-status').innerHTML = Object.keys(lbls).map(k => 
        `<div class="tab-pill ${currentTab===k?'active':''}" onclick="filterBy('${k}')">${lbls[k]} (${counts[k]})</div>`
    ).join('');

    ['Easy', 'Medium', 'Hard'].forEach(l => {
        document.getElementById('cnt-'+l).innerText = counts[l];
        document.getElementById('nav-'+l).classList.toggle('active-ui', currentTab === l);
    });

    filteredQuestions = pmpData.filter(q => {
        if (['todo','done','not-done'].includes(currentTab)) {
            if (currentTab === 'todo') return !lvData[q.id];
            if (currentTab === 'done') return !!ansData[q.id];
            return !ansData[q.id];
        }
        return lvData[q.id] === currentTab;
    });

    if (reRender) {
        currentIndex = 0; 
        renderSlides();
    }
}

function renderSlides() {
    const track = document.getElementById('carousel-track');
    let lvData = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    let ansData = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    let noteData = JSON.parse(localStorage.getItem(DB_NOTE + currentSetName)) || {};

    if (filteredQuestions.length === 0) {
        track.innerHTML = '<div class="slide"><div class="main-card" style="display:flex;align-items:center;justify-content:center;">Danh s√°ch tr·ªëng</div></div>';
        moveTrack();
        return;
    }

    track.innerHTML = filteredQuestions.map((q, idx) => {
        let lv = lvData[q.id];
        return `
        <div class="slide">
            <div class="main-card">
                <div class="question-header">
                    <b style="color:#8E8E93">${idx+1} / ${filteredQuestions.length}</b>
                    <div class="difficulty-segment">
                        <button class="btn-diff ${lv==='Easy'?'selected-Easy':''}" onclick="setLv('${q.id}','Easy',this)">D·ªÑ</button>
                        <button class="btn-diff ${lv==='Medium'?'selected-Medium':''}" onclick="setLv('${q.id}','Medium',this)">V·ª™A</button>
                        <button class="btn-diff ${lv==='Hard'?'selected-Hard':''}" onclick="setLv('${q.id}','Hard',this)">KH√ì</button>
                    </div>
                </div>
                <div class="question-body">
                    <p style="font-size:18px; line-height:1.4;"><b>${q.question}</b></p>
                    <div class="options">
                        ${Object.entries(q.options).map(([k,v]) => `
                            <div class="option-item ${ansData[q.id]===k?'selected':''}" onclick="toggleAns('${q.id}','${k}',this)">
                                <b>${k}.</b> ${v}
                            </div>`).join('')}
                    </div>
                    <div class="ex-box" style="display:none; padding:15px; background:#F2F2F7; border-radius:15px; margin-top:15px; font-size:14px; border-left:4px solid var(--easy);">
                        <b>GI·∫¢I TH√çCH:</b><br>${q.explanation}
                    </div>
                    <textarea style="width:100%; margin-top:20px; border-radius:12px; border:1.5px solid #eee; padding:12px; box-sizing:border-box; background:#FFFDF0;" oninput="saveNote('${q.id}',this.value)" placeholder="Ghi ch√∫...">${noteData[q.id]||''}</textarea>
                </div>
            </div>
        </div>`;
    }).join('');
    moveTrack();
}

function flip(dir) {
    if (dir === 'next' && currentIndex < filteredQuestions.length - 1) {
        currentIndex++;
    } else if (dir === 'prev' && currentIndex > 0) {
        currentIndex--;
    }
    moveTrack();
}

function moveTrack() {
    const track = document.getElementById('carousel-track');
    track.style.transform = `translateX(-${currentIndex * 100}%)`;
}

function filterBy(t) {
    currentTab = t;
    localStorage.setItem('V8_TAB', t);
    updateData(true);
}

function setLv(id, lv, btn) {
    let data = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    data[id] = (data[id] === lv) ? null : lv;
    localStorage.setItem(DB_LV + currentSetName, JSON.stringify(data));
    const parent = btn.parentElement;
    parent.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('selected-Easy', 'selected-Medium', 'selected-Hard'));
    if (data[id]) btn.classList.add('selected-' + lv);
    updateData(false);
}

function toggleAns(qId, key, el) {
    let data = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    if (data[qId] === key) delete data[qId]; else data[qId] = key;
    localStorage.setItem(DB_ANS + currentSetName, JSON.stringify(data));
    el.parentElement.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
    if (data[qId]) el.classList.add('selected');
    updateData(false);
}

function showAns() {
    const slides = document.querySelectorAll('.slide');
    const currentSlide = slides[currentIndex];
    if (currentSlide) {
        const box = currentSlide.querySelector('.ex-box');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }
}

function saveNote(id, val) {
    let data = JSON.parse(localStorage.getItem(DB_NOTE + currentSetName)) || {};
    data[id] = val;
    localStorage.setItem(DB_NOTE + currentSetName, JSON.stringify(data));
}
</script>
</body>
</html>