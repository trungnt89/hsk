<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS IndexedDB Cache System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 550px; margin: auto; background: #f0f2f5; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #log { background: #1a1a1a; color: #00ff00; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 8px; margin-top: 15px; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .status-local { color: #ffeb3b; } /* IndexedDB */
        .status-drive { color: #03a9f4; } /* Drive */
        .status-azure { color: #e91e63; } /* Azure */
    </style>
</head>
<body>

<div class="card">
    <h3>üéôÔ∏è TTS Smart Cache (IndexedDB)</h3>
    <input type="text" id="inputText" style="width:100%; padding:10px; margin-bottom:10px;" value="Th·ª≠ nghi·ªám l∆∞u tr·ªØ t·∫ßng t·∫ßng l·ªõp l·ªõp.">
    <input type="text" id="filename" style="width:100%; padding:10px; margin-bottom:20px;" value="cache_test_01">
    <button id="btn" onclick="startProcess()">PH√ÅT √ÇM THANH</button>
    <div id="log"></div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxUcnkzBAkguAxlZx3Z3R6dcaYapY46FeXAjxqfrweqPFiBsiUvShZp-BnfPyEpzf0/exec";
    const DB_NAME = "TTS_Cache";
    const STORE_NAME = "audios";

    function addLog(msg, type = '') {
        const log = document.getElementById('log');
        log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // --- KH·ªûI T·∫†O INDEXEDDB ---
    function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
            request.onsuccess = (e) => resolve(e.target.result);
        });
    }

    async function getLocal(key) {
        const db = await initDB();
        return new Promise((resolve) => {
            const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).get(key);
            req.onsuccess = () => resolve(req.result);
        });
    }

    async function saveLocal(key, blob) {
        const db = await initDB();
        db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).put(blob, key);
    }

    // --- LOGIC PH√ÅT √ÇM THANH ---
    async function playAudio(blob) {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        return audio.play();
    }

    async function startProcess() {
        const text = document.getElementById('inputText').value;
        const filename = document.getElementById('filename').value;
        const btn = document.getElementById('btn');
        btn.disabled = true;

        try {
            // B∆Ø·ªöC 1: T√åM TRONG INDEXEDDB (∆Øu ti√™n cao nh·∫•t)
            addLog("Ki·ªÉm tra b·ªô nh·ªõ c·ª•c b·ªô (IndexedDB)...");
            const localBlob = await getLocal(filename);
            
            if (localBlob) {
                addLog("T√åM TH·∫§Y TRONG INDEXEDDB! Ph√°t ngay...", "status-local");
                await playAudio(localBlob);
            } else {
                // B∆Ø·ªöC 2: T√åM TR√äN DRIVE QUA VERCEL/GAS
                addLog("IndexedDB tr·ªëng. Ki·ªÉm tra Google Drive...");
                const vercelRes = await fetch(`/api/tts?text=${encodeURIComponent(text)}&filename=${filename}`);
                const data = await vercelRes.json();

                if (data.source === 'driver') {
                    addLog("T√åM TH·∫§Y TR√äN DRIVE! ƒêang t·∫£i v·ªÅ cache...", "status-drive");
                    const res = await fetch(data.proxyUrl);
                    const b64 = await res.text();
                    const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                    const blob = new Blob([bytes], { type: 'audio/mpeg' });
                    
                    await saveLocal(filename, blob); // L∆∞u v√†o IndexedDB
                    await playAudio(blob);
                } else {
                    // B∆Ø·ªöC 3: L·∫§Y T·ª™ AZURE
                    addLog("Drive tr·ªëng. ƒêang y√™u c·∫ßu Azure t·∫°o m·ªõi...", "status-azure");
                    const binary = atob(data.audioData);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    const blob = new Blob([bytes], { type: 'audio/mpeg' });

                    await playAudio(blob);
                    await saveLocal(filename, blob); // L∆∞u v√†o IndexedDB
                    
                    addLog("ƒêang ƒë·ªìng b·ªô l√™n Drive ng·∫ßm...");
                    fetch(`${GAS_URL}?fileKey=${encodeURIComponent(data.fileKey)}`, {
                        method: 'POST',
                        body: JSON.stringify(Array.from(bytes)),
                        mode: 'no-cors'
                    }).then(() => addLog("ƒê√£ l∆∞u v√†o Drive.", "status-drive"));
                }
            }
        } catch (e) {
            addLog("L·ªñI: " + e.message, "status-azure");
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>