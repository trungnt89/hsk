<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSK Master - Full Buttons & Center Play</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #2563eb; 
            --accent: #fbbf24; 
            --danger: #ef4444; 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --success: #10b981; 
            --text-main: #1e293b; 
            --text-sub: #64748b; 
            --highlight: #f59e0b; 
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg); 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* Top Section */
        .top-section { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding-bottom: 12px; flex-shrink: 0; z-index: 10; }
        header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        header h3 { margin: 0; color: var(--primary); font-size: 1.1rem; }
        #page-label { font-weight: 800; color: var(--primary); font-size: 10px; background: #eff6ff; padding: 4px 10px; border-radius: 8px; }

        .settings-panel { padding: 0 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .setting-item label { font-size: 7px; font-weight: 800; color: #94a3b8; display: block; margin-bottom: 4px; text-transform: uppercase; }
        select { width: 100%; border: 1.5px solid #f1f5f9; padding: 10px 5px; border-radius: 12px; font-weight: 700; font-size: 11px; outline: none; background: #fff; }

        /* List Area */
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        .word-card { 
            background: var(--card); border-radius: 16px; padding: 16px 12px; margin-bottom: 12px; 
            display: flex; align-items: center; border: 2px solid transparent; 
            transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
        }
        .word-card.active { border-color: var(--primary); background: #fff; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.1); transform: scale(1.02); }

        .index-col { width: 35px; flex-shrink: 0; color: #cbd5e1; font-size: 11px; font-weight: 800; }
        .word-card.active .index-col { color: var(--primary); }

        .content-col { flex-grow: 1; display: grid; grid-template-columns: 1.2fr 1fr; gap: 15px; align-items: center; }
        .hz-column { font-family: 'Noto Sans SC'; font-size: 1.3rem; color: var(--text-main); font-weight: 700; line-height: 1.4; }
        
        /* Highlight t·ª´ v·ª±ng trong c√¢u */
        .highlight { color: var(--highlight); font-weight: 800; border-bottom: 2px solid var(--highlight); }

        .info-column { border-left: 2px solid #f1f5f9; padding-left: 15px; }
        .pinyin { color: var(--primary); font-weight: 700; font-size: 0.9rem; }
        .meaning { color: var(--text-sub); font-size: 0.8rem; margin-top: 4px; font-family: sans-serif; line-height: 1.3; }

        /* Navigation Bar - Gi·ªØ ƒë·ªß 5 n√∫t g·ªëc */
        .controls-bar { 
            height: 110px; background: #fff; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.08); 
            border-radius: 30px 30px 0 0; 
            padding: 0 5px; flex-shrink: 0; z-index: 10; 
        }
        .ctrl-group { flex: 1; display: flex; justify-content: space-evenly; align-items: center; }
        
        .btn-nav { 
            background: transparent; border: none; color: #94a3b8; 
            width: 50px; height: 55px; border-radius: 15px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .btn-nav i { font-style: normal; font-size: 18px; margin-bottom: 2px; }
        .btn-nav small { font-size: 7px; font-weight: 800; text-transform: uppercase; }
        .btn-nav.active-blue { color: var(--primary); background: #eff6ff; }
        .btn-nav.active-green { color: var(--success); background: #ecfdf5; }
        
        /* N√∫t Play ch√≠nh gi·ªØa */
        .play-center-wrap { width: 85px; position: relative; display: flex; justify-content: center; }
        .btn-play { 
            position: absolute; top: -45px;
            width: 80px; height: 80px; 
            background: var(--accent); border: 7px solid var(--bg); border-radius: 50%; 
            font-size: 30px; box-shadow: 0 10px 20px rgba(251, 191, 36, 0.4); 
            display: flex; align-items: center; justify-content: center; outline: none;
        }
    </style>
</head>
<body>

<div class="top-section">
    <header><h3>HSK MASTER</h3><div id="page-label">PAGE 01/01</div></header>
    <div class="settings-panel">
        <div class="setting-item"><label>Gi·ªçng ƒë·ªçc</label>
            <select id="voice-select">
                <option value="zh-CN-XiaoxiaoNeural">Azure N·ªØ</option>
                <option value="zh-CN-YunxiNeural">Azure Nam</option>
                <option value="google">Google TTS</option>
                <option value="browser">M√°y (Local)</option>
            </select>
        </div>
        <div class="setting-item"><label>S·ªë l∆∞·ª£ng</label>
            <select id="limit-select"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select>
        </div>
        <div class="setting-item"><label>Ngh·ªâ (s)</label>
            <select id="delay-select"><option value="500">0.5s</option><option value="1000" selected>1s</option><option value="2000">2s</option></select>
        </div>
    </div>
</div>

<div class="scroll-area" id="word-list"></div>

<div class="controls-bar">
    <div class="ctrl-group">
        <button class="btn-nav" id="type-btn"><i>üìñ</i><small id="type-txt">T·ª´</small></button>
        <button class="btn-nav" id="shuffle-btn"><i>üîÅ</i><small>X√°o</small></button>
        <button class="btn-nav" id="prev-btn"><i>‚èÆ</i><small>Tr∆∞·ªõc</small></button>
    </div>
    
    <div class="play-center-wrap">
        <button class="btn-play" id="play-btn">‚ñ∂</button>
    </div>
    
    <div class="ctrl-group">
        <button class="btn-nav" id="next-btn"><i>‚è≠</i><small>Sau</small></button>
        <button class="btn-nav" id="clear-db-btn" style="color:var(--danger)"><i>üóëÔ∏è</i><small>X√≥a</small></button>
    </div>
</div>

<script src="demo-data.js"></script>

<script>
let page = 1, isShuffle = false, isSentence = false, isPlaying = false;
let currentIndex = -1, currentList = [], nextTimer = null;
const SAVE_KEY = "HSK_PRO_V4";
const globalAudio = new Audio();

// H√†m n·ªïi b·∫≠t t·ª´ v·ª±ng
function highlightKeyword(sentence, keyword) {
    if (!sentence || !keyword) return sentence;
    const regex = new RegExp(keyword, "g");
    return sentence.replace(regex, `<span class="highlight">${keyword}</span>`);
}

// Mobile Audio Engine
async function speak(text) {
    const voice = document.getElementById("voice-select").value;
    if (voice === "browser") {
        return new Promise(res => {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = "zh-CN"; u.onend = res;
            window.speechSynthesis.speak(u);
        });
    }
    const url = voice === "google" 
        ? `https://translate.google.com/translate_tts?ie=UTF-8&client=gtx&tl=zh-CN&q=${encodeURIComponent(text)}`
        : `/api/tts?text=${encodeURIComponent(text)}&voice=${voice}`;
    
    return new Promise(res => {
        globalAudio.src = url;
        globalAudio.onended = res;
        globalAudio.onerror = res;
        globalAudio.play().catch(() => res());
    });
}

// Render d·ªØ li·ªáu
function render(keep = false) {
    const limit = parseInt(document.getElementById('limit-select').value);
    const listEl = document.getElementById('word-list');
    let rawItems = hskData.slice((page - 1) * limit, page * limit).map((it, idx) => ({...it, stt: (page - 1) * limit + idx + 1}));
    
    currentList = isShuffle ? [...rawItems].sort(() => Math.random() - 0.5) : rawItems;
    listEl.innerHTML = '';

    currentList.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'word-card'; card.id = `card-${i}`;
        card.onclick = () => { currentIndex = i; updateUI(); speak(isSentence ? item.exHz : item.hz); if(isPlaying) stopLoop(); };
        
        const hzDisplay = isSentence ? highlightKeyword(item.exHz, item.hz) : item.hz;
        const pyDisplay = isSentence ? item.exPy : item.py;
        const viDisplay = isSentence ? item.exVi : item.vi;

        card.innerHTML = `
            <div class="index-col">${String(item.stt).padStart(2, '0')}</div>
            <div class="content-col">
                <div class="hz-column">${hzDisplay}</div>
                <div class="info-column">
                    <div class="pinyin">${pyDisplay}</div>
                    <div class="meaning">${viDisplay}</div>
                </div>
            </div>`;
        listEl.appendChild(card);
    });
    document.getElementById('page-label').innerText = `PAGE ${page}/${Math.ceil(hskData.length/limit)}`;
    if(!keep) currentIndex = -1;
    saveState();
}

function updateUI() {
    document.querySelectorAll('.word-card').forEach(c => c.classList.remove('active'));
    const card = document.getElementById(`card-${currentIndex}`);
    if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
}

// Loop Play
async function startLoop() {
    if (!isPlaying) return;
    currentIndex = (currentIndex >= currentList.length - 1) ? 0 : currentIndex + 1;
    if (currentIndex === 0 && isShuffle) render(true);
    
    updateUI();
    const item = currentList[currentIndex];
    if (item) await speak(isSentence ? item.exHz : item.hz);

    if (isPlaying) {
        nextTimer = setTimeout(startLoop, parseInt(document.getElementById('delay-select').value));
    }
}

function stopLoop() { isPlaying = false; document.getElementById('play-btn').innerText = '‚ñ∂'; clearTimeout(nextTimer); window.speechSynthesis.cancel(); }

// Controls
document.getElementById('play-btn').onclick = function() {
    if(!isPlaying) { isPlaying = true; this.innerText = '‚èπ'; globalAudio.play().catch(()=>{}); startLoop(); } 
    else stopLoop();
};

document.getElementById('next-btn').onclick = () => { 
    const max = Math.ceil(hskData.length / parseInt(document.getElementById('limit-select').value));
    if(page < max) { page++; render(); if(isPlaying) {currentIndex=-1; startLoop();}} 
};
document.getElementById('prev-btn').onclick = () => { if(page > 1) { page--; render(); if(isPlaying) {currentIndex=-1; startLoop();}} };
document.getElementById('shuffle-btn').onclick = function() { isShuffle = !isShuffle; this.classList.toggle('active-blue', isShuffle); render(true); };
document.getElementById('type-btn').onclick = function() { 
    isSentence = !isSentence; this.classList.toggle('active-green', isSentence); 
    document.getElementById('type-txt').innerText = isSentence ? 'V√≠ d·ª•' : 'T·ª´'; render(true); 
};
document.getElementById('clear-db-btn').onclick = async () => {
    if(confirm("X√≥a b·ªô nh·ªõ ƒë·ªám √¢m thanh?")) { (await openDB()).transaction("audioStore", "readwrite").objectStore("audioStore").clear(); }
};

function saveState() {
    const s = { page, isShuffle, isSentence, v: document.getElementById('voice-select').value, l: document.getElementById('limit-select').value, d: document.getElementById('delay-select').value };
    localStorage.setItem(SAVE_KEY, JSON.stringify(s));
}

function loadState() {
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) {
        const s = JSON.parse(saved);
        page = s.page; isShuffle = s.isShuffle; isSentence = s.isSentence;
        document.getElementById('voice-select').value = s.v;
        document.getElementById('limit-select').value = s.l;
        document.getElementById('delay-select').value = s.d;
        if(isShuffle) document.getElementById('shuffle-btn').classList.add('active-blue');
        if(isSentence) { document.getElementById('type-btn').classList.add('active-green'); document.getElementById('type-txt').innerText = 'V√≠ d·ª•'; }
    }
}

async function openDB() { return new Promise(res => { const req = indexedDB.open("HSK_Azure_Cache", 1); req.onsuccess = e => res(e.target.result); }); }

loadState();
render();
</script>
</body>
</html>