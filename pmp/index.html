<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master - Carousel Slide</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #E5E5EA; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.9);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: none;
        }

        .top-section { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .main-nav { padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .brand { font-size: 18px; font-weight: 900; color: var(--text-main); }
        .brand span { color: var(--primary); }
        
        .set-capsule-select {
            border: none; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; 
            background: rgba(0,0,0,0.08); color: var(--primary); outline: none; -webkit-appearance: none;
        }

        .filter-bar { padding: 4px 16px 12px; display: flex; gap: 6px; }
        .tab-btn {
            flex: 1; border: none; padding: 8px 0; border-radius: 10px; font-size: 10px; font-weight: 700; 
            background: #C7C7CC; color: #3A3A3C; transition: 0.3s;
        }
        .tab-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .tab-btn[data-type="Easy"].active { background: var(--easy); color: white; }
        .tab-btn[data-type="Medium"].active { background: var(--medium); color: white; }
        .tab-btn[data-type="Hard"].active { background: var(--hard); color: white; }

        /* --- VIEWPORT CAROUSEL --- */
        .viewport { 
            flex-grow: 1; 
            position: relative; 
            margin: 16px; 
            overflow: hidden; /* Cắt phần thẻ thừa bên ngoài */
            border-radius: 20px;
        }

        #book-page {
            width: 100%; height: 100%; position: relative;
            /* Hiệu ứng trượt mượt mà */
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
            will-change: transform, opacity;
        }

        /* Khi bấm Next: Câu cũ biến mất sang trái */
        .slide-out-left { transform: translateX(-100%); opacity: 0; }
        /* Khi bấm Prev: Câu cũ biến mất sang phải */
        .slide-out-right { transform: translateX(100%); opacity: 0; }

        .main-display { 
            position: absolute; width: 100%; height: 100%;
            background: var(--card); border-radius: 20px;
            padding: 24px; box-sizing: border-box; overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* --- UI COMPONENTS --- */
        .chip-group { display: flex; gap: 5px; }
        .chip { border: none; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; background: #E5E5EA; color: #8E8E93;}
        .chip.active-easy { background: var(--easy) !important; color: white; }
        .chip.active-medium { background: var(--medium) !important; color: white; }
        .chip.active-hard { background: var(--hard) !important; color: white; }

        .q-text { font-size: 17px; font-weight: 700; line-height: 1.5; color: var(--text-main); margin: 15px 0; }
        .option-item { font-size: 15px; padding: 15px; background: #F2F2F7; border-radius: 14px; margin-bottom: 8px; border: 2px solid transparent; transition: 0.2s;}
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }
        .option-item.is-wrong { background: #FFF2F2 !important; border-color: var(--hard) !important; color: #B71C1C !important; }

        .iphone-bar { 
            height: 65px; background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; }
        .tab-item i { font-style: normal; font-size: 24px; font-weight: bold; }
        .tab-item.active-nav { color: var(--primary); }
    </style>
</head>
<body>

<div class="top-section">
    <div class="main-nav">
        <div class="brand">PMP<span>MASTER</span></div>
        <select class="set-capsule-select" id="set-select" onchange="changeExamSet(this.value)">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-bar">
        <button class="tab-btn active" data-type="todo" onclick="switchTab('todo')">MỚI</button>
        <button class="tab-btn" data-type="Easy" onclick="switchTab('Easy')">DỄ</button>
        <button class="tab-btn" data-type="Medium" onclick="switchTab('Medium')">VỪA</button>
        <button class="tab-btn" data-type="Hard" onclick="switchTab('Hard')">KHÓ</button>
    </div>
</div>

<div class="viewport">
    <div id="book-page">
        <div class="main-display" id="display-area"></div>
    </div>
</div>

<div class="iphone-bar">
    <button class="tab-item" id="prev-btn" onclick="triggerFlip('prev')"><i>‹</i><small>Trước</small></button>
    <button class="tab-item" id="info-btn" onclick="toggleInfo()">
        <i id="eye-icon">◎</i><small id="info-txt">Đáp án</small>
    </button>
    <button class="tab-item" id="next-btn" onclick="triggerFlip('next')"><i>›</i><small>Tiếp</small></button>
</div>

<script>
let pmpData = []; let filteredQuestions = []; let currentIndexInSet = 0; let currentTab = 'todo';
let selectedOption = null; let isConfirmed = false; let currentSetName = ""; 
const STORAGE_PREFIX = "PMP_V16_";

// --- HIỆU ỨNG TRƯỢT CAROUSEL ---
function triggerFlip(direction) {
    const page = document.getElementById('book-page');
    if (page.classList.contains('slide-out-left') || page.classList.contains('slide-out-right')) return;

    if (direction === 'next' && currentIndexInSet < filteredQuestions.length - 1) {
        // 1. Thẻ cũ trượt sang trái
        page.classList.add('slide-out-left');
        
        setTimeout(() => {
            nextQuestion();
            // 2. Đưa thẻ mới ra chuẩn bị bên phải (không hiệu ứng)
            page.style.transition = 'none';
            page.style.transform = 'translateX(100%)';
            
            setTimeout(() => {
                // 3. Trượt thẻ mới từ phải vào giữa
                page.style.transition = 'transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s';
                page.classList.remove('slide-out-left');
                page.style.transform = 'translateX(0)';
            }, 50);
        }, 400);
    } else if (direction === 'prev' && currentIndexInSet > 0) {
        // 1. Thẻ cũ trượt sang phải
        page.classList.add('slide-out-right');
        
        setTimeout(() => {
            prevQuestion();
            // 2. Đưa thẻ mới ra chuẩn bị bên trái (không hiệu ứng)
            page.style.transition = 'none';
            page.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                // 3. Trượt thẻ mới từ trái vào giữa
                page.style.transition = 'transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s';
                page.classList.remove('slide-out-right');
                page.style.transform = 'translateX(0)';
            }, 50);
        }, 400);
    }
}

// Cảm ứng vuốt
let touchstartX = 0;
document.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
document.addEventListener('touchend', e => {
    let diffX = e.changedTouches[0].screenX - touchstartX;
    if (Math.abs(diffX) > 60) { if (diffX < 0) triggerFlip('next'); else triggerFlip('prev'); }
}, {passive: true});

// --- LOGIC DỮ LIỆU (Giữ nguyên) ---
function changeExamSet(v) {
    let data = window[v] || (typeof eval !== 'undefined' ? eval(v) : null);
    if (data) { pmpData = data; currentSetName = v; currentIndexInSet = 0; updateFilteredData(); }
}

function updateFilteredData() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
        btn.classList.toggle('active', type === currentTab);
    });
    filteredQuestions = pmpData.filter(q => { const lv = stored[q.id]; return currentTab === 'todo' ? !lv : lv === currentTab; });
    renderQuestion();
}

function renderQuestion() {
    const area = document.getElementById('display-area');
    const q = filteredQuestions[currentIndexInSet];
    document.getElementById('prev-btn').style.opacity = (currentIndexInSet === 0) ? "0.1" : "1";
    document.getElementById('next-btn').style.opacity = (currentIndexInSet >= filteredQuestions.length - 1) ? "0.1" : "1";
    resetInfoBtn();
    if (!q) { area.innerHTML = `<div style="text-align:center; padding-top:100px; color:var(--text-sub);">HẾT CÂU HỎI</div>`; return; }
    selectedOption = null; isConfirmed = false;
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const lv = stored[q.id];
    let opts = '';
    for (const [key, val] of Object.entries(q.options)) {
        opts += `<div class="option-item" id="opt-${key}" onclick="selectOption('${key}')"><b>${key}.</b> ${val}</div>`;
    }
    area.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:12px; font-weight:800; color:var(--text-sub);">ID: #${q.id}</div>
            <div class="chip-group">
                <button class="chip ${lv==='Easy'?'active-easy':''}" onclick="updateLevel(this,'${q.id}','Easy')">DỄ</button>
                <button class="chip ${lv==='Medium'?'active-medium':''}" onclick="updateLevel(this,'${q.id}','Medium')">VỪA</button>
                <button class="chip ${lv==='Hard'?'active-hard':''}" onclick="updateLevel(this,'${q.id}','Hard')">KHÓ</button>
            </div>
        </div>
        <div style="font-size:11px; color:var(--primary); font-weight:700;">CÂU ${currentIndexInSet + 1} / ${filteredQuestions.length}</div>
        <div class="q-text">${q.question}</div>
        <div class="options-list">${opts}</div>
        <div id="explanation-area"></div>
    `;
    area.scrollTo(0,0);
}

function selectOption(k) { 
    if(isConfirmed) return; 
    selectedOption = k; 
    document.querySelectorAll('.option-item').forEach(e => e.classList.remove('selected')); 
    document.getElementById(`opt-${k}`).classList.add('selected'); 
}

function showAnswerUI() {
    const q = filteredQuestions[currentIndexInSet];
    if(!q) return;
    isConfirmed = true; 
    document.getElementById('info-btn').classList.add('active-nav');
    document.getElementById('eye-icon').innerText = "◉";
    document.getElementById('info-txt').innerText = "Đã xem";
    document.querySelectorAll('.option-item').forEach(e => e.classList.remove('selected'));
    if (selectedOption === q.answer) {
        document.getElementById(`opt-${selectedOption}`).classList.add('is-correct');
    } else {
        if(selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('is-wrong');
        document.getElementById(`opt-${q.answer}`).classList.add('is-correct');
    }
    document.getElementById('explanation-area').innerHTML = `<div style="margin-top:15px; padding:15px; background:#F2F2F7; border-radius:15px; font-size:14px; border-left:4px solid var(--primary);"><b>Giải thích:</b><br>${q.explanation}</div>`;
}

function toggleInfo() {
    if(!isConfirmed) showAnswerUI();
    else {
        isConfirmed = false; resetInfoBtn();
        document.getElementById('explanation-area').innerHTML = '';
        document.querySelectorAll('.option-item').forEach(e => e.classList.remove('is-correct', 'is-wrong'));
        if(selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('selected');
    }
}

function updateLevel(btn, id, lv) {
    const key = STORAGE_PREFIX + currentSetName;
    const stored = JSON.parse(localStorage.getItem(key) || "{}");
    if (stored[id] === lv) delete stored[id]; else stored[id] = lv;
    localStorage.setItem(key, JSON.stringify(stored));
    const parent = btn.parentElement;
    parent.querySelectorAll('.chip').forEach(c => c.classList.remove('active-easy','active-medium','active-hard'));
    if (stored[id]) btn.classList.add('active-' + lv.toLowerCase());
    updateTabCountsOnly();
}

function updateTabCountsOnly() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
    });
}

function resetInfoBtn() { 
    document.getElementById('info-btn').classList.remove('active-nav'); 
    document.getElementById('eye-icon').innerText = "◎";
    document.getElementById('info-txt').innerText = "Đáp án";
}

function switchTab(t) { currentTab = t; currentIndexInSet = 0; updateFilteredData(); }
function nextQuestion() { if(currentIndexInSet < filteredQuestions.length-1) { currentIndexInSet++; renderQuestion(); } }
function prevQuestion() { if(currentIndexInSet > 0) { currentIndexInSet--; renderQuestion(); } }

window.addEventListener('DOMContentLoaded', () => { changeExamSet(document.getElementById('set-select').value); });
</script>
</body>
</html>