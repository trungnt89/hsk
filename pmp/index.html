<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master Pro</title>
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E;
        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100vw; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
        .system-header { background: #fff; border-bottom: 0.5px solid #ccc; flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 12px 12px; }
        .tab-pill { border: none; padding: 10px 2px; border-radius: 10px; font-size: 11px; font-weight: 700; background: #E5E5EA; color: #3A3A3C; }
        .tab-pill.active { background: var(--text-main); color: white; }
        .carousel-viewport { flex-grow: 1; overflow: hidden; position: relative; }
        .carousel-track { display: flex; height: 100%; transition: transform 0.4s ease-out; }
        .slide { min-width: 100%; height: 100%; box-sizing: border-box; }
        .main-card { background: var(--card); margin: 12px; border-radius: 20px; height: calc(100% - 24px); overflow-y: auto; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .question-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid #eee; position: sticky; top: 0; background: #fff; z-index: 10; }
        .difficulty-segment { display: flex; background: #F2F2F7; padding: 2px; border-radius: 10px; }
        .btn-diff { border: none; padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; color: #8E8E93; background: transparent; }
        .btn-diff.active-Easy { background: var(--easy); color: white; }
        .btn-diff.active-Medium { background: var(--medium); color: white; }
        .btn-diff.active-Hard { background: var(--hard); color: white; }
        .question-body { padding: 20px; }
        .option-item { font-size: 15px; padding: 16px; background: #F2F2F7; border-radius: 14px; margin-bottom: 12px; border: 2.5px solid transparent; }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; }
        .note-area { width: 100%; min-height: 80px; margin-top: 20px; padding: 12px; background: #F9F9FB; border: 1px dashed #DDD; border-radius: 12px; font-size: 14px; box-sizing: border-box; }
        #trans-panel { position: fixed; bottom: 65px; left: 0; right: 0; background: #1C1C1E; color: white; padding: 16px; z-index: 2000; display: none; border-radius: 18px 18px 0 0; }
        .bottom-nav { height: 65px; background: white; border-top: 0.5px solid #ccc; display: flex; align-items: center; position: fixed; bottom: 0; width: 100%; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; border: none; background: transparent; font-size: 10px; color: #8E8E93; font-weight: bold; }
    </style>
</head>
<body>

<div id="trans-panel">
    <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:8px;">
        <b style="color:var(--easy)">DỊCH</b>
        <span onclick="this.parentElement.parentElement.style.display='none'">ĐÓNG [X]</span>
    </div>
    <div id="trans-content"></div>
</div>

<header class="system-header">
    <div class="nav-row">
        <b style="font-size:18px;">PMP<span style="color:var(--primary)">MASTER</span></b>
        <select id="set-select" onchange="changeExamSet(this.value)" style="border:none; font-weight:bold; color:var(--primary); background:transparent;">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-grid" id="tab-bar"></div>
</header>

<main class="carousel-viewport" id="swipe-area">
    <div class="carousel-track" id="carousel-track"></div>
</main>

<nav class="bottom-nav">
    <button class="nav-item" onclick="triggerFlip('prev')">‹ TRƯỚC</button>
    <button class="nav-item" onclick="toggleInfo()">ĐÁP ÁN</button>
    <button class="nav-item" onclick="triggerFlip('next')">TIẾP ›</button>
</nav>

<script>
let pmpData = []; 
let filteredQuestions = []; 
let currentIndex = 0; 
let currentTab = localStorage.getItem('PMP_LAST_TAB') || 'todo';
let currentSetName = localStorage.getItem('PMP_LAST_SET') || 'DATA_SET_1';

const STORAGE_LV = "PMP_LV_"; 
const STORAGE_USER = "PMP_USER_DATA_";

document.addEventListener('DOMContentLoaded', () => {
    // Vuốt chuyển trang
    let tStartX = 0;
    document.getElementById('swipe-area').addEventListener('touchstart', e => tStartX = e.changedTouches[0].screenX);
    document.getElementById('swipe-area').addEventListener('touchend', e => {
        let dx = e.changedTouches[0].screenX - tStartX;
        if (Math.abs(dx) > 80 && !window.getSelection().toString()) {
            if (dx < 0) triggerFlip('next');
            if (dx > 0) triggerFlip('prev');
        }
    });

    // Dịch bôi đen
    document.addEventListener('selectionchange', () => {
        let text = window.getSelection().toString().trim();
        if (text.length > 1) {
            document.getElementById('trans-panel').style.display = 'block';
            fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`)
                .then(r => r.json()).then(d => {
                    document.getElementById('trans-content').innerText = d[0].map(i => i[0]).join("");
                });
        }
    });

    document.getElementById('set-select').value = currentSetName;
    changeExamSet(currentSetName);
});

function changeExamSet(v) {
    currentSetName = v;
    localStorage.setItem('PMP_LAST_SET', v);
    
    // LỖI HAY GẶP Ở ĐÂY: Kiểm tra biến dữ liệu
    pmpData = window[v] || []; 
    console.log("Data loaded for", v, ":", pmpData.length, "items");
    
    currentIndex = 0;
    updateFilteredData(true);
}

function updateFilteredData(reRender) {
    let lvData = JSON.parse(localStorage.getItem(STORAGE_LV + currentSetName)) || {};
    let userData = JSON.parse(localStorage.getItem(STORAGE_USER + currentSetName)) || {};
    
    let counts = { todo: 0, done: 0, 'not-done': 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => {
        let lv = lvData[q.id];
        if (!lv) counts.todo++; else counts[lv]++;
        if (userData[q.id]?.ans) counts.done++; else counts['not-done']++;
    });

    let labels = { todo: "MỚI", done: "ĐÃ LÀM", 'not-done': "CHƯA", Easy: "DỄ", Medium: "VỪA", Hard: "KHÓ" };
    document.getElementById('tab-bar').innerHTML = Object.keys(labels).map(k => `
        <button class="tab-pill ${currentTab===k?'active':''}" onclick="switchTab('${k}')">${labels[k]} (${counts[k]})</button>
    `).join('');

    filteredQuestions = pmpData.filter(q => {
        if (currentTab === 'todo') return !lvData[q.id];
        if (currentTab === 'done') return !!userData[q.id]?.ans;
        if (currentTab === 'not-done') return !userData[q.id]?.ans;
        return lvData[q.id] === currentTab;
    });

    if (reRender) renderCarousel();
}

function renderCarousel() {
    let track = document.getElementById('carousel-track');
    let lvData = JSON.parse(localStorage.getItem(STORAGE_LV + currentSetName)) || {};
    let userData = JSON.parse(localStorage.getItem(STORAGE_USER + currentSetName)) || {};

    if (filteredQuestions.length === 0) {
        track.innerHTML = '<div class="slide"><div class="main-card" style="padding:40px; text-align:center;">Trống (Hãy chọn tab khác hoặc bộ đề khác)</div></div>';
        return;
    }

    track.innerHTML = filteredQuestions.map((q, idx) => {
        let lv = lvData[q.id];
        let user = userData[q.id] || {ans:null, note:""};
        return `
        <div class="slide">
            <div class="main-card">
                <div class="question-header">
                    <b>CÂU ${idx+1}/${filteredQuestions.length}</b>
                    <div class="difficulty-segment">
                        <button class="btn-diff ${lv==='Easy'?'active-Easy':''}" onclick="setLv('${q.id}','Easy',this)">DỄ</button>
                        <button class="btn-diff ${lv==='Medium'?'active-Medium':''}" onclick="setLv('${q.id}','Medium',this)">VỪA</button>
                        <button class="btn-diff ${lv==='Hard'?'active-Hard':''}" onclick="setLv('${q.id}','Hard',this)">KHÓ</button>
                    </div>
                </div>
                <div class="question-body">
                    <p><b>${q.question}</b></p>
                    ${Object.entries(q.options).map(([k,v]) => `
                        <div class="option-item ${user.ans===k?'selected':''}" onclick="selectOption('${q.id}','${k}',this)">
                            <b>${k}.</b> ${v}
                        </div>`).join('')}
                    <div class="ex-box" style="display:none; padding:15px; background:#F2F2F7; border-radius:12px; margin-top:10px;">
                        <b>Giải thích:</b><br>${q.explanation}
                    </div>
                    <textarea class="note-area" placeholder="Ghi chú câu hỏi này..." oninput="saveNote('${q.id}',this.value)">${user.note||''}</textarea>
                    <div style="height:60px;"></div>
                </div>
            </div>
        </div>`;
    }).join('');
    updateCarousel();
}

function selectOption(qId, key, el) {
    let data = JSON.parse(localStorage.getItem(STORAGE_USER + currentSetName)) || {};
    if (!data[qId]) data[qId] = {ans:null, note:""};
    
    if (data[qId].ans === key) {
        data[qId].ans = null;
        el.classList.remove('selected');
    } else {
        el.parentElement.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
        data[qId].ans = key;
        el.classList.add('selected');
    }
    localStorage.setItem(STORAGE_USER + currentSetName, JSON.stringify(data));
    updateFilteredData(false);
}

function setLv(id, lv, btn) {
    let key = STORAGE_LV + currentSetName;
    let data = JSON.parse(localStorage.getItem(key)) || {};
    data[id] = (data[id] === lv) ? null : lv;
    localStorage.setItem(key, JSON.stringify(data));
    
    updateFilteredData(true); // Re-render để cập nhật tab
}

function saveNote(id, val) {
    let data = JSON.parse(localStorage.getItem(STORAGE_USER + currentSetName)) || {};
    if (!data[id]) data[id] = {ans:null, note:""};
    data[id].note = val;
    localStorage.setItem(STORAGE_USER + currentSetName, JSON.stringify(data));
}

function switchTab(t) { 
    currentTab = t; 
    localStorage.setItem('PMP_LAST_TAB', t); 
    currentIndex = 0; 
    updateFilteredData(true); 
}

function updateCarousel() { 
    document.getElementById('carousel-track').style.transform = `translateX(-${currentIndex*100}%)`; 
}

function triggerFlip(d) {
    if (d==='next' && currentIndex < filteredQuestions.length-1) currentIndex++;
    if (d==='prev' && currentIndex > 0) currentIndex--;
    updateCarousel();
}

function toggleInfo() {
    let slide = document.getElementById('carousel-track').children[currentIndex];
    let q = filteredQuestions[currentIndex];
    let box = slide.querySelector('.ex-box');
    box.style.display = box.style.display==='none'?'block':'none';
    slide.querySelectorAll('.option-item').forEach(opt => {
        if (opt.innerText.trim().startsWith(q.answer)) opt.classList.add('is-correct');
    });
}
</script>
</body>
</html>