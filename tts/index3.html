<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS API Debugger - Deep Log</title>
    <style>
        body { font-family: 'Segoe UI', system-ui; max-width: 900px; margin: 20px auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        button { background: #1a73e8; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background: #1557b0; }
        
        /* Log Styling */
        #log-display { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; min-height: 200px; overflow-y: auto; border-left: 5px solid #007bff; }
        .log-line { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; display: flex; }
        .log-time { color: #888; margin-right: 10px; font-size: 0.85em; }
        .step-label { color: #569cd6; font-weight: bold; min-width: 100px; display: inline-block; }
        .step-value { color: #ce9178; word-break: break-all; }
        
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-drive { background: #e6ffed; color: #22863a; border: 1px solid #22863a; }
        .badge-azure { background: #fff4e5; color: #c24e00; border: 1px solid #c24e00; }
    </style>
</head>
<body>

    <h2>üîç TTS Deep Log Debugger</h2>

    <div class="card">
        <div class="form-group">
            <label>N·ªôi dung ti·∫øng Nh·∫≠t:</label>
            <textarea id="text" rows="3">ÂÖàÊó•„ÅØÂ§öÂ§ß„Å™„Çã„ÅîÊîØÊè¥„Å®„ÅîÂçîÂäõ„ÄÅË™†„Å´„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ</textarea>
        </div>
        <div class="form-group" style="display: flex; gap: 15px;">
            <div style="flex: 1;">
                <label>Gi·ªçng ƒë·ªçc:</label>
                <select id="voice">
                    <option value="ja-JP-KeitaNeural">Nam (Keita)</option>
                    <option value="ja-JP-NanamiNeural">N·ªØ (Nanami)</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>T·ªëc ƒë·ªô:</label>
                <select id="rate">
                    <option value="0.8">Ch·∫≠m (0.8)</option>
                    <option value="1.0" selected>Th∆∞·ªùng (1.0)</option>
                    <option value="1.2">Nhanh (1.2)</option>
                </select>
            </div>
        </div>
        <button id="btnRun" onclick="runDebug()">üöÄ G·ªåI API & KI·ªÇM TRA LOG</button>
    </div>

    <div class="card">
        <div class="status-header">
            <strong>API INTERNAL LOGS (From Header X-Audio-Source):</strong>
            <div id="source-badge"></div>
        </div>
        <div id="log-display">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>
        <audio id="player" controls style="width: 100%; margin-top: 20px; display: none;"></audio>
    </div>

    <script>
        async function runDebug() {
            const display = document.getElementById('log-display');
            const badge = document.getElementById('source-badge');
            const player = document.getElementById('player');
            const btn = document.getElementById('btnRun');

            // Reset UI
            display.innerHTML = 'ƒêang g·ªçi API...';
            badge.innerHTML = '';
            player.style.display = 'none';
            btn.disabled = true;

            const text = document.getElementById('text').value;
            const voice = document.getElementById('voice').value;
            const rate = document.getElementById('rate').value;
            const lang = voice.substring(0, 5);

            const url = `/api/tts_test?text=${encodeURIComponent(text)}&lang=${lang}&voice=${voice}&rate=${rate}`;

            try {
                const start = Date.now();
                const res = await fetch(url);
                const end = Date.now();

                // 1. L·∫•y chu·ªói log "kh·ªïng l·ªì" t·ª´ Header
                const xLog = res.headers.get('X-Audio-Source');
                
                // 2. Hi·ªÉn th·ªã log chi ti·∫øt
                display.innerHTML = '';
                if (xLog) {
                    const steps = xLog.split(' | ');
                    steps.forEach(step => {
                        const parts = step.split(': ');
                        const row = document.createElement('div');
                        row.className = 'log-line';
                        row.innerHTML = `
                            <span class="log-time">${new Date().toLocaleTimeString()}</span>
                            <span class="step-label">${parts[0] || 'STEP'}:</span>
                            <span class="step-value">${parts[1] || ''}</span>
                        `;
                        display.appendChild(row);
                    });
                } else {
                    display.innerHTML = '<span style="color:red">Kh√¥ng t√¨m th·∫•y Header X-Audio-Source!</span>';
                }

                // 3. Ph√¢n t√≠ch ngu·ªìn ƒë·ªÉ g·∫Øn Badge
                if (xLog && xLog.includes('Drive_OK')) {
                    badge.innerHTML = '<span class="badge badge-drive">DATABASE: GOOGLE DRIVE</span>';
                } else if (xLog && xLog.includes('Azure_OK')) {
                    badge.innerHTML = '<span class="badge badge-azure">DATABASE: AZURE CLOUD</span>';
                }

                if (res.ok) {
                    const blob = await res.blob();
                    player.src = URL.createObjectURL(blob);
                    player.style.display = 'block';
                    player.play();
                    
                    const timeRow = document.createElement('div');
                    timeRow.style.color = '#a6e22e';
                    timeRow.style.marginTop = '10px';
                    timeRow.innerHTML = `‚úÖ Ph·∫£n h·ªìi trong: ${(end - start)}ms`;
                    display.appendChild(timeRow);
                } else {
                    display.innerHTML += `<div style="color:red">Error: ${res.status}</div>`;
                }

            } catch (err) {
                display.innerHTML = `<span style="color:red">L·ªói k·∫øt n·ªëi: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>