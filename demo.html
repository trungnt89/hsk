<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSK Master - Smart Playback</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --accent: #fbbf24; --danger: #ef4444; --bg: #f1f5f9; --card: #ffffff; --success: #10b981; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
        .top-section { background: #fff; box-shadow: 0 1px 5px rgba(0,0,0,0.1); padding-bottom: 8px; flex-shrink: 0; z-index: 10; }
        header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        header h3 { margin: 0; font-family: 'Montserrat'; color: var(--primary); font-size: 1.1rem; }
        #page-label { font-weight: 800; color: var(--primary); font-size: 11px; }
        .settings-panel { padding: 0 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .setting-item label { font-size: 8px; font-weight: 800; color: #94a3b8; display: block; margin-bottom: 2px; text-transform: uppercase; }
        select { width: 100%; border: 1.5px solid #e2e8f0; padding: 6px; border-radius: 8px; font-weight: bold; font-size: 10px; outline: none; background: #fff; }
        .scroll-area { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .word-card { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 8px; display: grid; grid-template-columns: 1.3fr 1fr; gap: 15px; align-items: center; border: 2px solid transparent; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; }
        .word-card.active { border-color: var(--primary); background: #eff6ff; transform: scale(1.01); }
        .hz-column { font-family: 'Noto Sans SC'; font-size: 1.2rem; color: #1e293b; line-height: 1.4; word-wrap: break-word; font-weight: 700; }
        .info-column { display: flex; flex-direction: column; justify-content: center; border-left: 2px solid #f1f5f9; padding-left: 12px; }
        .pinyin { color: var(--primary); font-weight: 700; font-size: 0.8rem; line-height: 1.3; }
        .meaning { color: #64748b; font-size: 0.8rem; line-height: 1.3; margin-top: 4px; font-weight: 500; }
        .controls-bar { height: 90px; background: #fff; display: flex; align-items: center; box-shadow: 0 -3px 15px rgba(0,0,0,0.08); border-radius: 20px 20px 0 0; padding: 0 5px; flex-shrink: 0; z-index: 10; }
        .ctrl-group { flex: 1; display: flex; justify-content: space-evenly; align-items: center; }
        .btn-nav { background: #f8fafc; border: none; color: #64748b; width: 50px; height: 50px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .btn-nav i { font-style: normal; font-size: 16px; }
        .btn-nav small { font-size: 7px; font-weight: 800; text-transform: uppercase; margin-top: 2px; }
        .btn-nav.active-blue { background: var(--primary); color: #fff; }
        .btn-nav.active-green { background: var(--success); color: #fff; }
        .btn-clear { color: var(--danger); background: #fff1f2; }
        .btn-play-container { position: relative; width: 65px; height: 65px; flex-shrink: 0; }
        .btn-play { position: absolute; top: -35px; left: 0; width: 65px; height: 65px; background: var(--accent); border: 5px solid var(--bg); border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 5px 15px rgba(251, 191, 36, 0.4); display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="top-section">
    <header><h3>HSK MASTER</h3><div id="page-label">PAGE 01/01</div></header>
    <div class="settings-panel">
        <div class="setting-item"><label>Gi·ªçng ƒë·ªçc</label><select id="voice-select">
            <option value="zh-CN-XiaoxiaoNeural">Azure N·ªØ</option>
            <option value="zh-CN-YunxiNeural">Azure Nam</option>
            <option value="google">Google TTS</option>
            <option value="browser">M√°y (Local)</option>
        </select></div>
        <div class="setting-item"><label>S·ªë l∆∞·ª£ng</label><select id="limit-select">
            <option value="10">10 M·ª•c</option><option value="20">20 M·ª•c</option><option value="50">50 M·ª•c</option>
        </select></div>
        <div class="setting-item"><label>Ngh·ªâ gi·ªØa t·ª´</label><select id="delay-select">
            <option value="500">0.5 Gi√¢y</option><option value="1000">1 Gi√¢y</option><option value="2000">2 Gi√¢y</option><option value="3000">3 Gi√¢y</option>
        </select></div>
    </div>
</div>

<div class="scroll-area" id="word-list"></div>

<div class="controls-bar">
    <div class="ctrl-group">
        <button class="btn-nav" id="type-btn"><i>üìñ</i><small id="type-txt">T·ª´</small></button>
        <button class="btn-nav" id="shuffle-btn"><i>üîÅ</i><small>X√°o</small></button>
        <button class="btn-nav" id="prev-btn"><i>‚èÆ</i><small>Tr∆∞·ªõc</small></button>
    </div>
    <div class="btn-play-container"><button class="btn-play" id="play-btn">‚ñ∂</button></div>
    <div class="ctrl-group">
        <button class="btn-nav" id="next-btn"><i>‚è≠</i><small>Sau</small></button>
        <button class="btn-nav btn-clear" id="clear-db-btn"><i>üóëÔ∏è</i><small>X√≥a</small></button>
    </div>
</div>

<audio id="google-audio" hidden></audio>
<script src="demo-data.js"></script>

<script>
/** 1. DATABASE & STORAGE **/
const dbName = "HSK_Azure_Cache", storeName = "audioStore", SAVE_KEY = "HSK_APP_STATE";
async function openDB() {
    return new Promise(res => {
        const req = indexedDB.open(dbName, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore(storeName);
        req.onsuccess = e => res(e.target.result);
    });
}
function saveAppState() {
    const state = { page, isShuffle, isSentence, voice: document.getElementById('voice-select').value, limit: document.getElementById('limit-select').value, delay: document.getElementById('delay-select').value };
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}
function loadAppState() {
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) {
        const state = JSON.parse(saved);
        page = state.page || 1; isShuffle = state.isShuffle || false; isSentence = state.isSentence || false;
        document.getElementById('voice-select').value = state.voice || "zh-CN-XiaoxiaoNeural";
        document.getElementById('limit-select').value = state.limit || "10";
        document.getElementById('delay-select').value = state.delay || "1000";
        document.getElementById('shuffle-btn').classList.toggle('active-blue', isShuffle);
        document.getElementById('type-btn').classList.toggle('active-green', isSentence);
        document.getElementById('type-txt').innerText = isSentence ? 'V√≠ d·ª•' : 'T·ª´';
    }
}

/** 2. STATE **/
let page = 1, isShuffle = false, isSentence = false, isPlaying = false;
let nextTimer = null, currentIndex = -1, currentList = [];
let currentAudio = null;

/** 3. SMART TTS LOGIC **/
async function speak(text) {
    return new Promise(async (resolve) => {
        const voice = document.getElementById("voice-select").value;
        if (currentAudio) { currentAudio.pause(); currentAudio.src = ""; }
        window.speechSynthesis.cancel();

        const onAudioEnd = () => { resolve(); };

        // 3.1. Browser TTS
        if (voice === "browser") {
            const u = new SpeechSynthesisUtterance(text); u.lang = "zh-CN";
            u.onend = onAudioEnd; window.speechSynthesis.speak(u); return;
        }

        // 3.2. Google TTS
        if (voice === "google") {
            const g = document.getElementById("google-audio");
            g.src = `https://translate.google.com/translate_tts?ie=UTF-8&client=gtx&tl=zh-CN&q=${encodeURIComponent(text)}`;
            g.onended = onAudioEnd; g.play().catch(onAudioEnd); return;
        }

        // 3.3. Azure + Cache
        const key = `${voice}_${text}`;
        const db = await openDB();
        let blob = await new Promise(r => {
            const req = db.transaction(storeName).objectStore(storeName).get(key);
            req.onsuccess = () => r(req.result);
        });

        if (!blob) {
            try {
                const res = await fetch(`/api/tts?text=${encodeURIComponent(text)}&voice=${voice}`);
                const buf = await res.arrayBuffer();
                blob = new Blob([buf], { type: "audio/mpeg" });
                db.transaction(storeName, "readwrite").objectStore(storeName).put(blob, key);
            } catch (e) { onAudioEnd(); return; }
        }
        
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        currentAudio.onended = () => { URL.revokeObjectURL(url); onAudioEnd(); };
        currentAudio.play().catch(onAudioEnd);
    });
}

/** 4. RENDER **/
function render(keep = false) {
    const limit = parseInt(document.getElementById('limit-select').value);
    const listEl = document.getElementById('word-list');
    let rawItems = hskData.slice((page - 1) * limit, page * limit);
    currentList = isShuffle ? [...rawItems].sort(() => Math.random() - 0.5) : rawItems;
    listEl.innerHTML = '';
    currentList.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'word-card'; card.id = `card-${i}`;
        card.onclick = () => { currentIndex = i; playItem(i); };
        const hzText = isSentence ? item.exHz : item.hz;
        const pyText = isSentence ? item.exPy : item.py;
        const viText = isSentence ? item.exVi : item.vi;
        card.innerHTML = `<div class="hz-column">${hzText}</div><div class="info-column"><div class="pinyin">${pyText}</div><div class="meaning">${viText}</div></div>`;
        listEl.appendChild(card);
    });
    document.getElementById('page-label').innerText = `PAGE ${page}/${Math.ceil(hskData.length/limit)}`;
    if(keep) updateUI(); else currentIndex = -1;
    saveAppState();
}

/** 5. SMART PLAYBACK LOGIC **/
async function playItem(i) {
    clearTimeout(nextTimer);
    currentIndex = i;
    updateUI();
    
    const item = currentList[currentIndex];
    if (!item) return;

    // ƒê·ª£i ƒë·ªçc xong t·ª´ hi·ªán t·∫°i
    await speak(isSentence ? item.exHz : item.hz);

    // N·∫øu v·∫´n ƒëang b·∫≠t ch·∫ø ƒë·ªô Play, ƒë·ª£i kho·∫£ng ngh·ªâ (delay) r·ªìi m·ªõi sang t·ª´ ti·∫øp theo
    if (isPlaying) {
        const waitTime = parseInt(document.getElementById('delay-select').value);
        nextTimer = setTimeout(() => {
            currentIndex++;
            if (currentIndex >= currentList.length) {
                currentIndex = 0;
                if (isShuffle) render(true);
            }
            playItem(currentIndex);
        }, waitTime);
    }
}

function updateUI() {
    document.querySelectorAll('.word-card').forEach(c => c.classList.remove('active'));
    const card = document.getElementById(`card-${currentIndex}`);
    if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
}

/** 6. CONTROLS **/
document.getElementById('play-btn').onclick = function() {
    isPlaying = !isPlaying; this.innerText = isPlaying ? '‚èπ' : '‚ñ∂';
    if (isPlaying) { 
        if(currentIndex === -1) currentIndex = 0; 
        playItem(currentIndex); 
    } else {
        clearTimeout(nextTimer);
        if(currentAudio) currentAudio.pause();
        window.speechSynthesis.cancel();
    }
};

document.getElementById('next-btn').onclick = () => { 
    const total = Math.ceil(hskData.length / parseInt(document.getElementById('limit-select').value));
    if(page < total) { page++; render(); if(isPlaying) playItem(0); }
};
document.getElementById('prev-btn').onclick = () => { 
    if(page > 1) { page--; render(); if(isPlaying) playItem(0); }
};
document.getElementById('shuffle-btn').onclick = function() { 
    isShuffle = !isShuffle; this.classList.toggle('active-blue', isShuffle); 
    render(true); if(isPlaying) playItem(0);
};
document.getElementById('type-btn').onclick = function() { 
    isSentence = !isSentence; this.classList.toggle('active-green', isSentence); 
    document.getElementById('type-txt').innerText = isSentence ? 'V√≠ d·ª•' : 'T·ª´';
    render(true); if(currentIndex >= 0) playItem(currentIndex);
};

document.getElementById('clear-db-btn').onclick = async () => { if(confirm("X√≥a cache?")) { (await openDB()).transaction(storeName, "readwrite").objectStore(storeName).clear(); } };
document.getElementById('voice-select').onchange = saveAppState;
document.getElementById('delay-select').onchange = saveAppState;
document.getElementById('limit-select').onchange = () => { page = 1; render(); };

loadAppState();
render();
</script>
</body>
</html>