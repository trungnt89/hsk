<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="manifest" href="manifest.json">
	<script src="../assistive.js"></script>    
    <title>Todo Notify Manager</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; padding-bottom: 270px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; box-sizing: border-box; }
        h3 { margin-top: 0; color: #1e293b; }
        button { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.1s, opacity 0.2s; font-size: 14px; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        
        .btn-blue { background: #4facfe; color: white; }
        .btn-green { background: #00b894; color: white; }
        .btn-red { background: #ff7675; color: white; }
        .btn-gray { background: #636e72; color: white; }
        
        #mobile-console { position: fixed; bottom: 0; left: 0; width: 100%; height: 250px; background: #1e2124; color: #a2fca2; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; overflow-y: auto; box-sizing: border-box; border-top: 4px solid #4facfe; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #2d3136; padding-bottom: 2px; }
    </style>
</head>
<body>

<div class="card">
    <h3>üîî Qu·∫£n l√Ω Th√¥ng b√°o</h3>
    <p style="font-size: 13px; color: #64748b; margin-bottom: 20px;">Tr·∫°ng th√°i h·ªá th·ªëng: <b id="status-text">ƒêang ki·ªÉm tra...</b></p>
    
    <button class="btn-green" onclick="requestPerm()">1. C·∫§P QUY·ªÄN TH√îNG B√ÅO</button>
    <button class="btn-blue" onclick="triggerTest()">2. G·ª¨I TEST NGAY</button>
    <button id="toggleBtn" class="btn-red" onclick="toggleStatus(false)">3. T·∫ÆT TH√îNG B√ÅO</button>
    <button class="btn-gray" onclick="uninstallSW()">4. G·ª† B·ªé H·ªÜ TH·ªêNG (RESET)</button>
</div>

<div id="mobile-console">
    <div style="color: #4facfe; font-weight: bold;">--- Debug Console H·ªá Th·ªëng ---</div>
</div>

<script>
    const consoleEl = document.getElementById('mobile-console');
    const statusEl = document.getElementById('status-text');

    const addLog = (m, t="info") => {
        const d = document.createElement('div');
        d.className = "log-line";
        d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
        if (t === "error") d.style.color = "#ff7675";
        else if (t === "warn") d.style.color = "#fdcb6e";
        else if (t === "success") d.style.color = "#55efc4";
        consoleEl.appendChild(d);
        consoleEl.scrollTop = consoleEl.scrollHeight;
    };

    // 1. ƒêƒÉng k√Ω v√† l·∫Øng nghe Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => {
                addLog("Service Worker: ƒê√£ ƒëƒÉng k√Ω th√†nh c√¥ng", "success");
                statusEl.textContent = "ƒêang ho·∫°t ƒë·ªông";
                statusEl.style.color = "#00b894";
            }).catch(err => {
                addLog("L·ªói ƒëƒÉng k√Ω SW: " + err, "error");
                statusEl.textContent = "L·ªói k·∫øt n·ªëi";
            });
        });

        // Nh·∫≠n log t·ª´ sw.js g·ª≠i v·ªÅ
        navigator.serviceWorker.addEventListener('message', e => {
            if (e.data.action === 'log_from_sw') {
                addLog(e.data.message, e.data.logType);
            }
        });
    } else {
        addLog("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ Service Worker!", "error");
    }

    // 2. Ch·ª©c nƒÉng c·∫•p quy·ªÅn
    async function requestPerm() {
        addLog("ƒêang y√™u c·∫ßu quy·ªÅn...");
        const p = await Notification.requestPermission();
        addLog("K·∫øt qu·∫£ quy·ªÅn: " + p, p === 'granted' ? 'success' : 'error');
        if (p === 'granted') {
            addLog("ƒê√£ s·∫µn s√†ng nh·∫≠n th√¥ng b√°o.");
        } else {
            alert("B·∫°n c·∫ßn c·∫•p quy·ªÅn ƒë·ªÉ nh·∫≠n th√¥ng b√°o c√¥ng vi·ªác!");
        }
    }

    // 3. G·ª≠i l·ªánh Test
    function triggerTest() {
        if (!navigator.serviceWorker.controller) {
            addLog("L·ªói: SW ch∆∞a s·∫µn s√†ng. H√£y Refresh (F5).", "warn");
            return;
        }
        addLog("ƒêang y√™u c·∫ßu SW g·ª≠i th√¥ng b√°o test...");
        navigator.serviceWorker.controller.postMessage({ action: 'test_notify_now' });
    }

    // 4. Ch·ª©c nƒÉng B·∫≠t/T·∫Øt (Ch·ª©c nƒÉng 3)
    function toggleStatus(enable) {
        if (!navigator.serviceWorker.controller) {
            addLog("Kh√¥ng t√¨m th·∫•y tr√¨nh ƒëi·ªÅu khi·ªÉn SW.", "error");
            return;
        }

        // G·ª≠i l·ªánh v√†o SW
        navigator.serviceWorker.controller.postMessage({ 
            action: 'set_notify_status', 
            value: enable 
        });

        const btn = document.getElementById('toggleBtn');
        if (enable) {
            btn.innerText = "3. T·∫ÆT TH√îNG B√ÅO";
            btn.className = "btn-red";
            btn.onclick = () => toggleStatus(false);
            addLog("H·ªá th·ªëng: ƒê√£ B·∫¨T ki·ªÉm tra ng·∫ßm.", "warn");
        } else {
            btn.innerText = "3. B·∫¨T L·∫†I TH√îNG B√ÅO";
            btn.className = "btn-green";
            btn.onclick = () => toggleStatus(true);
            addLog("H·ªá th·ªëng: ƒê√£ T·∫ÆT ki·ªÉm tra ng·∫ßm.", "warn");
        }
    }

    // 5. G·ª° b·ªè ho√†n to√†n (Ch·ª©c nƒÉng 4)
    async function uninstallSW() {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª° b·ªè to√†n b·ªô h·ªá th·ªëng th√¥ng b√°o?")) return;
        
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) {
            await r.unregister();
        }
        addLog("ƒêang x√≥a d·ªØ li·ªáu h·ªá th·ªëng...", "warn");
        
        // X√≥a th√™m cache n·∫øu c√≥
        if ('caches' in window) {
            const keys = await caches.keys();
            for (let key of keys) await caches.delete(key);
        }

        addLog("ƒê√£ g·ª° b·ªè s·∫°ch s·∫Ω. T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i sau 2s...", "error");
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    }
</script>
</body>
</html>