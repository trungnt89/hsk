<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Manager Pro - Compact View</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white; padding: 25px; border-radius: 20px;
            margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .header h1 {
            font-size: 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
        }
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px; margin-top: 20px;
        }
        .stat-item {
            padding: 15px; background: #f8f9fa; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.3s;
            border: 2px solid transparent;
        }
        .stat-item.active-filter { border-color: #667eea; background: #fff; }
        .stat-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: #495057; font-weight: 700; text-transform: uppercase; }
        .stat-icon { font-size: 24px; margin-bottom: 4px; }
        .stat-item.overdue .stat-value { color: #dc3545; }
        .stat-item.urgent .stat-value { color: #ffc107; }
        .stat-item.warning .stat-value { color: #2196F3; }
        .stat-item.safe .stat-value { color: #28a745; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .add-task-section {
            background: white; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 450px; position: relative;
        }
        .btn-open-modal {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            border-radius: 50%; background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; border: none; font-size: 30px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(56, 239, 125, 0.4); z-index: 999;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; padding: 15px 20px; border-radius: 12px;
            margin-bottom: 20px; display: flex; align-items: center; gap: 16px;
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .form-group label { font-size: 13px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea, .form-group select { padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; }
        .btn-add {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
        }

        .tasks-grid { display: flex; flex-direction: column; gap: 8px; }
        .task-card { 
            background: white; padding: 12px 20px; border-radius: 12px; 
            border-left: 5px solid #e9ecef; transition: 0.2s;
            display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 20px;
        }
        .task-card:hover { transform: translateX(5px); }
        .task-card.overdue { border-left-color: #dc3545; }
        .task-card.urgent { border-left-color: #ff6b6b; }
        .task-card.warning { border-left-color: #2196F3; }
        .task-card.safe { border-left-color: #28a745; }
        
        .task-title { font-size: 16px; font-weight: 700; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .task-detail-sub { font-size: 13px; color: #777; font-weight: 400; margin-left: 8px; font-style: italic; }
        .deadline-info { font-size: 13px; color: #555; font-family: monospace; min-width: 130px; text-align: right; }
        .btn-icon { width: 32px; height: 32px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .priority-badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; background: #eee; margin-left: 5px;}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Todo Manager Pro</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <p style="font-size: 14px; color: #666;">Danh s√°ch c√¥ng vi·ªác r√∫t g·ªçn</p>
                <button onclick="filterTasks('all', this)" style="padding: 5px 12px; border: 1px solid #667eea; color: #667eea; background: white; cursor: pointer; border-radius: 8px; font-size: 12px; font-weight: 600;">üëÅÔ∏è Xem t·∫•t c·∫£</button>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 12px; background: #f0f2f5; border-radius: 12px; font-size: 13px; color: #444;">
                <span style="cursor:pointer; border-bottom: 1px dashed #999" onclick="filterByTime('today', this)">üìÖ H√¥m nay: <strong id="todoToday">0</strong></span>
                <span style="cursor:pointer; border-bottom: 1px dashed #999" onclick="filterByTime('week', this)">üóìÔ∏è Trong tu·∫ßn: <strong id="todoWeek">0</strong></span>
                <span style="cursor:pointer; border-bottom: 1px dashed #999" onclick="filterByTime('month', this)">üìÖ Trong th√°ng: <strong id="todoMonth">0</strong></span>
            </div>

            <div class="stats-bar" id="statsBar">
                <div class="stat-item overdue" onclick="filterTasks('overdue', this)">
                    <div class="stat-icon">üö´</div>
                    <div class="stat-value" id="statOverdue">0</div>
                    <div class="stat-label">üî¥ Qu√° h·∫°n</div>
                </div>
                <div class="stat-item urgent" onclick="filterTasks('urgent', this)">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="statUrgent">0</div>
                    <div class="stat-label">‚ö†Ô∏è Kh·∫©n c·∫•p</div>
                </div>
                <div class="stat-item warning" onclick="filterTasks('warning', this)">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-value" id="statWarning">0</div>
                    <div class="stat-label">üîµ C·∫£nh b√°o</div>
                </div>
                <div class="stat-item safe" onclick="filterTasks('completed', this)">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="statSafe">0</div>
                    <div class="stat-label">‚úÖ Xong</div>
                </div>
            </div>
        </div>

        <div class="alert-banner" id="alertBanner" style="display: none;">
            <div class="alert-icon">üö®</div>
            <div class="alert-content"><p id="alertText"></p></div>
        </div>

        <div class="tasks-grid" id="tasksGrid"></div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="add-task-section">
            <button onclick="toggleModal()" style="position:absolute; right:20px; top:20px; border:none; background:none; cursor:pointer; font-size:20px; color:#999">‚úï</button>
            <h2 style="margin-bottom:20px">‚ûï Th√™m vi·ªác m·ªõi</h2>
            <div class="form-group"><label>T√™n c√¥ng vi·ªác *</label><input type="text" id="taskTitle" placeholder="..."></div>
            <div class="form-group"><label>Chi ti·∫øt</label><textarea id="taskDetail" rows="2" placeholder="..."></textarea></div>
            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end;">
                <div><label>X·ª≠ l√Ω trong</label><input type="number" id="durationValue" value="1" placeholder="S·ªë" oninput="calculateDeadline()"></div>
                <div><select id="durationUnit" onchange="calculateDeadline()" style="width: 100%;">
                    <option value="hours">Gi·ªù</option>
                    <option value="days" selected>Ng√†y</option>
                    <option value="weeks">Tu·∫ßn</option>
                    <option value="months">Th√°ng</option>
                </select></div>
            </div>
            <div class="form-group"><label>Deadline *</label><input type="datetime-local" id="taskDeadline"></div>
            <div class="form-group"><label>∆Øu ti√™n</label><select id="taskPriority"><option value="high">Cao</option><option value="medium" selected>Trung b√¨nh</option><option value="low">Th·∫•p</option></select></div>
            <button class="btn-add" onclick="addTask()">L∆ØU C√îNG VI·ªÜC</button>
        </div>
    </div>

    <button class="btn-open-modal" onclick="toggleModal()">+</button>

    <script>
        let tasks = [];
        let currentFilter = 'all';
        let editingTaskId = null;
        let db;
        const DB_NAME = "TodoDBPro";
        const STORE_NAME = "tasks_store";

        // Kh·ªüi t·∫°o IndexedDB
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
        };
        request.onsuccess = e => {
            db = e.target.result;
            loadTasksFromDB();
        };

        function saveToDB() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.put({ id: "current_tasks_list", data: tasks });
        }

        function loadTasksFromDB() {
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const req = store.get("current_tasks_list");
            req.onsuccess = () => {
                if (req.result) tasks = req.result.data;
                updateStats(); renderTasks();
            };
        }

        function toggleModal() {
            const modal = document.getElementById('taskModal');
            if (modal.style.display !== 'flex') {
                if (!editingTaskId) {
                    document.querySelector('#taskModal h2').textContent = "‚ûï Th√™m vi·ªác m·ªõi";
                    document.querySelector('.btn-add').textContent = "L∆ØU C√îNG VI·ªÜC";
                    resetForm();
                    // G·ªçi t√≠nh to√°n deadline m·∫∑c ƒë·ªãnh ngay khi m·ªü (cho 1 ng√†y)
                    calculateDeadline();
                } else {
                    modal.style.display = 'flex';
                }
                const now = new Date();
                // N·∫øu kh√¥ng c√≥ t√≠nh to√°n deadline t·ª´ durationValue th√¨ l·∫•y m·∫∑c ƒë·ªãnh
                if(!document.getElementById('taskDeadline').value) {
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById('taskDeadline').value = now.toISOString().slice(0, 16);
                }
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
                resetForm();
            }
        }

        function calculateDeadline() {
            const val = parseFloat(document.getElementById('durationValue').value);
            const unit = document.getElementById('durationUnit').value;
            if (isNaN(val) || val <= 0) return;
            const now = new Date();
            if (unit === 'hours') now.setHours(now.getHours() + val);
            else if (unit === 'days') now.setDate(now.getDate() + val);
            else if (unit === 'weeks') now.setDate(now.getDate() + (val * 7));
            else if (unit === 'months') now.setMonth(now.getMonth() + val);
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('taskDeadline').value = now.toISOString().slice(0, 16);
        }

        function getDeadlineStatus(deadline, completed) {
            if (completed) return 'completed';
            const diff = new Date(deadline) - new Date();
            if (diff < 0) return 'overdue';
            if (diff / 3600000 < 48) return 'urgent';
            if (diff / 3600000 < 168) return 'warning';
            return 'safe';
        }

        function updateStats() {
            const stats = { overdue: 0, urgent: 0, warning: 0, completed: 0 };
            const now = new Date();
            let counts = { today: 0, week: 0, month: 0 };

            tasks.forEach(t => {
                const s = getDeadlineStatus(t.deadline, t.completed);
                if (s === 'completed') stats.completed++; else if (s in stats) stats[s]++;
                if (!t.completed) {
                    const d = new Date(t.deadline);
                    if (d.toDateString() === now.toDateString()) counts.today++;
                    if ((d - now) / 86400000 <= 7 && (d-now) >= 0) counts.week++;
                    if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) counts.month++;
                }
            });

            ['Overdue', 'Urgent', 'Warning', 'Safe'].forEach(id => {
                const el = document.getElementById('stat' + id);
                if(el) el.textContent = stats[id.toLowerCase()] || 0;
            });
            document.getElementById('todoToday').textContent = counts.today;
            document.getElementById('todoWeek').textContent = counts.week;
            document.getElementById('todoMonth').textContent = counts.month;

            const banner = document.getElementById('alertBanner');
            if (stats.overdue > 0) {
                banner.style.display = 'flex';
                document.getElementById('alertText').textContent = `C√≥ ${stats.overdue} vi·ªác qu√° h·∫°n!`;
            } else banner.style.display = 'none';
        }

        function filterByTime(range) {
            currentFilter = range;
            const now = new Date();
            let filtered = tasks.filter(t => {
                if (t.completed) return false;
                const d = new Date(t.deadline);
                if (range === 'today') return d.toDateString() === now.toDateString();
                if (range === 'week') return (d - now) / 86400000 <= 7 && (d-now) >= 0;
                if (range === 'month') return d.getMonth() === now.getMonth();
                return true;
            });
            renderTasks(filtered);
        }

        function renderTasks(customList = null) {
            const grid = document.getElementById('tasksGrid');
            let filtered = customList || tasks;
            if (!customList && currentFilter !== 'all') filtered = tasks.filter(t => getDeadlineStatus(t.deadline, t.completed) === currentFilter);

            grid.innerHTML = filtered.length ? filtered.map(t => `
                <div class="task-card ${getDeadlineStatus(t.deadline, t.completed)}">
                    <div class="task-title">
                        <span>${t.completed ? '‚úÖ ' : ''}${t.title} <span class="priority-badge">${t.priority}</span></span>
                        ${t.detail ? `<span class="task-detail-sub">- ${t.detail}</span>` : ''}
                    </div>
                    <div class="deadline-info">üìÖ ${new Date(t.deadline).toLocaleString('vi-VN', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}</div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button class="btn-icon" style="background:#e3f2fd" onclick="editTask(${t.id})">‚úèÔ∏è</button>
                        ${!t.completed ? `<button class="btn-icon" style="background:#d4edda" onclick="completeTask(${t.id})">‚úì</button>` : ''}
                        <button class="btn-icon" style="background:#f8d7da" onclick="deleteTask(${t.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('') : '<div style="text-align:center; padding:30px; color:white; opacity:0.7">Tr·ªëng...</div>';
        }

        function addTask() {
            const title = document.getElementById('taskTitle').value;
            const dl = document.getElementById('taskDeadline').value;
            if (!title || !dl) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");

            if (editingTaskId) {
                const index = tasks.findIndex(t => t.id === editingTaskId);
                if (index !== -1) {
                    tasks[index] = { ...tasks[index], title, detail: document.getElementById('taskDetail').value, deadline: new Date(dl).toISOString(), priority: document.getElementById('taskPriority').value };
                }
                editingTaskId = null;
            } else {
                tasks.unshift({ id: Date.now(), title, detail: document.getElementById('taskDetail').value, deadline: new Date(dl).toISOString(), priority: document.getElementById('taskPriority').value, completed: false });
            }
            
            saveToDB(); toggleModal(); updateStats(); renderTasks(); resetForm();
        }

        function editTask(id) {
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            editingTaskId = id;
            document.getElementById('taskTitle').value = t.title;
            document.getElementById('taskDetail').value = t.detail;
            document.getElementById('taskPriority').value = t.priority;
            document.getElementById('taskDeadline').value = t.deadline.slice(0, 16);
            document.querySelector('#taskModal h2').textContent = "üìù S·ª≠a c√¥ng vi·ªác";
            document.querySelector('.btn-add').textContent = "C·∫¨P NH·∫¨T THAY ƒê·ªîI";
            document.getElementById('taskModal').style.display = 'flex';
        }

        function resetForm() {
            ['taskTitle', 'taskDetail'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('durationValue').value = '1';
            editingTaskId = null;
        }

        function filterTasks(f, el) { currentFilter = f; renderTasks(); }
        function completeTask(id) { const t = tasks.find(x => x.id === id); if(t) t.completed = true; saveToDB(); updateStats(); renderTasks(); }
        function deleteTask(id) { if(confirm("X√≥a?")) { tasks = tasks.filter(x => x.id !== id); saveToDB(); updateStats(); renderTasks(); } }
    </script>
</body>
</html>