<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body>
<script>
    const DB_CONFIG = {
        NAME: "TodoDBPro",
        STORE: "tasks_store",
        KEY: "current_tasks_list"
    };

    function toLocalYMD(isoStr) {
        const d = new Date(isoStr);
        if (isNaN(d.getTime())) return null;
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    const request = indexedDB.open(DB_CONFIG.NAME, 1);

    request.onsuccess = (e) => {
        const db = e.target.result;
        try {
            const transaction = db.transaction(DB_CONFIG.STORE, "readonly");
            const store = transaction.objectStore(DB_CONFIG.STORE);
            const getReq = store.get(DB_CONFIG.KEY);

            getReq.onsuccess = () => {
                const result = getReq.result;
                let output = { tasks: [] };

                if (result && Array.isArray(result.data)) {
                    output.tasks = result.data.map(item => ({
                        deadline: toLocalYMD(item.deadline),
                        title: item.title
                    }));
                }

                // Xóa sạch mọi thẻ HTML và ghi đè JSON thuần túy
                document.open();
                document.write(JSON.stringify(output, null, 2));
                document.close();
                
                // Cấu hình Header giả lập cho trình duyệt (chỉ có tác dụng hiển thị)
                document.body.style.whiteSpace = "pre";
                document.body.style.fontFamily = "monospace";
            };
        } catch (err) {
            document.body.textContent = JSON.stringify({ error: err.message });
        }
    };

    request.onerror = () => {
        document.body.textContent = JSON.stringify({ error: "DB_OPEN_FAILED" });
    };
</script>
</body>
</html>