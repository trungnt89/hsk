<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n tr·ªã IndexedDB - Local Manager</title>
    <script src="../com/assistive.js"></script>
    <style>
        :root { --primary: #3498db; --view: #9b59b6; --clear: #e74c3c; --delete: #c0392b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f2f5; padding: 20px; -webkit-text-size-adjust: 100%; }
        .container { max-width: 1200px; margin: auto; }
        
        .header-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        #log { background: #1e1e1e; color: #00ff00; padding: 10px; border-radius: 8px; max-height: 80px; overflow-y: auto; font-family: monospace; font-size: 11px; margin-bottom: 20px; }
        
        .db-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .store-item { border: 1px solid #e1e4e8; border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .store-header { background: #f8f9fa; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e1e4e8; }
        
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; }
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; color: white; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-view { background: var(--view); }
        .btn-clear { background: var(--clear); }
        .btn-del-row { background: var(--delete); padding: 4px 8px; }

        .data-viewer { display: none; padding: 10px; background: #fff; max-height: 600px; overflow: auto; }
        .record-card { border-bottom: 2px solid #eee; padding: 15px 5px; margin-bottom: 5px; }
        .record-header { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #7f8c8d; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
        .record-key { font-weight: bold; color: #2c3e50; font-size: 13px; margin-bottom: 8px; word-break: break-all; display: block; background: #f1f3f5; padding: 5px 8px; border-radius: 4px; }
        
        pre.json-pretty { 
            background: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #eee; 
            white-space: pre-wrap; font-family: 'Consolas', monospace; color: #d63384;
            margin: 0; max-height: 400px; overflow: auto; font-size: 12px; line-height: 1.4;
        }
        
        .audio-ctrl { display: flex; flex-direction: column; gap: 5px; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        audio { height: 35px; width: 100%; }
        .download-link { font-size: 12px; color: var(--primary); text-decoration: none; font-weight: bold; }

        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 12px 25px; border-radius: 30px;
            font-size: 13px; z-index: 10000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .btn-group { gap: 3px; }
            button { padding: 8px 10px; font-size: 11px; flex: 1; min-width: 80px; }
            .store-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .btn-group { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div class="header-box">
        <h2>üìä Qu·∫£n L√Ω D·ªØ Li·ªáu N·ªôi B·ªô (IndexedDB)</h2>
    </div>
    
    <div id="log">S·∫µn s√†ng...</div>
    <div id="results"></div>
</div>

<script>
    // T·ª± ƒë·ªông qu√©t khi load trang xong
    window.addEventListener('DOMContentLoaded', () => {
        writeLog("Trang ƒë√£ t·∫£i. B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông qu√©t Database...");
        deepScan();
    });

    function showToast(msg, duration = 3000) {
        const toastEl = document.getElementById('toast');
        toastEl.innerText = msg;
        toastEl.style.display = 'block';
        setTimeout(() => { toastEl.style.display = 'none'; }, duration);
    }

    function writeLog(msg) {
        const logEl = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] > ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function deepScan() {
        const resultsEl = document.getElementById('results');
        resultsEl.innerHTML = "";
        try {
            const dbs = await indexedDB.databases();
            const filteredDbs = dbs.filter(d => d.name !== "GAS_Config");
            if (filteredDbs.length === 0) {
                writeLog("Kh√¥ng t√¨m th·∫•y Database n√†o.");
                return;
            }
            filteredDbs.forEach(dbInfo => renderDB(dbInfo.name));
            writeLog(`ƒê√£ t√¨m th·∫•y ${filteredDbs.length} Database.`);
        } catch (e) { writeLog("L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ho·∫∑c l·ªói qu√©t danh s√°ch DB."); }
    }

    function renderDB(dbName) {
        const resultsEl = document.getElementById('results');
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const dbCard = document.createElement('div');
            dbCard.className = 'db-card';
            dbCard.innerHTML = `<div style="margin-bottom:10px"><b>üìÇ DB: ${dbName}</b></div>`;

            Array.from(db.objectStoreNames).forEach(sName => {
                const safeId = btoa(unescape(encodeURIComponent(dbName + sName))).replace(/[^a-z0-9]/gi, "");
                const storeDiv = document.createElement('div');
                storeDiv.className = 'store-item';
                storeDiv.innerHTML = `
                    <div class="store-header">
                        <span>üì¶ <b>${sName}</b></span>
                        <div class="btn-group">
                            <button class="btn-view" onclick="toggleView('${dbName}', '${sName}', '${safeId}')">üëÅÔ∏è View</button>
                            <button class="btn-clear" onclick="clearStore('${dbName}', '${sName}', '${safeId}')">üóëÔ∏è Clear Store</button>
                        </div>
                    </div>
                    <div class="data-viewer" id="view_${safeId}">
                        <div id="content_${safeId}"></div>
                    </div>
                `;
                dbCard.appendChild(storeDiv);
            });
            resultsEl.appendChild(dbCard);
            db.close();
        };
    }

    function toggleView(dbName, storeName, safeId) {
        const viewer = document.getElementById(`view_${safeId}`);
        if (viewer.style.display === "block") {
            viewer.style.display = "none";
            return;
        }

        const contentBox = document.getElementById(`content_${safeId}`);
        contentBox.innerHTML = "<div style='padding:10px'>ƒêang t·∫£i d·ªØ li·ªáu...</div>";
        viewer.style.display = "block";

        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction(storeName, "readonly");
            const store = tx.objectStore(storeName);
            const cursorReq = store.openCursor();
            
            contentBox.innerHTML = "";
            let count = 0;

            cursorReq.onsuccess = (ev) => {
                const cursor = ev.target.result;
                if (cursor) {
                    count++;
                    const key = cursor.key;
                    const value = cursor.value;
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'record-card';
                    
                    let valueDisplay = "";
                    if (value instanceof Blob) {
                        const url = URL.createObjectURL(value);
                        const isAudio = value.type.includes('audio');
                        valueDisplay = `
                            <div class="audio-ctrl">
                                <span style="font-size:11px; color:#666">Blob [${value.type}] - ${(value.size/1024).toFixed(2)} KB</span>
                                ${isAudio ? `<audio controls src="${url}"></audio>` : ''}
                                <a href="${url}" download="${key}" class="download-link">üíæ T·∫£i v·ªÅ m√°y</a>
                            </div>`;
                    } else {
                        let jsonStr = "";
                        try {
                            const parsed = (typeof value === 'string') ? JSON.parse(value) : value;
                            jsonStr = JSON.stringify(parsed, null, 4);
                        } catch (e) {
                            jsonStr = String(value);
                        }
                        valueDisplay = `<pre class="json-pretty">${jsonStr}</pre>`;
                    }

                    recordDiv.innerHTML = `
                        <div class="record-header">
                            <span>B·∫£n ghi #${count}</span>
                            <button class="btn-del-row" onclick="deleteRow('${dbName}', '${storeName}', '${key}', '${safeId}')">X√≥a d√≤ng</button>
                        </div>
                        <span class="record-key">üîë ${key}</span>
                        <div class="record-value">${valueDisplay}</div>
                    `;
                    contentBox.appendChild(recordDiv);
                    cursor.continue();
                } else if (count === 0) {
                    contentBox.innerHTML = "<div style='text-align:center; padding:20px; color:#999'>Tr·ªëng.</div>";
                }
                db.close();
            };
        };
    }

    function deleteRow(dbName, storeName, key, safeId) {
        if (!confirm(`X√°c nh·∫≠n x√≥a b·∫£n ghi v·ªõi Key: ${key}?`)) return;
        
        writeLog(`ƒêang x√≥a d√≤ng [${key}] trong Store [${storeName}]...`);
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);
            
            store.delete(key);
            tx.oncomplete = () => {
                writeLog(`ƒê√£ x√≥a th√†nh c√¥ng row [${key}].`);
                showToast("ƒê√£ x√≥a 1 b·∫£n ghi");
                db.close();
                document.getElementById(`view_${safeId}`).style.display = "none";
                toggleView(dbName, storeName, safeId);
            };
        };
    }

    function clearStore(dbName, storeName, safeId) {
        if (!confirm(`C·∫¢NH B√ÅO: B·∫°n mu·ªën x√≥a s·∫°ch t·∫•t c·∫£ d·ªØ li·ªáu trong Store [${storeName}]?`)) return;
        
        writeLog(`ƒêang l√†m s·∫°ch Store [${storeName}]...`);
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);
            
            store.clear();
            tx.oncomplete = () => {
                writeLog(`ƒê√£ d·ªçn d·∫πp s·∫°ch Store [${storeName}].`);
                showToast("ƒê√£ x√≥a to√†n b·ªô b·∫£n ghi trong b·∫£ng");
                db.close();
                deepScan();
            };
        };
    }
</script>

</body>
</html>