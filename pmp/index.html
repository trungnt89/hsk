<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master Pro - Persistence & Translate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.96);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: pan-y;
        }

        /* --- HEADER & TABS --- */
        .system-header { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 18px; font-weight: 900; color: var(--text-main); }
        
        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 12px 12px; }
        .tab-pill {
            border: none; padding: 10px 4px; border-radius: 10px; 
            font-size: 11px; font-weight: 700; background: rgba(0,0,0,0.08); 
            color: #3A3A3C; text-align: center; cursor: pointer;
        }
        .tab-pill.active { background: var(--text-main); color: white; }

        /* --- CONTENT AREA --- */
        .content-viewport { flex-grow: 1; position: relative; overflow: hidden; }
        .main-card { 
            position: absolute; inset: 0; background: var(--card); 
            margin: 10px; border-radius: 20px; box-sizing: border-box; 
            overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            padding-bottom: 100px;
        }

        .question-body { padding: 16px; position: relative; }
        
        /* Trạng thái Dễ - Vừa - Khó cố định góc phải */
        .diff-container {
            position: sticky; top: 0; right: 0; float: right;
            display: flex; gap: 4px; z-index: 10; background: white; padding: 5px; border-radius: 10px;
        }
        .diff-btn {
            font-size: 10px; font-weight: 800; padding: 5px 8px; border-radius: 6px;
            border: 1.5px solid #E5E5EA; color: #8E8E93; cursor: pointer;
        }
        .diff-btn.active[data-type="Easy"] { background: var(--easy); color: white; border-color: var(--easy); }
        .diff-btn.active[data-type="Medium"] { background: var(--medium); color: white; border-color: var(--medium); }
        .diff-btn.active[data-type="Hard"] { background: var(--hard); color: white; border-color: var(--hard); }

        .q-text { font-size: 16px; font-weight: 600; line-height: 1.5; color: var(--text-main); margin: 30px 0 20px; }
        .option-item { 
            font-size: 14px; padding: 14px; background: #F2F2F7; border-radius: 14px; 
            margin-bottom: 10px; border: 2.5px solid transparent; 
        }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }

        .note-box { margin-top: 20px; width: 100%; box-sizing: border-box; }
        .note-input {
            width: 100%; min-height: 80px; border-radius: 12px; border: 1px solid #E5E5EA;
            padding: 10px; font-family: inherit; font-size: 13px; background: #FAFAFA; resize: none;
        }

        /* --- TRANSLATION PANEL OVERLAY --- */
        #trans-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 400px; background: #1C1C1E; color: white;
            padding: 20px; z-index: 3000; display: none;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .trans-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .trans-label { font-size: 12px; font-weight: 800; color: var(--easy); }
        .close-btn { color: white; font-size: 24px; cursor: pointer; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            height: 65px; background: var(--ios-blur); backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
    </style>
</head>
<body>

<div id="trans-panel">
    <div class="trans-header">
        <span class="trans-label">DỊCH TIẾNG VIỆT</span>
        <span class="close-btn" onclick="hideTranslate()">×</span>
    </div>
    <div id="trans-content" style="font-size: 16px; line-height: 1.6;"></div>
</div>

<header class="system-header">
    <div class="nav-row">
        <div class="brand">PMP<span>MASTER</span></div>
        <select id="set-select" onchange="changeExamSet(this.value)" style="border:none; font-weight:700; color:var(--primary); background:transparent; font-size: 15px;">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-grid" id="tabs">
        <button class="tab-pill" id="tab-todo" onclick="switchTab('todo')">MỚI</button>
        <button class="tab-pill" id="tab-done" onclick="switchTab('done')">ĐÃ LÀM</button>
        <button class="tab-pill" id="tab-notdone" onclick="switchTab('notdone')">CHƯA LÀM</button>
    </div>
</header>

<main class="content-viewport" id="swipe-area">
    <div id="book-page" class="main-card"></div>
</main>

<nav class="bottom-nav">
    <button class="nav-item" onclick="triggerFlip('prev')">‹<small>TRƯỚC</small></button>
    <button class="nav-item" id="btn-show-ans" onclick="toggleInfo()">◎<small>ĐÁP ÁN</small></button>
    <button class="nav-item" onclick="triggerFlip('next')">›<small>TIẾP</small></button>
</nav>

<script>
// Quản lý trạng thái bằng LocalStorage
let appState = JSON.parse(localStorage.getItem('PMP_APP_STATE')) || {
    lastSet: 'DATA_SET_1',
    lastTab: 'todo',
    userProgress: {} // Cấu trúc: { qid: { selected: 'A', diff: 'Easy', note: '...' } }
};

let pmpData = []; 
let filteredQuestions = []; 
let currentIndex = 0;
let isAnswerShowing = false;

// --- XỬ LÝ DỊCH THUẬT ---
document.addEventListener('selectionchange', () => {
    const text = window.getSelection().toString().trim();
    if (text.length > 2) {
        showTranslate(text);
    }
});

async function showTranslate(text) {
    const panel = document.getElementById('trans-panel');
    const content = document.getElementById('trans-content');
    panel.style.display = 'block';
    content.innerHTML = '<span style="color:#8E8E93">Đang dịch...</span>';
    
    try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
        const data = await res.json();
        content.innerHTML = data[0].map(i => i[0]).join("");
    } catch (e) { content.innerHTML = "Lỗi kết nối dịch thuật."; }
}

function hideTranslate() {
    document.getElementById('trans-panel').style.display = 'none';
    window.getSelection().removeAllRanges();
}

// --- CORE LOGIC ---
function saveState() {
    localStorage.setItem('PMP_APP_STATE', JSON.stringify(appState));
}

function changeExamSet(v) { 
    appState.lastSet = v;
    pmpData = window[v] || [];
    currentIndex = 0;
    saveState();
    updateFilteredData(); 
}

function switchTab(t) { 
    appState.lastTab = t;
    currentIndex = 0;
    saveState();
    updateFilteredData(); 
}

function updateFilteredData() {
    // Cập nhật giao diện Tab
    document.querySelectorAll('.tab-pill').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${appState.lastTab}`).classList.add('active');
    
    // Lọc dữ liệu theo tab
    filteredQuestions = pmpData.filter(q => {
        const prog = appState.userProgress[q.id];
        if (appState.lastTab === 'done') return prog && prog.selected;
        if (appState.lastTab === 'notdone') return prog && !prog.selected;
        return true; // Tab Mới hiện tất cả
    });

    renderQuestion();
}

function renderQuestion() {
    const container = document.getElementById('book-page');
    const q = filteredQuestions[currentIndex];
    if (!q) {
        container.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-sub)">Không có câu hỏi trong mục này.</div>`;
        return;
    }

    const prog = appState.userProgress[q.id] || { selected: null, diff: null, note: '' };
    isAnswerShowing = false;

    container.innerHTML = `
        <div class="question-body">
            <div class="diff-container">
                <div class="diff-btn ${prog.diff === 'Easy' ? 'active' : ''}" data-type="Easy" onclick="setDifficulty(${q.id}, 'Easy')">DỄ</div>
                <div class="diff-btn ${prog.diff === 'Medium' ? 'active' : ''}" data-type="Medium" onclick="setDifficulty(${q.id}, 'Medium')">VỪA</div>
                <div class="diff-btn ${prog.diff === 'Hard' ? 'active' : ''}" data-type="Hard" onclick="setDifficulty(${q.id}, 'Hard')">KHÓ</div>
            </div>

            <div style="color:var(--primary); font-size:12px; font-weight:800;">CÂU ${currentIndex + 1} / ${filteredQuestions.length}</div>
            
            <div class="q-text">${q.question}</div>
            
            <div class="options">
                ${Object.entries(q.options).map(([k,v]) => `
                    <div class="option-item ${prog.selected === k ? 'selected' : ''}" 
                         id="opt-${k}" onclick="toggleOption('${q.id}', '${k}')">
                        <b>${k}.</b> ${v}
                    </div>
                `).join('')}
            </div>

            <div id="explain-box" style="margin-top:20px; display:none;">
                <div style="padding:15px; background:#F2F2F7; border-radius:12px; border-left:4px solid var(--primary); font-size:14px; line-height:1.5;">
                    ${q.explanation}
                </div>
            </div>

            <div class="note-box">
                <textarea class="note-input" placeholder="Ghi chú cho câu hỏi này..." 
                          oninput="saveNote('${q.id}', this.value)">${prog.note || ''}</textarea>
            </div>
        </div>`;
    
    container.scrollTop = 0;
}

function toggleOption(qid, k) {
    if (!appState.userProgress[qid]) appState.userProgress[qid] = {};
    
    // Chế độ Toggle: Nếu click vào cái đã chọn thì bỏ chọn
    if (appState.userProgress[qid].selected === k) {
        appState.userProgress[qid].selected = null;
    } else {
        appState.userProgress[qid].selected = k;
    }
    
    saveState();
    renderQuestion();
}

function setDifficulty(qid, level) {
    if (!appState.userProgress[qid]) appState.userProgress[qid] = {};
    appState.userProgress[qid].diff = level;
    saveState();
    renderQuestion();
}

function saveNote(qid, text) {
    if (!appState.userProgress[qid]) appState.userProgress[qid] = {};
    appState.userProgress[qid].note = text;
    saveState(); // Lưu ngay khi gõ
}

function toggleInfo() {
    const q = filteredQuestions[currentIndex];
    if (!q) return;
    
    isAnswerShowing = !isAnswerShowing;
    const box = document.getElementById('explain-box');
    const correctEl = document.getElementById(`opt-${q.answer}`);
    const btn = document.getElementById('btn-show-ans');

    if (isAnswerShowing) {
        box.style.display = 'block';
        if(correctEl) correctEl.classList.add('is-correct');
        btn.classList.add('active');
    } else {
        box.style.display = 'none';
        if(correctEl) correctEl.classList.remove('is-correct');
        btn.classList.remove('active');
    }
}

function triggerFlip(dir) {
    if (dir === 'next' && currentIndex < filteredQuestions.length - 1) currentIndex++;
    else if (dir === 'prev' && currentIndex > 0) currentIndex--;
    renderQuestion();
}

// Khởi tạo ứng dụng
window.onload = () => {
    document.getElementById('set-select').value = appState.lastSet;
    changeExamSet(appState.lastSet);
};
</script>
</body>
</html>