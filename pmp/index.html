<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Smooth Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.85);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: pan-y; /* Cho phép cuộn dọc tự nhiên */
        }

        /* --- HEADER --- */
        .top-section { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .main-nav { padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .brand { font-size: 18px; font-weight: 900; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); }
        .set-capsule-select {
            border: none; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; 
            background: rgba(0,0,0,0.05); color: var(--primary); outline: none; -webkit-appearance: none;
        }

        .filter-bar { padding: 4px 16px 12px; display: flex; gap: 6px; }
        .tab-btn {
            flex: 1; border: none; padding: 8px 0; border-radius: 10px; font-size: 11px; font-weight: 700; 
            background: #E3E3E6; color: #8E8E93; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-btn[data-type="todo"].active { background: var(--primary); color: white; }
        .tab-btn[data-type="Easy"].active { background: var(--easy); color: white; }
        .tab-btn[data-type="Medium"].active { background: var(--medium); color: white; }
        .tab-btn[data-type="Hard"].active { background: var(--hard); color: white; }

        /* --- TRANG CÂU HỎI (SMOOTH TRANSITION) --- */
        .viewport {
            flex-grow: 1; position: relative; overflow: hidden;
        }

        #slide-container {
            height: 100%; width: 100%; 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform;
        }

        .main-display { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 16px; box-sizing: border-box; overflow-y: auto;
            padding-bottom: 100px;
        }

        .q-card { 
            background: var(--card); border-radius: 24px; padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 0.5px solid rgba(0,0,0,0.05);
        }

        /* Hiệu ứng mờ dần khi chuyển câu */
        .fade-out { opacity: 0; transform: scale(0.95); transition: 0.3s; }
        .fade-in { opacity: 1; transform: scale(1); transition: 0.3s; }

        .option-item { 
            font-size: 15px; padding: 16px; background: #F9F9FB; border-radius: 16px; 
            margin-bottom: 10px; border: 2px solid transparent; transition: 0.2s;
        }
        .option-item.selected { border-color: var(--primary); background: #F0F7FF; color: var(--primary); }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }
        .option-item.is-wrong { background: #FFF2F2 !important; border-color: var(--hard) !important; color: #B71C1C !important; }

        /* --- BOTTOM BAR --- */
        .iphone-bar { 
            height: 70px; background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; }
        .tab-item i { font-style: normal; font-size: 24px; }
        .tab-item small { font-size: 10px; font-weight: 700; }
        .tab-item.active-nav { color: var(--primary); }

        .explanation-box { margin-top: 15px; padding: 15px; background: #F2F2F7; border-radius: 15px; font-size: 14px; border-left: 4px solid var(--primary); }
        .chip { border: none; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; background: #E3E3E6; color: #8E8E93; }
        .chip.active-hard { background: var(--hard) !important; color: white; }
        .chip.active-medium { background: var(--medium) !important; color: white; }
        .chip.active-easy { background: var(--easy) !important; color: white; }
    </style>
</head>
<body>

<div class="top-section">
    <div class="main-nav">
        <div class="brand">PMP<span>MASTER</span></div>
        <select class="set-capsule-select" id="set-select" onchange="changeExamSet(this.value)">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-bar">
        <button class="tab-btn active" data-type="todo" onclick="switchTab('todo')">MỚI</button>
        <button class="tab-btn" data-type="Easy" onclick="switchTab('Easy')">DỄ</button>
        <button class="tab-btn" data-type="Medium" onclick="switchTab('Medium')">VỪA</button>
        <button class="tab-btn" data-type="Hard" onclick="switchTab('Hard')">KHÓ</button>
    </div>
</div>

<div class="viewport">
    <div id="slide-container">
        <div class="main-display" id="display-area"></div>
    </div>
</div>

<div class="iphone-bar">
    <button class="tab-item" id="prev-btn" onclick="prevQuestion()"><i>‹</i><small>Trước</small></button>
    <button class="tab-item" id="info-btn" onclick="toggleInfo()">
        <i id="eye-icon">◎</i><small id="info-txt">Giải thích</small>
    </button>
    <button class="tab-item" id="next-btn" onclick="nextQuestion()"><i>›</i><small>Tiếp</small></button>
</div>

<script>
let pmpData = []; let filteredQuestions = []; let currentIndexInSet = 0; let currentTab = 'todo';
let selectedOption = null; let isConfirmed = false; let currentSetName = ""; 
const STORAGE_PREFIX = "PMP_V13_";

// --- XỬ LÝ VUỐT VỚI HIỆU ỨNG MƯỢT (SWIPE TRANSITION) ---
let touchstartX = 0;
let touchstartY = 0;
const container = document.getElementById('slide-container');

document.addEventListener('touchstart', e => {
    touchstartX = e.changedTouches[0].screenX;
    touchstartY = e.changedTouches[0].screenY;
}, {passive: true});

document.addEventListener('touchend', e => {
    let touchendX = e.changedTouches[0].screenX;
    let touchendY = e.changedTouches[0].screenY;
    
    let diffX = touchendX - touchstartX;
    let diffY = touchendY - touchstartY;

    // Chỉ nhận diện vuốt ngang nếu khoảng cách ngang > dọc (tránh nhầm khi cuộn trang)
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) {
        if (diffX < 0) animateTransition('next');
        else animateTransition('prev');
    }
}, {passive: true});

function animateTransition(direction) {
    if (direction === 'next' && currentIndexInSet < filteredQuestions.length - 1) {
        container.style.transform = 'translateX(-30px)';
        container.style.opacity = '0';
        setTimeout(() => {
            nextQuestion();
            container.style.transform = 'translateX(30px)';
            setTimeout(() => {
                container.style.transform = 'translateX(0)';
                container.style.opacity = '1';
            }, 50);
        }, 200);
    } else if (direction === 'prev' && currentIndexInSet > 0) {
        container.style.transform = 'translateX(30px)';
        container.style.opacity = '0';
        setTimeout(() => {
            prevQuestion();
            container.style.transform = 'translateX(-30px)';
            setTimeout(() => {
                container.style.transform = 'translateX(0)';
                container.style.opacity = '1';
            }, 50);
        }, 200);
    }
}

function changeExamSet(v) {
    let data = window[v] || (typeof eval !== 'undefined' ? eval(v) : null);
    if (data) { pmpData = data; currentSetName = v; currentIndexInSet = 0; updateFilteredData(); }
}

function updateFilteredData() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
        btn.classList.toggle('active', type === currentTab);
    });
    filteredQuestions = pmpData.filter(q => { const lv = stored[q.id]; return currentTab === 'todo' ? !lv : lv === currentTab; });
    renderQuestion();
}

function renderQuestion() {
    const area = document.getElementById('display-area');
    const q = filteredQuestions[currentIndexInSet];
    document.getElementById('prev-btn').style.opacity = (currentIndexInSet === 0) ? "0.1" : "1";
    document.getElementById('next-btn').style.opacity = (currentIndexInSet >= filteredQuestions.length - 1) ? "0.1" : "1";
    
    resetInfoBtn();
    if (!q) { area.innerHTML = `<div style="text-align:center; padding-top:100px; color:var(--text-sub);">HẾT CÂU HỎI</div>`; return; }
    
    selectedOption = null; isConfirmed = false;
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const lv = stored[q.id];

    let opts = '';
    for (const [key, val] of Object.entries(q.options)) {
        opts += `<div class="option-item" id="opt-${key}" onclick="selectOption('${key}')"><b>${key}.</b> ${val}</div>`;
    }

    area.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div style="font-size:12px; font-weight:800; color:var(--text-sub);">CÂU ${currentIndexInSet + 1} / ${filteredQuestions.length}</div>
            <div style="display:flex; gap:5px;">
                <button class="chip ${lv==='Hard'?'active-hard':''}" onclick="updateLevel(this,'${q.id}','Hard')">KHÓ</button>
                <button class="chip ${lv==='Medium'?'active-medium':''}" onclick="updateLevel(this,'${q.id}','Medium')">VỪA</button>
                <button class="chip ${lv==='Easy'?'active-easy':''}" onclick="updateLevel(this,'${q.id}','Easy')">DỄ</button>
            </div>
        </div>
        <div class="q-card">
            <div style="font-size:14px; color:var(--text-sub); margin-bottom:8px;">ID: #${q.id}</div>
            <div class="q-text">${q.question}</div>
            <div class="options-list">${opts}</div>
            <button id="confirm-btn" style="display:none" onclick="confirmAnswer()">KIỂM TRA ĐÁP ÁN</button>
            <div id="explanation-area"></div>
        </div>`;
    area.scrollTo(0,0);
}

function updateLevel(btn, id, lv) {
    const key = STORAGE_PREFIX + currentSetName;
    const stored = JSON.parse(localStorage.getItem(key) || "{}");
    if (stored[id] === lv) delete stored[id]; else stored[id] = lv;
    localStorage.setItem(key, JSON.stringify(stored));
    renderLevelButtons(btn, lv, stored[id]);
    updateTabCountsOnly();
}

function renderLevelButtons(btn, lv, isNew) {
    const parent = btn.parentElement;
    parent.querySelectorAll('.chip').forEach(c => c.classList.remove('active-hard','active-medium','active-easy'));
    if (isNew) btn.classList.add('active-' + lv.toLowerCase());
}

function updateTabCountsOnly() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
    });
}

function selectOption(k) { if(isConfirmed) return; selectedOption = k; document.querySelectorAll('.option-item').forEach(e => e.classList.remove('selected')); document.getElementById(`opt-${k}`).classList.add('selected'); document.getElementById('confirm-btn').style.display = 'block'; }
function confirmAnswer() { if(!selectedOption || isConfirmed) return; showAnswerUI(); }
function showAnswerUI() {
    const q = filteredQuestions[currentIndexInSet];
    isConfirmed = true; 
    document.getElementById('confirm-btn').style.display = 'none';
    document.getElementById('info-btn').classList.add('active-nav');
    document.getElementById('eye-icon').innerText = "◉";
    document.querySelectorAll('.option-item').forEach(e => e.classList.remove('is-correct','is-wrong','selected'));
    if (selectedOption === q.answer) document.getElementById(`opt-${selectedOption}`).classList.add('is-correct');
    else { if(selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('is-wrong'); document.getElementById(`opt-${q.answer}`).classList.add('is-correct'); }
    document.getElementById('explanation-area').innerHTML = `<div class="explanation-box"><b>Giải thích:</b><br>${q.explanation}</div>`;
}

function toggleInfo() {
    if(!isConfirmed) showAnswerUI();
    else { isConfirmed = false; resetInfoBtn(); document.getElementById('explanation-area').innerHTML = ''; document.querySelectorAll('.option-item').forEach(e => e.classList.remove('is-correct','is-wrong')); if (selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('selected'); }
}

function resetInfoBtn() { document.getElementById('info-btn').classList.remove('active-nav'); document.getElementById('eye-icon').innerText = "◎"; }
function switchTab(t) { currentTab = t; currentIndexInSet = 0; updateFilteredData(); }
function nextQuestion() { if(currentIndexInSet < filteredQuestions.length-1) { currentIndexInSet++; renderQuestion(); } }
function prevQuestion() { if(currentIndexInSet > 0) { currentIndexInSet--; renderQuestion(); } }

window.addEventListener('DOMContentLoaded', () => { changeExamSet(document.getElementById('set-select').value); });
</script>
</body>
</html>