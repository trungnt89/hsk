<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master Pro - UI Update</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.96);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: none;
        }

        /* --- HEADER HỆ THỐNG: GRID LAYOUT --- */
        .system-header { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 18px; font-weight: 900; color: var(--text-main); }
        .brand span { color: var(--primary); }
        
        /* 6 Button hiển thị dạng Grid 2x3 */
        .filter-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; 
            padding: 0 12px 12px;
        }

        .tab-pill {
            border: none; padding: 8px 4px; border-radius: 10px; 
            font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.05); 
            color: #3A3A3C; transition: all 0.2s; text-align: center;
        }
        .tab-pill.active { background: var(--text-main); color: white; }

        /* --- VIEWPORT --- */
        .content-viewport { flex-grow: 1; position: relative; overflow: hidden; }

        .main-card { 
            position: absolute; inset: 0; background: var(--card); 
            margin: 10px; border-radius: 20px; box-sizing: border-box; 
            overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
        }

        /* --- HEADER TRONG CÂU HỎI --- */
        .question-sticky-header {
            position: sticky; top: 0; background: var(--card);
            padding: 12px 16px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .q-meta { display: flex; flex-direction: column; }
        .q-id { font-size: 9px; font-weight: 800; color: var(--text-sub); }
        .q-count { font-size: 13px; color: var(--primary); font-weight: 800; }

        .difficulty-segment { display: flex; background: #F2F2F7; padding: 2px; border-radius: 10px; }
        .btn-diff { 
            border: none; padding: 6px 10px; border-radius: 8px; 
            font-size: 9px; font-weight: 800; background: transparent; color: #8E8E93;
        }
        .btn-diff.active-easy { background: var(--easy); color: white; }
        .btn-diff.active-medium { background: var(--medium); color: white; }
        .btn-diff.active-hard { background: var(--hard); color: white; }

        /* --- NỘI DUNG --- */
        .question-body { padding: 16px; }
        .q-text { font-size: 16px; font-weight: 700; line-height: 1.5; color: var(--text-main); margin-bottom: 20px; }
        .option-item { 
            font-size: 14px; padding: 14px; background: #F2F2F7; border-radius: 14px; 
            margin-bottom: 10px; border: 2px solid transparent; 
        }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }
        .option-item.is-wrong { background: #FFF2F2 !important; border-color: var(--hard) !important; color: #B71C1C !important; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            height: 65px; background: var(--ios-blur); backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; }
        .nav-item i { font-style: normal; font-size: 20px; font-weight: bold; }
        .nav-item.active { color: var(--primary); }

        .slide-left { transform: translateX(-100%); opacity: 0; }
        .slide-right { transform: translateX(100%); opacity: 0; }
    </style>
</head>
<body>

<header class="system-header">
    <div class="nav-row">
        <div class="brand">PMP<span>MASTER</span></div>
        <select class="select-capsule" id="set-select" onchange="changeExamSet(this.value)" style="border:none; font-weight:700; color:var(--primary); outline:none;">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-grid">
        <button class="tab-pill active" data-type="todo" onclick="switchTab('todo')">MỚI (0)</button>
        <button class="tab-pill" data-type="done" onclick="switchTab('done')">ĐÃ LÀM (0)</button>
        <button class="tab-pill" data-type="not-done" onclick="switchTab('not-done')">CHƯA (0)</button>
        <button class="tab-pill" data-type="Easy" onclick="switchTab('Easy')">DỄ (0)</button>
        <button class="tab-pill" data-type="Medium" onclick="switchTab('Medium')">VỪA (0)</button>
        <button class="tab-pill" data-type="Hard" onclick="switchTab('Hard')">KHÓ (0)</button>
    </div>
</header>

<main class="content-viewport">
    <div id="book-page" class="main-card"></div>
</main>

<nav class="bottom-nav">
    <button class="nav-item" id="prev-btn" onclick="triggerFlip('prev')"><i>‹</i><small>TRƯỚC</small></button>
    <button class="nav-item" id="info-btn" onclick="toggleInfo()"><i id="eye-icon">◎</i><small>ĐÁP ÁN</small></button>
    <button class="nav-item" id="next-btn" onclick="triggerFlip('next')"><i>›</i><small>TIẾP</small></button>
</nav>

<script>
let pmpData = []; let filteredQuestions = []; let currentIndex = 0; let currentTab = 'todo';
let selectedOption = null; let isConfirmed = false; let currentSetName = ""; 

const STORAGE_LV = "PMP_LV_"; const STORAGE_USER = "PMP_USER_DATA_"; 

function safeParse(key) { try { return JSON.parse(localStorage.getItem(key)) || {}; } catch(e) { return {}; } }

function changeExamSet(v) { 
    currentSetName = v; pmpData = window[v] || []; 
    currentIndex = 0; updateFilteredData(); 
}

function updateTabCounts() {
    const lvData = safeParse(STORAGE_LV + currentSetName);
    const userData = safeParse(STORAGE_USER + currentSetName);
    const counts = { todo: 0, done: 0, 'not-done': 0, Easy: 0, Medium: 0, Hard: 0 };
    
    pmpData.forEach(q => {
        const lv = lvData[q.id]; const ans = userData[q.id]?.ans;
        if (!lv) counts.todo++; else counts[lv]++;
        if (ans) counts.done++; else counts['not-done']++;
    });

    document.querySelectorAll('.tab-pill').forEach(btn => {
        const type = btn.getAttribute('data-type');
        const labels = { todo: "MỚI", done: "ĐÃ LÀM", 'not-done': "CHƯA", Easy: "DỄ", Medium: "VỪA", Hard: "KHÓ" };
        btn.innerText = `${labels[type]} (${counts[type]})`;
        btn.classList.toggle('active', type === currentTab);
    });
}

function updateFilteredData() {
    const lvData = safeParse(STORAGE_LV + currentSetName);
    const userData = safeParse(STORAGE_USER + currentSetName);
    updateTabCounts();

    filteredQuestions = pmpData.filter(q => {
        const lv = lvData[q.id]; const ans = userData[q.id]?.ans;
        if (currentTab === 'todo') return !lv;
        if (currentTab === 'done') return !!ans;
        if (currentTab === 'not-done') return !ans;
        return lv === currentTab;
    });
    renderQuestion();
}

function renderQuestion() {
    const card = document.getElementById('book-page');
    const q = filteredQuestions[currentIndex];
    
    document.getElementById('prev-btn').style.opacity = (currentIndex === 0) ? "0.2" : "1";
    document.getElementById('next-btn').style.opacity = (currentIndex >= filteredQuestions.length - 1) ? "0.2" : "1";
    
    if (!q) { 
        card.innerHTML = `<div style="text-align:center; padding:100px 20px; color:var(--text-sub);">Hết câu hỏi mục này.</div>`; 
        return; 
    }

    const userData = safeParse(STORAGE_USER + currentSetName)[q.id] || { ans: null, note: "" };
    const lvData = safeParse(STORAGE_LV + currentSetName);
    const lv = lvData[q.id];
    selectedOption = userData.ans; isConfirmed = false;
    document.getElementById('eye-icon').innerText = "◎";

    let optionsHtml = Object.entries(q.options).map(([k, v]) => `
        <div class="option-item ${selectedOption === k ? 'selected' : ''}" id="opt-${k}" onclick="selectOption('${k}')">
            <b>${k}.</b> ${v}
        </div>
    `).join('');

    card.innerHTML = `
        <div class="question-sticky-header">
            <div class="q-meta">
                <span class="q-id">ID: #${q.id}</span>
                <span class="q-count">CÂU ${currentIndex + 1} / ${filteredQuestions.length}</span>
            </div>
            <div class="difficulty-segment">
                <button class="btn-diff ${lv==='Easy'?'active-easy':''}" onclick="setLv(this,'${q.id}','Easy')">DỄ</button>
                <button class="btn-diff ${lv==='Medium'?'active-medium':''}" onclick="setLv(this,'${q.id}','Medium')">VỪA</button>
                <button class="btn-diff ${lv==='Hard'?'active-hard':''}" onclick="setLv(this,'${q.id}','Hard')">KHÓ</button>
            </div>
        </div>
        <div class="question-body">
            <div class="q-text">${q.question}</div>
            <div class="options-container">${optionsHtml}</div>
            <div id="explanation-box"></div>
            <div style="height:40px;"></div>
        </div>
    `;
    card.scrollTo(0,0);
}

// Hàm cập nhật độ khó mà không làm mất màn hình
function setLv(btn, id, lv) {
    const key = STORAGE_LV + currentSetName;
    let data = safeParse(key);
    
    // Đảo trạng thái (Nếu bấm vào cái đang chọn thì bỏ chọn)
    data[id] = (data[id] === lv) ? null : lv;
    localStorage.setItem(key, JSON.stringify(data));
    
    // Chỉ cập nhật UI của các nút độ khó ngay lập tức
    const buttons = btn.parentElement.querySelectorAll('.btn-diff');
    buttons.forEach(b => b.className = 'btn-diff');
    if (data[id]) {
        btn.classList.add('active-' + lv.toLowerCase());
    }
    
    // Cập nhật số liệu trên 6 nút lọc phía trên
    updateTabCounts();
}

function selectOption(k) {
    if(isConfirmed) return;
    selectedOption = k;
    document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
    document.getElementById(`opt-${k}`).classList.add('selected');
    let data = safeParse(STORAGE_USER + currentSetName);
    if(!data[filteredQuestions[currentIndex].id]) data[filteredQuestions[currentIndex].id] = {ans:null};
    data[filteredQuestions[currentIndex].id].ans = k;
    localStorage.setItem(STORAGE_USER + currentSetName, JSON.stringify(data));
    updateTabCounts();
}

function triggerFlip(dir) {
    const card = document.getElementById('book-page');
    if (dir === 'next' && currentIndex < filteredQuestions.length - 1) {
        card.classList.add('slide-left');
        setTimeout(() => { currentIndex++; renderQuestion(); resetAnim(card, 'slide-right'); }, 400);
    } else if (dir === 'prev' && currentIndex > 0) {
        card.classList.add('slide-right');
        setTimeout(() => { currentIndex--; renderQuestion(); resetAnim(card, 'slide-left'); }, 400);
    }
}

function resetAnim(el, startClass) {
    el.style.transition = 'none'; el.classList.remove('slide-left', 'slide-right');
    el.classList.add(startClass);
    setTimeout(() => { el.style.transition = ''; el.classList.remove(startClass); }, 50);
}

function toggleInfo() {
    if(isConfirmed) { renderQuestion(); return; }
    const q = filteredQuestions[currentIndex]; if(!q) return;
    isConfirmed = true; document.getElementById('eye-icon').innerText = "◉";
    document.querySelectorAll('.option-item').forEach(el => {
        const key = el.id.split('-')[1];
        if(key === q.answer) el.className = 'option-item is-correct';
        else if(key === selectedOption) el.className = 'option-item is-wrong';
    });
    document.getElementById('explanation-box').innerHTML = `<div style="margin-top:20px; padding:15px; background:#F2F2F7; border-radius:12px; font-size:13px; border-left:4px solid var(--primary);">${q.explanation}</div>`;
}

function switchTab(t) { currentTab = t; currentIndex = 0; updateFilteredData(); }
window.addEventListener('DOMContentLoaded', () => changeExamSet(document.getElementById('set-select').value));
</script>
</body>
</html>