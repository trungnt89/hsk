<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Mastery Matrix V18.3 - Auto Fail Past</title>
    <style>
        :root { 
            --primary: #4f46e5; --success: #10b981; --fail: #ef4444; 
            --bg: #f8fafc; --text: #1e293b; --weekend: #fff1f2; --warning: #f59e0b;
            --danger: #991b1b; --disabled: #e2e8f0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin: auto; max-width: 1300px; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-label { font-weight: 800; font-size: 1.2rem; color: var(--primary); min-width: 160px; text-align: center; }

        /* B·∫£ng l√™n tr√™n */
        .table-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 30px; }
        table { border-collapse: collapse; width: max-content; background: white; }

        .sticky-col { 
            position: sticky; left: 0; z-index: 100; background: #fff; width: 220px; 
            border-right: 3px solid #e2e8f0; padding: 10px; box-shadow: 4px 0 6px -4px rgba(0,0,0,0.1);
            vertical-align: middle;
        }
        
        .habit-name-box { 
            width: 100%; border: none; font-weight: 700; font-size: 14px; 
            color: var(--text); resize: none; background: transparent; outline: none;
            overflow: hidden; display: block; line-height: 1.4; height: auto;
        }

        .day-col { width: 45px; text-align: center; border: 1px solid #f1f5f9; vertical-align: middle; }
        
        .mark { 
            width: 32px; height: 32px; margin: auto; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; background: #f1f5f9; transition: 0.2s; 
        }

        /* V√¥ hi·ªáu h√≥a ng√†y t∆∞∆°ng lai ho√†n to√†n */
        .future-day { opacity: 0.2; cursor: not-allowed !important; pointer-events: none; background: #eceff1 !important; }
        .future-day .mark { display: none; } /* ·∫®n lu√¥n n√∫t b·∫•m ·ªü ng√†y t∆∞∆°ng lai */
        
        .status-done { background: var(--success) !important; color: white; }
        .status-fail { background: var(--fail) !important; color: white; }
        .is-today { background: var(--primary) !important; color: white !important; }
        .weekend { background: var(--weekend) !important; }

        /* Dashboard xu·ªëng d∆∞·ªõi */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 280px; gap: 20px; }
        .chart-container { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 15px; min-height: 160px; }
        
        .chart-row { margin-bottom: 12px; }
        .chart-label { font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block; }
        .bar-bg { background: #f1f5f9; height: 10px; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.6s ease; }

        /* C·∫£nh b√°o ph√¢n c·∫•p */
        .warning-alert { padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 12px; border-left: 5px solid; }
        .warn-yellow { background: #fffbeb; border-color: var(--warning); color: #92400e; }
        .warn-red { background: #fef2f2; border-color: var(--fail); color: #b91c1c; font-weight: 600; }
        .warn-danger { background: #450a0a; border-color: #f87171; color: #fecaca; animation: pulse-danger 1.5s infinite; }

        @keyframes pulse-danger {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); background: #7f1d1d; }
        }

        .btn-delete { color: #cbd5e1; cursor: pointer; font-size: 18px; margin-left: 5px; }
        button { cursor: pointer; border: none; border-radius: 8px; padding: 10px 18px; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-nav { background: #f1f5f9; color: var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <div class="header-area">
        <h2 style="margin:0; color: var(--primary)">‚öîÔ∏è K·ª∑ Lu·∫≠t To√†n Di·ªán V18.3</h2>
        <div style="display:flex; gap:10px; align-items:center">
            <button class="btn-nav" onclick="moveMonth(-1)">‚óÄ</button>
            <div class="month-label" id="mLabel">Th√°ng 01/2026</div>
            <button class="btn-nav" onclick="moveMonth(1)">‚ñ∂</button>
            <button class="btn-primary" onclick="addNewHabit()">+ Th√™m vi·ªác</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>

    <div class="dashboard">
        <div class="chart-container">
            <h4 style="margin:0 0 15px 0">T·ªâ l·ªá ho√†n th√†nh (%)</h4>
            <div id="barCharts"></div>
        </div>
        <div class="chart-container">
            <h4 style="margin:0 0 10px 0">Tr·∫°ng th√°i k·ª∑ lu·∫≠t ‚ö†Ô∏è</h4>
            <div id="streakWarnings"></div>
        </div>
        <div class="chart-container" style="text-align: center; display:flex; flex-direction:column; justify-content:center; background: var(--fail); color: white; border:none">
            <h4 style="margin:0">Y·∫øu nh·∫•t th√°ng ‚ö†Ô∏è</h4>
            <div id="worstHabit" style="font-size: 18px; font-weight: 800; margin: 10px 0; color: #fff">--</div>
            <p style="margin:0; opacity: 0.9; font-size: 11px;">D·ª±a tr√™n d·ªØ li·ªáu th·ª±c t·∫ø</p>
        </div>
    </div>
</div>

<script>
    let habits = [];
    let logs = {};
    let displayDate = new Date();
    const today = new Date(); today.setHours(0,0,0,0);

    const dbName = "MasteryMatrixDB";
    const storeName = "MainStore";
    const dataKey = "matrix_data";

    async function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName);
                }
            };
            request.onsuccess = async (e) => {
                const db = e.target.result;
                const tx = db.transaction(storeName, "readonly");
                const store = tx.objectStore(storeName);
                const res = await new Promise(r => {
                    const req = store.get(dataKey);
                    req.onsuccess = () => r(req.result);
                });
                
                if (res) {
                    habits = res.habits || [];
                    logs = res.logs || {};
                } else {
                    habits = [
                        { id: 1, name: "D·∫≠y s·ªõm 5h" },
                        { id: 2, name: "Ch·∫°y th·ªÉ d·ª•c" }
                    ];
                    logs = {};
                    await save();
                }
                resolve();
            };
        });
    }

    async function save() {
        return new Promise((resolve) => {
            const request = indexedDB.open(dbName, 1);
            request.onsuccess = (e) => {
                const db = e.target.result;
                const tx = db.transaction(storeName, "readwrite");
                const store = tx.objectStore(storeName);
                store.put({ habits, logs }, dataKey);
                tx.oncomplete = () => resolve();
            };
        });
    }

    function cleanFutureData() {
        let changed = false;
        for (let dateKey in logs) {
            const checkDate = new Date(dateKey);
            if (checkDate > today) {
                delete logs[dateKey];
                changed = true;
            }
        }
        if (changed) save();
    }

    function moveMonth(s) { displayDate.setMonth(displayDate.getMonth() + s); render(); }
    async function addNewHabit() { habits.push({ id: Date.now(), name: "Vi·ªác m·ªõi" }); await save(); render(); }
    async function deleteHabit(id) { if(confirm('X√≥a th√≥i quen n√†y?')) { habits = habits.filter(h => h.id !== id); await save(); render(); } }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    async function toggle(dStr, id) {
        const targetDate = new Date(dStr);
        if (targetDate > today) return;

        if(!logs[dStr]) logs[dStr] = {};
        let cur = logs[dStr][id];
        
        // N·∫øu l√† ng√†y qu√° kh·ª© v√† ch∆∞a c√≥ data (ƒëang hi·ªÉn th·ªã gi·∫£ ƒë·ªãnh fail), 
        // click l·∫ßn ƒë·∫ßu s·∫Ω chuy·ªÉn sang 'done'.
        if (targetDate < today && !cur) {
            logs[dStr][id] = 'done';
        } else {
            logs[dStr][id] = (cur === 'done') ? 'fail' : (cur === 'fail' ? null : 'done');
        }
        
        await save(); render();
    }

    function render() {
        cleanFutureData();
        
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        document.getElementById('mLabel').innerText = `Th√°ng ${(month + 1).toString().padStart(2, '0')}/${year}`;

        let worstH = { name: '--', count: 999 };
        let barHtml = '';
        let warningHtml = '';

        habits.forEach(h => {
            let doneCount = 0;
            let currentXStreak = 0;
            let tempStreak = 0;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const checkDate = new Date(year, month, i);
                checkDate.setHours(0,0,0,0);
                const dStr = checkDate.toISOString().split('T')[0];
                let status = logs[dStr]?.[h.id];
                
                // Quy t·∫Øc 1: Qu√° kh·ª© kh√¥ng data = fail
                if (!status && checkDate < today) status = 'fail';

                if (status === 'done') { doneCount++; tempStreak = 0; } 
                else if (status === 'fail') { tempStreak++; } 
                else { tempStreak = 0; }
                
                if (checkDate.getTime() <= today.getTime()) {
                    currentXStreak = tempStreak;
                }
            }

            if(doneCount < worstH.count) worstH = { name: h.name, count: doneCount };
            const pct = Math.round((doneCount / daysInMonth) * 100) || 0;
            
            barHtml += `<div class="chart-row">
                <span class="chart-label">${h.name} (${pct}%)</span>
                <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${pct > 70 ? 'var(--success)' : 'var(--primary)'}"></div></div>
            </div>`;
            
            if (currentXStreak > 3) {
                warningHtml += `<div class="warning-alert warn-danger">üíÄ <b>${h.name}</b>: Chu·ªói l∆∞·ªùi ${currentXStreak} ng√†y. Nguy c∆° b·ªè cu·ªôc!</div>`;
            } else if (currentXStreak === 3) {
                warningHtml += `<div class="warning-alert warn-red">üî¥ <b>${h.name}</b>: C·∫£nh b√°o ƒë·ªè! L∆∞·ªùi 3 ng√†y li√™n ti·∫øp.</div>`;
            } else if (currentXStreak === 2) {
                warningHtml += `<div class="warning-alert warn-yellow">‚ö†Ô∏è <b>${h.name}</b>: ƒê√£ 2 ng√†y ch∆∞a th·ª±c hi·ªán.</div>`;
            }
        });

        document.getElementById('barCharts').innerHTML = barHtml;
        document.getElementById('streakWarnings').innerHTML = warningHtml || '<p style="font-size:12px; color:var(--success)">üî• Phong ƒë·ªô tuy·ªát v·ªùi!</p>';
        document.getElementById('worstHabit').innerText = worstH.name;

        let headHtml = `<tr><th class="sticky-col">M·ª•c ti√™u</th>`;
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i);
            d.setHours(0,0,0,0);
            const isT = d.getTime() === today.getTime();
            const isFuture = d > today;
            
            headHtml += `<th class="day-col ${isT ? 'is-today' : ''} ${d.getDay()%6===0?'weekend':''} ${isFuture?'future-day':''}">
                <div style="font-size:9px">${d.toLocaleDateString('vi-VN',{weekday:'short'}).replace('Th ','T')}</div>
                <b>${i}</b></th>`;
        }
        document.getElementById('tHead').innerHTML = headHtml + `</tr>`;

        let bodyHtml = '';
        habits.forEach(h => {
            bodyHtml += `<tr><td class="sticky-col" style="display:flex; align-items:center;">
                <textarea class="habit-name-box" oninput="autoResize(this)" onchange="h.name=this.value; save(); render();">${h.name}</textarea>
                <span class="btn-delete" onclick="deleteHabit(${h.id})">üóë</span>
            </td>`;
            for(let i=1; i<=daysInMonth; i++) {
                const d = new Date(year, month, i);
                d.setHours(0,0,0,0);
                const dStr = d.toISOString().split('T')[0];
                let st = logs[dStr]?.[h.id] || '';
                const isFuture = d > today;

                // Quy t·∫Øc 1 √°p d·ª•ng cho hi·ªÉn th·ªã Table
                if (!st && d < today) st = 'fail';

                bodyHtml += `<td class="day-col ${d.getDay()%6===0?'weekend':''} ${isFuture?'future-day':''}">
                    <div class="mark status-${st}" onclick="toggle('${dStr}', ${h.id})">${st==='done'?'‚úì':(st==='fail'?'‚úï':'')}</div>
                </td>`;
            }
            bodyHtml += `</tr>`;
        });
        document.getElementById('tBody').innerHTML = bodyHtml;
        document.querySelectorAll('.habit-name-box').forEach(el => autoResize(el));
    }

    initDB().then(() => render());
</script>
</body>
</html>