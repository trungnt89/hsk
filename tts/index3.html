<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS API Debugger</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; line-height: 1.6; background: #f4f7f6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        #console { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 6px; height: 300px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 13px; }
        .log-info { color: #a6e22e; }    /* Xanh l√°: Th√†nh c√¥ng/Th√¥ng tin */
        .log-warn { color: #fd971f; }    /* Cam: Azure/C·∫£nh b√°o */
        .log-error { color: #f92672; }   /* ƒê·ªè: L·ªói */
        .log-gas { color: #66d9ef; }     /* Xanh bi·ªÉn: GAS/Drive */
        .source-tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-top: 10px; font-weight: bold; }
        .tag-drive { background: #28a745; color: white; }
        .tag-azure { background: #fd7e14; color: white; }
    </style>
</head>
<body>

    <h2>üõ† TTS API Debugger (Vercel + Drive)</h2>

    <div class="card">
        <div class="form-group">
            <label>VƒÉn b·∫£n (Text):</label>
            <textarea id="text" rows="2">ÂÖàÊó•„ÅØÂ§öÂ§ß„Å™„Çã„ÅîÊîØÊè¥„Å®„Åî</textarea>
        </div>
        <div class="form-group">
            <label>Gi·ªçng ƒë·ªçc (Voice):</label>
            <select id="voice">
                <option value="ja-JP-KeitaNeural">ja-JP-KeitaNeural (Nam)</option>
                <option value="ja-JP-NanamiNeural">ja-JP-NanamiNeural (N·ªØ)</option>
                <option value="zh-CN-XiaoxiaoNeural">zh-CN-XiaoxiaoNeural (Trung)</option>
            </select>
        </div>
        <button onclick="testAPI()">üöÄ Ch·∫°y Test API</button>
        <div id="sourceIndicator"></div>
    </div>

    <div class="card">
        <label>Live Console Logs:</label>
        <div id="console"></div>
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 15px; display: none;"></audio>
    </div>

    <script>
        const logContainer = document.getElementById('console');
        const audioPlayer = document.getElementById('audioPlayer');
        const sourceIndicator = document.getElementById('sourceIndicator');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.className = `log-${type}`;
            div.innerHTML = `[${time}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testAPI() {
            // Reset UI
            logContainer.innerHTML = '';
            sourceIndicator.innerHTML = '';
            audioPlayer.style.display = 'none';

            const text = document.getElementById('text').value;
            const voice = document.getElementById('voice').value;
            const lang = voice.substring(0, 5);

            // 1. M√¥ ph·ªèng vi·ªác t·∫°o filename (Base64) gi·ªëng nh∆∞ server
            const rawKey = `${text}_${lang}_${voice}_1.0`;
            const filename = btoa(unescape(encodeURIComponent(rawKey))).substring(0, 50);
            
            log(`Kh·ªüi t·∫°o Request: "${text.substring(0, 15)}..."`, 'info');
            log(`M√£ h√≥a Filename (Base64): ${filename}`, 'info');

            const startTime = performance.now();
            const apiUrl = `/api/tts?text=${encodeURIComponent(text)}&lang=${lang}&voice=${voice}&rate=1.0`;

            try {
                log(`ƒêang g·ªçi Vercel API: ${apiUrl}`, 'info');
                
                const response = await fetch(apiUrl);
                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // 2. Ki·ªÉm tra Header X-Audio-Source t·ª´ API tr·∫£ v·ªÅ
                const source = response.headers.get('X-Audio-Source');
                
                if (response.ok) {
                    log(`API ph·∫£n h·ªìi sau ${duration}s`, 'info');
                    
                    if (source === 'Google-Drive') {
                        log(`‚ö° K·∫æT QU·∫¢: L·∫•y th√†nh c√¥ng t·ª´ GOOGLE DRIVE (File c√≥ s·∫µn)`, 'gas');
                        sourceIndicator.innerHTML = '<span class="source-tag tag-drive">NGU·ªíN: GOOGLE DRIVE</span>';
                    } else {
                        log(`‚òÅÔ∏è K·∫æT QU·∫¢: L·∫•y t·ª´ AZURE CLOUD (V·ª´a t·∫°o m·ªõi & ƒëang l∆∞u Drive)`, 'warn');
                        sourceIndicator.innerHTML = '<span class="source-tag tag-azure">NGU·ªíN: AZURE CLOUD</span>';
                    }

                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play();
                    
                    log(`Dung l∆∞·ª£ng file: ${(blob.size / 1024).toFixed(2)} KB`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`L·ªói API: ${errorText}`, 'error');
                }

            } catch (err) {
                log(`L·ªói k·∫øt n·ªëi: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>