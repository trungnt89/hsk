<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Reading Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system;
      max-width: 900px;
      margin: auto;
      padding: 12px;
      background: #f5f6f8;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    select, button, input, textarea {
      padding: 6px 8px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    ul {
      padding: 0;
      margin: 0;
    }

    li {
      list-style: none;
      border: 1px solid #ddd;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    li.active {
      background: #e8f0ff;
      border-color: #4a7cff;
    }

    .actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    audio {
      width: 100%;
    }

    @media (max-width: 600px) {
      .row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

<h1>ğŸ“– Japanese Reading Practice</h1>

<!-- SETTINGS -->
<div class="card">
  <div class="row">
    <strong>ğŸ”§ Settings</strong>
  </div>
  <div class="row" style="margin-top:6px">
    <select id="voice">
      <option value="ja-JP-NanamiNeural">Ná»¯ â€“ Nanami</option>
      <option value="ja-JP-KeitaNeural" selected>Nam â€“ Keita</option>
    </select>

    <select id="rate">
      <option value="0.7">Ráº¥t cháº­m</option>
      <option value="0.85">Cháº­m</option>
      <option value="1.0">BÃ¬nh thÆ°á»ng</option>
      <option value="1.1">HÆ¡i nhanh</option>
      <option value="1.25">Nhanh</option>
    </select>
  </div>
</div>

<!-- PLAY CONTROLS -->
<div class="card">
  <div class="row">
    <strong>â–¶ï¸ Playback</strong>
  </div>
  <div class="row" style="margin-top:6px">
    <button onclick="playCurrent()">â–¶ï¸ Äá»c Ä‘oáº¡n</button>
    <button onclick="playAll()">â–¶ï¸â–¶ï¸ Äá»c láº§n lÆ°á»£t</button>
    <button onclick="toggleRepeatOne()">ğŸ”‚ Láº·p 1 Ä‘oáº¡n</button>
    <button onclick="toggleRepeatAll()">ğŸ” Láº·p cáº£ list</button>
  </div>
</div>

<!-- LIST -->
<div class="card">
  <strong>ğŸ“š Danh sÃ¡ch ná»™i dung</strong>
  <ul id="list"></ul>
</div>

<!-- AUDIO -->
<div class="card">
  <strong>ğŸ”Š Audio</strong>
  <audio id="audio" controls></audio>
</div>

<script>
/* ====================== CONFIG ====================== */
const API_URL = "https://hsk-gilt.vercel.app/api/tts1";
const DB_NAME = "tts-audio-cache";
const STORE_NAME = "audio";

/* ====================== SAMPLE TEXT ====================== */
const texts = [
  "æ—¥æœ¬èªã‚’å‹‰å¼·ã™ã‚‹ã“ã¨ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¯æ—¥å°‘ã—ãšã¤ç¶šã‘ã‚Œã°ã€å¿…ãšä¸Šé”ã—ã¾ã™ã€‚å¤§åˆ‡ãªã®ã¯è«¦ã‚ãªã„ã“ã¨ã§ã™ã€‚",
  "ä»•äº‹ãŒå¿™ã—ã„æ™‚ã§ã‚‚ã€çŸ­ã„æ™‚é–“ã‚’è¦‹ã¤ã‘ã¦å‹‰å¼·ã™ã‚‹ã“ã¨ã§ã€è‡ªåˆ†ã®æˆé•·ã‚’å®Ÿæ„Ÿã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚",
  "æ–°ã—ã„è¨€èªã‚’å­¦ã¶ã“ã¨ã¯ã€è€ƒãˆæ–¹ã‚„æ–‡åŒ–ã®é•ã„ã‚’ç†è§£ã™ã‚‹è‰¯ã„æ©Ÿä¼šã«ãªã‚Šã¾ã™ã€‚"
];

let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;

const audio = document.getElementById("audio");
const listEl = document.getElementById("list");

/* ====================== UI ====================== */
renderList();

function renderList() {
  listEl.innerHTML = "";
  texts.forEach((text, i) => {
    const li = document.createElement("li");
    li.textContent = text;
    li.onclick = () => {
      currentIndex = i;
      playCurrent();
    };
    listEl.appendChild(li);
  });
  highlight();
}

function highlight() {
  [...listEl.children].forEach((li, i) => {
    li.classList.toggle("active", i === currentIndex);
  });
}

/* ====================== INDEXED DB ====================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(STORE_NAME);
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = reject;
  });
}

async function getCachedAudio(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result || null);
  });
}

async function saveAudio(key, blob) {
  const db = await openDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).put(blob, key);
}

/* ====================== PLAY LOGIC ====================== */
function buildKey(text) {
  return `ja-JP|${voiceEl().value}|${rateEl().value}|${text}`;
}

function buildUrl(text) {
  return `${API_URL}?text=${encodeURIComponent(text)}`
    + `&lang=ja-JP`
    + `&voice=${voiceEl().value}`
    + `&rate=${rateEl().value}`;
}

async function playCurrent() {
  highlight();
  const text = texts[currentIndex];
  const key = buildKey(text);

  const cached = await getCachedAudio(key);
  if (cached) {
    audio.src = URL.createObjectURL(cached);
    audio.play();
    return;
  }

  const res = await fetch(buildUrl(text));
  const blob = await res.blob();
  await saveAudio(key, blob);

  audio.src = URL.createObjectURL(blob);
  audio.play();
}

function playAll() {
  repeatOne = false;
  playCurrent();
}

function toggleRepeatOne() {
  repeatOne = !repeatOne;
  repeatAll = false;
  alert("Láº·p 1 Ä‘oáº¡n: " + (repeatOne ? "Báº¬T" : "Táº®T"));
}

function toggleRepeatAll() {
  repeatAll = !repeatAll;
  repeatOne = false;
  alert("Láº·p cáº£ danh sÃ¡ch: " + (repeatAll ? "Báº¬T" : "Táº®T"));
}

audio.addEventListener("ended", () => {
  if (repeatOne) return playCurrent();

  currentIndex++;
  if (currentIndex >= texts.length) {
    if (repeatAll) currentIndex = 0;
    else return;
  }
  playCurrent();
});

/* ====================== HELPERS ====================== */
const voiceEl = () => document.getElementById("voice");
const rateEl = () => document.getElementById("rate");
</script>

</body>
</html>
