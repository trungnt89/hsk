<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS Smart Storage</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        #log { background: #1e1e1e; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; border-radius: 8px; margin-top: 15px; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 5px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div style="border: 1px solid #ddd; padding: 20px; border-radius: 10px;">
        <h3>üéôÔ∏è TTS Multi-Layer Cache</h3>
        <input type="text" id="textInput" value="Ch√†o b·∫°n, √¢m thanh n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u ·ªü ba n∆°i.">
        <input type="text" id="fileKey" value="demo_v1">
        <button id="btn" onclick="handleTTS()">PH√ÅT √ÇM THANH</button>
        <div id="log"></div>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxUcnkzBAkguAxlZx3Z3R6dcaYapY46FeXAjxqfrweqPFiBsiUvShZp-BnfPyEpzf0/exec";
    const DB_NAME = "TTS_OFFLINE_CACHE";
    const STORE_NAME = "audio_store";

    function printLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // --- C∆† CH·∫æ INDEXEDDB ---
    async function initDB() {
        return new Promise(r => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME);
            req.onsuccess = e => r(e.target.result);
        });
    }

    // --- H√ÄM PH√ÅT V√Ä CHUY·ªÇN ƒê·ªîI ---
    function playBlob(blob) {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
        audio.onended = () => URL.revokeObjectURL(url);
    }

    function b64ToBlob(b64) {
        const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
        return new Blob([bytes], { type: 'audio/mpeg' });
    }

    // --- QUY TR√åNH CH√çNH ---
    async function handleTTS() {
        const text = document.getElementById('textInput').value;
        const filename = document.getElementById('fileKey').value;
        const btn = document.getElementById('btn');
        btn.disabled = true;

        try {
            // T·∫¶NG 1: Ki·ªÉm tra IndexedDB
            const db = await initDB();
            const localData = await new Promise(r => {
                const req = db.transaction(STORE_NAME).objectStore(STORE_NAME).get(filename);
                req.onsuccess = () => r(req.result);
            });

            if (localData) {
                printLog("‚úÖ L·∫•y t·ª´ IndexedDB (T·ªëc ƒë·ªô 0ms)");
                playBlob(localData);
            } else {
                // T·∫¶NG 2 & 3: G·ªçi Vercel API
                printLog("üîç ƒêang t√¨m tr√™n Drive/Azure...");
                const res = await fetch(`/api/tts?text=${encodeURIComponent(text)}&filename=${filename}`);
                const data = await res.json();

                let finalBlob;

                if (data.source === 'driver') {
                    printLog("‚òÅÔ∏è L·∫•y t·ª´ Google Drive");
                    const proxyRes = await fetch(data.proxyUrl);
                    const b64 = await proxyRes.text();
                    finalBlob = b64ToBlob(b64);
                } else {
                    printLog("üåê L·∫•y t·ª´ Azure (T·∫°o m·ªõi)");
                    finalBlob = b64ToBlob(data.audioData);

                    // ƒê·ªìng b·ªô ng·∫ßm l√™n Drive
                    const bytesArray = Array.from(Uint8Array.from(atob(data.audioData), c => c.charCodeAt(0)));
                    fetch(`${GAS_URL}?fileKey=${encodeURIComponent(data.fileKey)}`, {
                        method: 'POST',
                        body: JSON.stringify(bytesArray),
                        mode: 'no-cors'
                    }).then(() => printLog("üíæ ƒê√£ ƒë·ªìng b·ªô l√™n Drive ng·∫ßm"));
                }

                // L∆∞u v√†o IndexedDB cho l·∫ßn sau
                const tx = db.transaction(STORE_NAME, "readwrite");
                tx.objectStore(STORE_NAME).put(finalBlob, filename);
                playBlob(finalBlob);
            }
        } catch (e) {
            printLog("‚ùå L·ªói: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>