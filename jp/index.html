<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Reading Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system;
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }
    li {
      list-style: none;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 6px;
      cursor: pointer;
    }
    li.active {
      background: #e8f0ff;
      border-color: #4a7cff;
    }
    .controls, .play-modes {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    select, button, textarea {
      padding: 8px;
      font-size: 15px;
    }
    textarea {
      width: 100%;
    }
  </style>
</head>
<body>

<h1>ğŸ“– Japanese Reading Practice (Cached)</h1>

<div class="controls">
  <select id="voice">
    <option value="ja-JP-NanamiNeural">Ná»¯ â€“ Nanami</option>
    <option value="ja-JP-KeitaNeural" selected>Nam â€“ Keita</option>
  </select>

  <select id="rate">
    <option value="0.7">Ráº¥t cháº­m</option>
    <option value="0.85">Cháº­m</option>
    <option value="1.0">BÃ¬nh thÆ°á»ng</option>
    <option value="1.1">HÆ¡i nhanh</option>
    <option value="1.25">Nhanh</option>
  </select>
</div>

<div class="play-modes">
  <button onclick="playCurrent()">â–¶ï¸ Äá»c Ä‘oáº¡n</button>
  <button onclick="playAll()">â–¶ï¸â–¶ï¸ Äá»c láº§n lÆ°á»£t</button>
  <button onclick="toggleRepeatOne()">ğŸ”‚ Láº·p 1 Ä‘oáº¡n</button>
  <button onclick="toggleRepeatAll()">ğŸ” Láº·p cáº£ danh sÃ¡ch</button>
</div>

<div class="controls">
  <textarea id="textInput" rows="4" placeholder="Nháº­p ná»™i dung tiáº¿ng Nháº­t..."></textarea>
  <button onclick="addText()">â• ThÃªm</button>
  <button onclick="updateText()">âœï¸ Sá»­a</button>
  <button onclick="deleteText()">ğŸ—‘ XoÃ¡</button>
</div>

<ul id="list"></ul>

<audio id="audio" controls style="width:100%; margin-top:16px;"></audio>

<script>
/* ====================== CONFIG ====================== */
const API_URL = "https://hsk-gilt.vercel.app/api/tts1";
const DB_NAME = "tts-audio-cache";
const STORE_NAME = "audio";

/* ====================== SAMPLE TEXT (100+ chá»¯) ====================== */
const texts = [
  "æ—¥æœ¬ã§åƒãå§‹ã‚ã¦ã‹ã‚‰ã€æ¯æ—¥ã®ç”Ÿæ´»ãƒªã‚ºãƒ ãŒå¤§ããå¤‰ã‚ã‚Šã¾ã—ãŸã€‚æœã¯æ—©ãèµ·ãã¦é›»è»Šã«ä¹—ã‚Šã€ä¼šç¤¾ã§ã¯å¤šãã®äººã¨å”åŠ›ã—ãªãŒã‚‰ä»•äº‹ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚æœ€åˆã¯è¨€è‘‰ã‚„æ–‡åŒ–ã®é•ã„ã«æˆ¸æƒ‘ã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã—ãŸãŒã€å°‘ã—ãšã¤æ…£ã‚Œã¦ãã¾ã—ãŸã€‚",
  "æ—¥æœ¬èªã®å‹‰å¼·ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¯æ—¥å°‘ã—ãšã¤ç¶šã‘ã‚‹ã“ã¨ãŒå¤§åˆ‡ã ã¨æ€ã„ã¾ã™ã€‚èãåŠ›ã€è©±ã™åŠ›ã€èª­ã‚€åŠ›ã€æ›¸ãåŠ›ã‚’ãƒãƒ©ãƒ³ã‚¹ã‚ˆãä¼¸ã°ã™ã“ã¨ã§ã€å®Ÿéš›ã®ç”Ÿæ´»ã§ã‚‚è‡ªä¿¡ã‚’æŒã£ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚",
  "é€±æœ«ã«ãªã‚‹ã¨ã€å…¬åœ’ã‚’æ•£æ­©ã—ãŸã‚Šã€æœ¬ã‚’èª­ã‚“ã ã‚Šã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚å¿™ã—ã„æ—¥å¸¸ã®ä¸­ã§ã‚‚ã€è‡ªåˆ†ã®å¿ƒã¨ä½“ã‚’ä¼‘ã‚ã‚‹æ™‚é–“ã‚’æŒã¤ã“ã¨ãŒã€é•·ãé ‘å¼µã‚‹ãŸã‚ã«ã¯å¿…è¦ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚"
];

let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;

const audio = document.getElementById("audio");
const listEl = document.getElementById("list");
const textInput = document.getElementById("textInput");

/* ====================== SETTINGS ====================== */
function saveSettings() {
  localStorage.setItem("voice", voiceEl().value);
  localStorage.setItem("rate", rateEl().value);
}

function loadSettings() {
  const v = localStorage.getItem("voice");
  const r = localStorage.getItem("rate");
  if (v) voiceEl().value = v;
  if (r) rateEl().value = r;
}

voiceEl().addEventListener("change", saveSettings);
rateEl().addEventListener("change", saveSettings);

/* ====================== TEXT STORAGE ====================== */
function saveTexts() {
  localStorage.setItem("texts", JSON.stringify(texts));
}

function loadTexts() {
  const saved = localStorage.getItem("texts");
  if (saved) {
    texts.length = 0;
    JSON.parse(saved).forEach(t => texts.push(t));
  }
}

/* ====================== UI ====================== */
loadSettings();
loadTexts();
renderList();

function renderList() {
  listEl.innerHTML = "";
  texts.forEach((text, i) => {
    const li = document.createElement("li");
    li.textContent = text;
    li.onclick = () => {
      currentIndex = i;
      textInput.value = text;
      playCurrent();
    };
    listEl.appendChild(li);
  });
  highlight();
}

function highlight() {
  [...listEl.children].forEach((li, i) => {
    li.classList.toggle("active", i === currentIndex);
  });
}

/* ====================== CRUD ====================== */
function addText() {
  const v = textInput.value.trim();
  if (!v) return;
  texts.push(v);
  saveTexts();
  renderList();
}

function updateText() {
  if (texts[currentIndex]) {
    texts[currentIndex] = textInput.value;
    saveTexts();
    renderList();
  }
}

function deleteText() {
  if (texts[currentIndex]) {
    texts.splice(currentIndex, 1);
    currentIndex = 0;
    saveTexts();
    renderList();
  }
}

/* ====================== INDEXED DB ====================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(STORE_NAME);
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = reject;
  });
}

async function getCachedAudio(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result || null);
  });
}

async function saveAudio(key, blob) {
  const db = await openDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).put(blob, key);
}

/* ====================== PLAY LOGIC ====================== */
function buildKey(text) {
  return `ja-JP|${voiceEl().value}|${rateEl().value}|${text}`;
}

function buildUrl(text) {
  return `${API_URL}?text=${encodeURIComponent(text)}`
    + `&lang=ja-JP`
    + `&voice=${voiceEl().value}`
    + `&rate=${rateEl().value}`;
}

async function playCurrent() {
  highlight();
  const text = texts[currentIndex];
  const key = buildKey(text);

  const cached = await getCachedAudio(key);
  if (cached) {
    audio.src = URL.createObjectURL(cached);
    audio.play();
    return;
  }

  const res = await fetch(buildUrl(text));
  const blob = await res.blob();
  await saveAudio(key, blob);

  audio.src = URL.createObjectURL(blob);
  audio.play();
}

function playAll() {
  repeatOne = false;
  playCurrent();
}

function toggleRepeatOne() {
  repeatOne = !repeatOne;
  repeatAll = false;
  alert("Láº·p 1 Ä‘oáº¡n: " + (repeatOne ? "Báº¬T" : "Táº®T"));
}

function toggleRepeatAll() {
  repeatAll = !repeatAll;
  repeatOne = false;
  alert("Láº·p cáº£ danh sÃ¡ch: " + (repeatAll ? "Báº¬T" : "Táº®T"));
}

audio.addEventListener("ended", () => {
  if (repeatOne) return playCurrent();
  currentIndex++;
  if (currentIndex >= texts.length) {
    if (repeatAll) currentIndex = 0;
    else return;
  }
  playCurrent();
});

/* ====================== HELPERS ====================== */
function voiceEl() {
  return document.getElementById("voice");
}
function rateEl() {
  return document.getElementById("rate");
}
</script>

</body>
</html>
