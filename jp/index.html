<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Reading Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../com/assistive.js"></script>
  <script src="../com/TTSClient.js"></script>
  <style>
    body { font-family: system-ui, -apple-system; max-width: 900px; margin: auto; padding: 16px; background: #fcfcfc; }
    li { list-style: none; border: 1px solid #ddd; padding: 12px; margin-top: 8px; cursor: pointer; border-radius: 8px; background: white; transition: 0.2s; display: flex; flex-direction: column; gap: 4px; }
    li:hover { border-color: #aaa; }
    li.active { background: #e8f0ff; border-color: #4a7cff; font-weight: bold; }
    .vi-text { font-size: 0.85em; color: #666; font-weight: normal; font-style: italic; }
    
    .controls, .play-modes { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .section-box { border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    select, button, textarea { padding: 10px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #fff; transition: 0.2s; font-weight: 500; }
    button:active { transform: translateY(1px); }
    button.active { background: #2563eb !important; color: white !important; border-color: #1d4ed8 !important; }
    textarea { width: 100%; box-sizing: border-box; font-family: inherit; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<h3>üìñ Reading Practice</h3>

<div class="section-box controls">
  <select id="voice">
    <option value="ja-JP-NanamiNeural">N·ªØ ‚Äì Nanami</option>
    <option value="ja-JP-KeitaNeural" selected>Nam ‚Äì Keita</option>
  </select>

  <select id="rate">
    <option value="0.7">R·∫•t ch·∫≠m</option>
    <option value="0.85">Ch·∫≠m</option>
    <option value="1.0" selected>B√¨nh th∆∞·ªùng</option>
    <option value="1.1">H∆°i nhanh</option>
    <option value="1.25">Nhanh</option>
  </select>
</div>

<div class="section-box play-modes">
  <button id="btnPlayCur" onclick="playCurrent()">‚ñ∂Ô∏è ƒê·ªçc ƒëo·∫°n</button>
  <button id="btnRepeatOne" onclick="toggleRepeatOne()">üîÇ L·∫∑p 1 ƒëo·∫°n</button>
  <button id="btnRepeatAll" onclick="toggleRepeatAll()">üîÅ L·∫∑p c·∫£ danh s√°ch</button>
  <button onclick="openEditor()" style="margin-left:auto; background: #f1f5f9;">‚öôÔ∏è S·ª≠a n·ªôi dung</button>
</div>

<div id="editorModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">Qu·∫£n l√Ω n·ªôi dung</h3>
    <textarea id="textInput" rows="6" placeholder="Nh·∫≠p n·ªôi dung ti·∫øng Nh·∫≠t..."></textarea>
    <div class="controls" style="margin-top:15px; justify-content: flex-end;">
      <button onclick="addText()" style="background: #ecfdf5; color: #059669;">‚ûï Th√™m m·ªõi</button>
      <button onclick="updateText()" style="background: #eff6ff; color: #2563eb;">‚úèÔ∏è L∆∞u s·ª≠a</button>
      <button onclick="deleteText()" style="color: #dc2626;">üóë Xo√°</button>
      <button onclick="closeEditor()" style="margin-left: 10px;">ƒê√≥ng</button>
    </div>
  </div>
</div>

<ul id="list"></ul>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyNX96iC37hc8AunT8zWlG_yTFB2ipZp90-XivW8hWzVYVne9nftCC3mSFoTk10v93t/exec";

let texts = [];
let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;

const listEl = document.getElementById("list");
const textInput = document.getElementById("textInput");

function loadSettings() {
  const v = localStorage.getItem("voice");
  const r = localStorage.getItem("rate");
  if (v) voiceEl().value = v;
  if (r) rateEl().value = r;
  repeatOne = localStorage.getItem("repeatOne") === "true";
  repeatAll = localStorage.getItem("repeatAll") === "true";
  updateButtonStates();
}

function updateButtonStates() {
  document.getElementById("btnRepeatOne").classList.toggle("active", repeatOne);
  document.getElementById("btnRepeatAll").classList.toggle("active", repeatAll);
}

function setPlayBtnActive(isActive) {
  document.getElementById("btnPlayCur").classList.toggle("active", isActive);
}

voiceEl().addEventListener("change", () => localStorage.setItem("voice", voiceEl().value));
rateEl().addEventListener("change", () => localStorage.setItem("rate", rateEl().value));

function openEditor() {
  textInput.value = texts[currentIndex]?.ja || "";
  document.getElementById("editorModal").style.display = "flex";
}
function closeEditor() { document.getElementById("editorModal").style.display = "none"; }

/* ====================== DATA STORAGE (GAS API) ====================== */
async function loadTexts() {
  try {
    const cacheBuster = `?_t=${new Date().getTime()}`;
    const res = await fetch(GAS_URL + cacheBuster);
    const data = await res.json();
    texts = Array.isArray(data) ? data.filter(item => item.ja && !item.ja.toString().startsWith("Error:")) : [];
    renderList();
  } catch (e) { console.error("LOG: Error fetching texts", e); }
}

async function callGas(data) {
  return fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(data) });
}

function renderList() {
  listEl.innerHTML = "";
  texts.forEach((item, i) => {
    const li = document.createElement("li");
    li.innerHTML = `<div>${item.ja}</div><div class="vi-text">${item.vi}</div>`;
    li.onclick = () => { currentIndex = i; playCurrent(); };
    listEl.appendChild(li);
  });
  highlight();
}

function highlight() {
  [...listEl.children].forEach((li, i) => { li.classList.toggle("active", i === currentIndex); });
}

/* ====================== CRUD ====================== */
async function addText() {
  const v = textInput.value.trim();
  if (!v) return;
  await callGas({ action: "add", text: v });
  setTimeout(loadTexts, 1500); closeEditor();
}
async function updateText() {
  if (texts[currentIndex]) {
    await callGas({ action: "update", index: currentIndex, text: textInput.value });
    setTimeout(loadTexts, 1500); closeEditor();
  }
}
async function deleteText() {
  if (texts[currentIndex] && confirm("X√°c nh·∫≠n xo√°?")) {
    await callGas({ action: "delete", index: currentIndex });
    currentIndex = 0; setTimeout(loadTexts, 1500); closeEditor();
  }
}

/* ====================== PLAY LOGIC (FIXED REPEAT) ====================== */
async function playCurrent() {
  highlight();
  const item = texts[currentIndex];
  if(!item || !item.ja) return;

  console.log(`[TTS Log] ƒêang ph√°t: ${item.ja}`);
  setPlayBtnActive(true);
  
  // Await gi√∫p ƒë·ª£i √¢m thanh k·∫øt th√∫c tr∆∞·ªõc khi ch·∫°y logic ti·∫øp theo
  await speakCommon({
    text: item.ja,
    voice: voiceEl().value,
    rate: rateEl().value,
    filename: "japanese_practice"
  });

  onAudioEnded();
}

function onAudioEnded() {
  setPlayBtnActive(false);
  console.log("[TTS Log] K·∫øt th√∫c √¢m thanh, x·ª≠ l√Ω repeat...");

  if (repeatOne) {
    return playCurrent();
  }
  
  if (repeatAll || currentIndex < texts.length - 1) {
    currentIndex++;
    if (currentIndex >= texts.length) {
      if (repeatAll) currentIndex = 0; else return;
    }
    playCurrent();
  }
}

function toggleRepeatOne() {
  repeatOne = !repeatOne; if(repeatOne) repeatAll = false;
  localStorage.setItem("repeatOne", repeatOne);
  localStorage.setItem("repeatAll", repeatAll);
  updateButtonStates();
}
function toggleRepeatAll() {
  repeatAll = !repeatAll; if(repeatAll) repeatOne = false;
  localStorage.setItem("repeatOne", repeatOne);
  localStorage.setItem("repeatAll", repeatAll);
  updateButtonStates();
}

function voiceEl() { return document.getElementById("voice"); }
function rateEl() { return document.getElementById("rate"); }

loadSettings();
loadTexts();
</script>
</body>
</html>