<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discipline Tracker - Vercel</title>
    <style>
      body { 
        font-family: 'Segoe UI', Tahoma, sans-serif; 
        margin: 0; 
        padding: 4px; 
        background: #fafafa; 
      }
      .grid-card-container { 
        background: white; 
        border-radius: 8px; 
        padding: 4px;
        overflow-x: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }
      .title-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 8px;
        background: linear-gradient(90deg, #fff0f6, #e6f7ff);
        border-radius: 6px;
        margin-bottom: 6px;
      }
      .title-text { font-size: 12px; font-weight: 800; color: #555; }
      .update-tag { font-size: 9px; color: #888; }
      
      .grid-table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0 4px; 
      }
      .grid-table th { 
        font-size: 10px; 
        color: #7f8c8d; 
        padding: 4px; 
        min-width: 38px;
        text-align: center;
        border-right: 1px solid rgba(0,0,0,0.05);
      }
      .grid-table td { 
        padding: 6px 2px; 
        vertical-align: middle;
        text-align: center;
        border-right: 1px solid rgba(0,0,0,0.03);
        font-size: 11px;
      }
      .grid-table td:last-child, .grid-table th:last-child { border-right: none; }

      .row-done { background-color: #fff0f6 !important; border-left: 5px solid #ff85c0 !important; }
      .row-running { background-color: #e6f7ff !important; border-left: 5px solid #69c0ff !important; }
      .row-force { background-color: #fff7e6 !important; border-left: 5px solid #ffa940 !important; }

      .grid-table tr td:first-child { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
      .grid-table tr td:last-child { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }

      .task-col { 
        position: relative;
        min-width: 130px;
        max-width: 180px;
        padding-right: 22px !important;
        text-align: left !important;
        padding-left: 8px !important;
        cursor: pointer;
      }

      .task-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;  
        overflow: hidden;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-weight: 700; 
        font-size: 11px; 
        color: #333;
        line-height: 1.3;
        pointer-events: none;
      }

      .task-text.expanded { display: block; -webkit-line-clamp: unset; }

      .expand-btn {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        background: rgba(0,0,0,0.2);
        border-radius: 3px;
        font-size: 10px;
      }

      .cell-icon { 
        position: relative;
        width: 18px; 
        height: 18px; 
        line-height: 18px; 
        border-radius: 50%; 
        display: inline-block; 
        font-weight: 900; 
        font-size: 10px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .cell-icon::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 12px;
        background: rgba(44, 62, 80, 0.98);
        color: #fff;
        font-size: 10px;
        font-weight: normal;
        border-radius: 5px;
        white-space: pre-wrap;
        width: max-content;
        max-width: 140px;
        visibility: hidden;
        opacity: 0;
        transition: all 0.15s ease;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        line-height: 1.4;
        text-align: left;
        pointer-events: none;
      }

      .cell-icon::before {
        content: "";
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: rgba(44, 62, 80, 0.98);
        visibility: hidden;
        opacity: 0;
        transition: all 0.15s ease;
        z-index: 9999;
        pointer-events: none;
      }

      .cell-icon:hover::after, .cell-icon:hover::before,
      .cell-icon:active::after, .cell-icon:active::before {
        visibility: visible;
        opacity: 1;
      }

      .icon-done { background: #52c41a; color: white; }    
      .icon-notdone { background: #ff4d4f; color: white; } 
      .icon-force { background: #fa8c16; color: white; }

      .legend {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        justify-content: center;
        padding: 8px;
        background: #f0f2f5;
        border-radius: 6px;
      }
      .legend-item { 
        font-size: 11px; 
        display: flex; 
        align-items: center; 
        gap: 5px; 
        font-weight: bold; 
        color: #444; 
      }
    </style>
  </head>
  <body>

    <div class="grid-card-container">
      <div class="title-bar">
        <span class="title-text">✨ THEO DÕI KỶ LUẬT</span>
        <span id="sync-time" class="update-tag">...</span>
      </div>

      <div id="grid-container">Đang tải dữ liệu từ Cloud...</div>

      <div class="legend">
        <div class="legend-item"><span class="cell-icon icon-done" style="width:14px;height:14px;line-height:14px;font-size:8px;">✓</span> Xong</div>
        <div class="legend-item"><span class="cell-icon icon-notdone" style="width:14px;height:14px;line-height:14px;font-size:8px;">✗</span> Chưa</div>
        <div class="legend-item"><span class="cell-icon icon-force" style="width:14px;height:14px;line-height:14px;font-size:8px;">!</span> Dừng</div>
      </div>
    </div>

    <script>
      // URL BACKEND CỦA BẠN (Cần deploy lại GAS sau khi thêm hàm doGet)
      const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxvY66MHgos5E_dYYw6YbV4HxFJrOGKD433_uHc6ybR0gdCBgeGnAByjQYZq5i604Pg/exec";

      function toggleTask(id) {
        console.log("Hành động: Đóng/Mở task " + id);
        const el = document.getElementById('text-' + id);
        const btn = document.getElementById('btn-' + id);
        if (!el) return;
        if (el.classList.contains('expanded')) {
          el.classList.remove('expanded');
          if (btn) btn.innerText = '+';
        } else {
          el.classList.add('expanded');
          if (btn) btn.innerText = '-';
        }
      }

      function formatTime(val) {
        if (!val || val === '--:--' || val === 'null') return '--:--';
        if (val instanceof Date) {
          return val.getHours().toString().padStart(2, '0') + ':' + val.getMinutes().toString().padStart(2, '0');
        }
        let s = String(val);
        if (s.includes('T')) {
          const d = new Date(s);
          return isNaN(d.getTime()) ? s : d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
        }
        if (s.length >= 4 && s.includes(':')) {
           let parts = s.split(':');
           return parts[0].padStart(2, '0') + ':' + parts[1].substring(0,2).padStart(2, '0');
        }
        return s;
      }

      async function loadGrid() {
        console.log("Hệ thống: Đang đồng bộ dữ liệu từ Google Sheets API...");
        try {
          const response = await fetch(`${GAS_API_URL}?action=getDashboardData`);
          const data = await response.json();

          if (!data || !data.tasks) return;
          const keys = Object.keys(data.tasks[0] || {}).filter(k => k.match(/^\d{2}\/\d{2}$/)).sort();
          
          const activeTasks = data.tasks
            .filter(t => String(t.Status) === "1")
            .sort((a, b) => (formatTime(a.Start)).localeCompare(formatTime(b.Start)));
          
          const now = new Date();
          const d = String(now.getDate()).padStart(2, '0'), m = String(now.getMonth() + 1).padStart(2, '0');
          const todayKey = keys.find(k => k === (d+'/'+m) || k === (m+'/'+d)) || keys[keys.length-1];

          let html = '<table class="grid-table"><thead><tr><th style="width:45px">Bắt đầu</th><th class="task-col">Nhiệm vụ</th>';
          keys.forEach(k => { html += `<th>${k}</th>`; });
          html += '</tr></thead><tbody>';

          activeTasks.forEach((t, index) => {
            const taskContent = t.TaskContent || '';
            const taskId = 'task_' + index;
            const isLong = taskContent.length > 20 || taskContent.includes('\n');
            const todayVal = String(t[todayKey] || "").toLowerCase();
            let rowCls = "row-running"; 
            if (todayVal.includes("done")) rowCls = "row-done";
            else if (todayVal.includes("stop")) rowCls = "row-force";

            html += `<tr class="${rowCls}">
              <td style="font-weight:bold; color:#555;">${formatTime(t.Start)}</td>
              <td class="task-col" onclick="toggleTask('${taskId}')">
                <div id="text-${taskId}" class="task-text">${taskContent}</div>
                ${isLong ? `<span id="btn-${taskId}" class="expand-btn">+</span>` : ''}
              </td>`;
            
            keys.forEach(k => {
              const rawVal = String(t[k] || "").trim();
              const val = rawVal.toLowerCase();
              let icon = '✗', cls = 'icon-notdone'; 
              if (val.includes("done")) { icon = '✓'; cls = 'icon-done'; }
              else if (val.includes("stop")) { icon = '!'; cls = 'icon-force'; }
              html += `<td><span class="cell-icon ${cls}" data-tooltip="${rawVal || 'N/A'}" onclick="void(0)">${icon}</span></td>`;
            });
            html += '</tr>';
          });
          
          html += '</tbody></table>';
          document.getElementById('grid-container').innerHTML = html;
          document.getElementById('sync-time').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch (error) {
          console.error("Lỗi:", error);
          document.getElementById('grid-container').innerText = "Không thể kết nối Backend.";
        }
      }

      window.onload = loadGrid;
      setInterval(loadGrid, 30000);
    </script>
  </body>
</html>