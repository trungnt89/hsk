<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master Pro - Final Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.96);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: pan-y;
        }

        /* --- HEADER --- */
        .system-header { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-size: 18px; font-weight: 900; color: var(--text-main); }
        .brand span { color: var(--primary); }
        
        .filter-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 0 12px 12px;
            overflow-x: auto;
        }

        .tab-pill {
            border: none; padding: 8px 4px; border-radius: 10px; 
            font-size: 10px; font-weight: 700; background: rgba(0,0,0,0.05); 
            color: #3A3A3C; text-align: center; white-space: nowrap;
        }
        .tab-pill.active { background: var(--text-main); color: white; }

        /* --- VIEWPORT --- */
        .content-viewport { flex-grow: 1; position: relative; overflow: hidden; }

        .main-card { 
            position: absolute; inset: 0; background: var(--card); 
            margin: 10px; border-radius: 20px; box-sizing: border-box; 
            overflow-y: auto; box-shadow: 0 8px 25px rgba(0,0,0,0.05);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
        }

        .question-sticky-header {
            position: sticky; top: 0; background: var(--card);
            padding: 12px 16px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .q-meta { display: flex; flex-direction: column; }
        .q-id { font-size: 9px; font-weight: 800; color: var(--text-sub); }
        .q-count { font-size: 13px; color: var(--primary); font-weight: 800; }

        .difficulty-segment { display: flex; background: #F2F2F7; padding: 2px; border-radius: 10px; }
        .btn-diff { 
            border: none; padding: 6px 10px; border-radius: 8px; 
            font-size: 9px; font-weight: 800; background: transparent; color: #8E8E93;
        }
        .btn-diff.active-easy { background: var(--easy); color: white; }
        .btn-diff.active-medium { background: var(--medium); color: white; }
        .btn-diff.active-hard { background: var(--hard); color: white; }

        .question-body { padding: 16px; }
        .q-text { font-size: 16px; font-weight: 700; line-height: 1.5; color: var(--text-main); margin-bottom: 20px; }
        
        .option-item { 
            font-size: 14px; padding: 14px; background: #F2F2F7; border-radius: 14px; 
            margin-bottom: 10px; border: 2px solid transparent; 
        }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }
        .option-item.is-wrong { background: #FFF2F2 !important; border-color: var(--hard) !important; color: #B71C1C !important; }

        /* --- TOOLTIP DỊCH (DARK MODE - HIỆN PHÍA DƯỚI) --- */
        #trans-tooltip {
            position: fixed; display: none; z-index: 9999;
            background: #1C1C1E; color: #FFF; border-radius: 12px;
            padding: 12px 16px; font-size: 14px; line-height: 1.5;
            max-width: 280px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateX(-50%);
            pointer-events: auto;
        }
        #trans-tooltip::before {
            content: ''; position: absolute; bottom: 100%; left: 50%;
            margin-left: -8px; border-width: 8px; border-style: solid;
            border-color: transparent transparent #1C1C1E transparent;
        }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            height: 65px; background: var(--ios-blur); backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; }

        .slide-left { transform: translateX(-100%); opacity: 0; }
        .slide-right { transform: translateX(100%); opacity: 0; }
    </style>
</head>
<body>

<div id="trans-tooltip"></div>

<header class="system-header">
    <div class="nav-row">
        <div class="brand">PMP<span>MASTER</span></div>
        <select id="set-select" onchange="changeExamSet(this.value)" style="border:none; font-weight:700; color:var(--primary); background:transparent;">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-grid" id="tab-container"></div>
</header>

<main class="content-viewport" id="swipe-area">
    <div id="book-page" class="main-card"></div>
</main>

<nav class="bottom-nav">
    <button class="nav-item" onclick="triggerFlip('prev')"><i>‹</i><small>TRƯỚC</small></button>
    <button class="nav-item" onclick="toggleInfo()"><i id="eye-icon">◎</i><small>ĐÁP ÁN</small></button>
    <button class="nav-item" onclick="triggerFlip('next')"><i>›</i><small>TIẾP</small></button>
</nav>

<script>
// --- KHAI BÁO BIẾN TOÀN CỤC ---
let pmpData = []; let filteredQuestions = []; let currentIndex = 0; 
let currentTab = localStorage.getItem('PMP_LAST_TAB') || 'todo';
let currentSetName = localStorage.getItem('PMP_LAST_SET') || 'DATA_SET_1';
let selectedOption = null; let isConfirmed = false;
let touchStartX = 0; let touchStartY = 0; let touchStartTime = 0;

const STORAGE_LV = "PMP_LV_"; const STORAGE_USER = "PMP_USER_DATA_"; 
const tooltip = document.getElementById('trans-tooltip');
const swipeArea = document.getElementById('swipe-area');

function safeParse(key) { try { return JSON.parse(localStorage.getItem(key)) || {}; } catch(e) { return {}; } }

// --- 1. LOGIC DỊCH (NÉ MENU HỆ THỐNG) ---
document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const text = selection.toString().trim();
    
    if (text && text.length > 1 && text.length < 600) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        tooltip.style.display = 'block';
        // Đặt phía dưới vùng chọn để không bị menu iOS che
        tooltip.style.top = `${rect.bottom + window.scrollY + 15}px`;
        tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
        tooltip.innerHTML = '<span style="color:#8E8E93; font-size:12px;">Đang dịch...</span>';
        
        clearTimeout(window.transDebounce);
        window.transDebounce = setTimeout(() => fetchTranslate(text), 500);
    } else {
        tooltip.style.display = 'none';
    }
});

async function fetchTranslate(text) {
    try {
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`;
        const res = await fetch(url);
        const data = await res.json();
        const result = data[0].map(item => item[0]).join("");
        tooltip.innerHTML = `<div style="color:var(--easy); font-weight:800; font-size:10px; margin-bottom:4px; border-bottom:1px solid #333;">DỊCH NHANH</div>${result}`;
    } catch (err) { tooltip.innerHTML = "Lỗi kết nối dịch."; }
}

// --- 2. LOGIC VUỐT TRANG (ĐÃ SỬA LỖI REFERENCE ERROR) ---
swipeArea.addEventListener('touchstart', e => {
    if (e.target.tagName === 'TEXTAREA') return;
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    touchStartTime = new Date().getTime();
}, {passive: true});

swipeArea.addEventListener('touchend', e => {
    if (e.target.tagName === 'TEXTAREA') return;
    const dx = e.changedTouches[0].screenX - touchStartX;
    const dy = e.changedTouches[0].screenY - touchStartY;
    const duration = new Date().getTime() - touchStartTime;

    // Chỉ chuyển trang nếu: Không bôi đen, vuốt ngang dứt khoát (>100px), nhanh (<300ms)
    if (!window.getSelection().toString() && Math.abs(dx) > 100 && Math.abs(dx) > Math.abs(dy) && duration < 300) {
        triggerFlip(dx < 0 ? 'next' : 'prev');
    }
}, {passive: true});

// --- 3. CORE FUNCTIONS ---
function changeExamSet(v) { 
    currentSetName = v; localStorage.setItem('PMP_LAST_SET', v);
    pmpData = window[v] || []; currentIndex = 0; updateFilteredData(); 
}

function switchTab(t) { 
    currentTab = t; localStorage.setItem('PMP_LAST_TAB', t);
    currentIndex = 0; updateFilteredData(); 
}

function updateTabCounts() {
    const lvData = safeParse(STORAGE_LV + currentSetName);
    const userData = safeParse(STORAGE_USER + currentSetName);
    const counts = { todo: 0, done: 0, 'not-done': 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => {
        const lv = lvData[q.id]; const ans = userData[q.id]?.ans;
        if (!lv) counts.todo++; else counts[lv]++;
        if (ans) counts.done++; else counts['not-done']++;
    });
    
    const tabs = [
        {id: 'todo', label: 'MỚI'}, {id: 'done', label: 'ĐÃ LÀM'}, {id: 'not-done', label: 'CHƯA'},
        {id: 'Easy', label: 'DỄ'}, {id: 'Medium', label: 'VỪA'}, {id: 'Hard', label: 'KHÓ'}
    ];
    
    document.getElementById('tab-container').innerHTML = tabs.map(t => `
        <button class="tab-pill ${currentTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">
            ${t.label} (${counts[t.id]})
        </button>`).join('');
}

function updateFilteredData() {
    updateTabCounts();
    const lvData = safeParse(STORAGE_LV + currentSetName);
    const userData = safeParse(STORAGE_USER + currentSetName);
    filteredQuestions = pmpData.filter(q => {
        const lv = lvData[q.id]; const ans = userData[q.id]?.ans;
        if (currentTab === 'todo') return !lv;
        if (currentTab === 'done') return !!ans;
        if (currentTab === 'not-done') return !ans;
        return lv === currentTab;
    });
    renderQuestion();
}

function renderQuestion() {
    const card = document.getElementById('book-page');
    const q = filteredQuestions[currentIndex];
    if (!q) { card.innerHTML = `<div style="text-align:center; padding:100px 20px; color:var(--text-sub);">Hết câu hỏi.</div>`; return; }

    const userData = safeParse(STORAGE_USER + currentSetName)[q.id] || { ans: null, note: "" };
    const lv = safeParse(STORAGE_LV + currentSetName)[q.id];
    selectedOption = userData.ans; isConfirmed = false;
    document.getElementById('eye-icon').innerText = "◎";

    card.innerHTML = `
        <div class="question-sticky-header">
            <div class="q-meta"><span class="q-id">ID: #${q.id}</span><span class="q-count">CÂU ${currentIndex + 1} / ${filteredQuestions.length}</span></div>
            <div class="difficulty-segment">
                <button class="btn-diff ${lv==='Easy'?'active-easy':''}" onclick="setLv(this,'${q.id}','Easy')">DỄ</button>
                <button class="btn-diff ${lv==='Medium'?'active-medium':''}" onclick="setLv(this,'${q.id}','Medium')">VỪA</button>
                <button class="btn-diff ${lv==='Hard'?'active-hard':''}" onclick="setLv(this,'${q.id}','Hard')">KHÓ</button>
            </div>
        </div>
        <div class="question-body">
            <div class="q-text">${q.question}</div>
            <div class="options-container">
                ${Object.entries(q.options).map(([k, v]) => `
                    <div class="option-item ${selectedOption === k ? 'selected' : ''}" id="opt-${k}" onclick="selectOption('${k}')">
                        <b>${k}.</b> ${v}
                    </div>`).join('')}
            </div>
            <div id="explanation-box"></div>
            <div class="note-section">
                <textarea class="note-input" placeholder="Ghi chú..." oninput="saveNote('${q.id}', this.value)">${userData.note || ''}</textarea>
            </div>
            <div style="height:80px;"></div>
        </div>`;
    card.scrollTo(0,0);
}

function selectOption(k) {
    if(isConfirmed) return;
    selectedOption = k;
    document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
    document.getElementById(`opt-${k}`).classList.add('selected');
    let data = safeParse(STORAGE_USER + currentSetName);
    if(!data[filteredQuestions[currentIndex].id]) data[filteredQuestions[currentIndex].id] = {ans:null, note:""};
    data[filteredQuestions[currentIndex].id].ans = k;
    localStorage.setItem(STORAGE_USER + currentSetName, JSON.stringify(data));
    updateTabCounts();
}

function triggerFlip(dir) {
    const card = document.getElementById('book-page');
    const animClass = dir === 'next' ? 'slide-left' : 'slide-right';
    const nextIndex = dir === 'next' ? currentIndex + 1 : currentIndex - 1;
    
    if (nextIndex >= 0 && nextIndex < filteredQuestions.length) {
        card.classList.add(animClass);
        setTimeout(() => {
            currentIndex = nextIndex;
            renderQuestion();
            card.style.transition = 'none';
            card.classList.remove('slide-left', 'slide-right');
            card.classList.add(dir === 'next' ? 'slide-right' : 'slide-left');
            setTimeout(() => {
                card.style.transition = '';
                card.classList.remove('slide-left', 'slide-right');
            }, 50);
        }, 400);
    }
}

function toggleInfo() {
    if(isConfirmed) { renderQuestion(); return; }
    const q = filteredQuestions[currentIndex]; if(!q) return;
    isConfirmed = true; document.getElementById('eye-icon').innerText = "◉";
    document.querySelectorAll('.option-item').forEach(el => {
        const key = el.id.split('-')[1];
        if(key === q.answer) el.className = 'option-item is-correct';
        else if(key === selectedOption) el.className = 'option-item is-wrong';
    });
    document.getElementById('explanation-box').innerHTML = `<div style="margin-top:20px; padding:15px; background:#F2F2F7; border-radius:12px; font-size:13px; border-left:4px solid var(--primary);">${q.explanation}</div>`;
}

function setLv(btn, id, lv) {
    const key = STORAGE_LV + currentSetName; let data = safeParse(key);
    data[id] = (data[id] === lv) ? null : lv;
    localStorage.setItem(key, JSON.stringify(data));
    updateTabCounts();
    renderQuestion();
}

function saveNote(id, val) {
    let data = safeParse(STORAGE_USER + currentSetName);
    if(!data[id]) data[id] = {ans: null, note: ""};
    data[id].note = val;
    localStorage.setItem(STORAGE_USER + currentSetName, JSON.stringify(data));
}

window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('set-select').value = currentSetName;
    changeExamSet(currentSetName);
});
</script>
</body>
</html>