<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS Test - IndexedDB Cache</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background: #f4f7f6; max-width: 600px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; }
        #log { margin-top: 20px; padding: 15px; background: #1e1e1e; color: #00ff00; font-family: monospace; font-size: 12px; border-radius: 6px; height: 150px; overflow-y: auto; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; }
        .local { background: #fff3cd; color: #856404; }
        .cloud { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>

<div class="card">
    <h2>üéôÔ∏è Azure TTS Test System</h2>
    
    <div class="form-group">
        <label>VƒÉn b·∫£n:</label>
        <textarea id="text" rows="3">Ch√†o b·∫°n, t√¥i l√† tr·ª£ l√Ω ·∫£o ƒë∆∞·ª£c t·ªëi ∆∞u t·ªëc ƒë·ªô.</textarea>
    </div>

    <div class="form-group">
        <label>M√£ ƒë·ªãnh danh (Filename/ID):</label>
        <input type="text" id="filename" value="welcome_01">
    </div>

    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label>Gi·ªçng ƒë·ªçc:</label>
            <select id="voice">
                <option value="vi-VN-HoaiMyNeural">Ho√†i My (N·ªØ)</option>
                <option value="vi-VN-NamMinhNeural">Nam Minh (Nam)</option>
                <option value="zh-CN-XiaoxiaoNeural">Xiaoxiao (Trung)</option>
            </select>
        </div>
        <div>
            <label>T·ªëc ƒë·ªô:</label>
            <input type="number" id="rate" value="1.0" step="0.1" min="0.5" max="2.0">
        </div>
    </div>

    <button id="btnPlay" onclick="startTTS()">PH√ÅT & L∆ØU CACHE</button>
    <div id="log"></div>
</div>

<script>
    const DB_NAME = "TTS_OFFLINE_DB";
    const STORE_NAME = "audio_store";

    // 1. Ghi log hi·ªÉn th·ªã
    function writeLog(msg, isLocal = false) {
        const log = document.getElementById('log');
        const badge = isLocal ? '<span class="status-badge local">INDEXED_DB</span>' : '<span class="status-badge cloud">AZURE_API</span>';
        log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${badge} ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    // 2. Kh·ªüi t·∫°o IndexedDB
    async function initDB() {
        return new Promise((resolve) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
            req.onsuccess = (e) => resolve(e.target.result);
        });
    }

    // 3. Quy tr√¨nh x·ª≠ l√Ω ch√≠nh
    async function startTTS() {
        const text = document.getElementById('text').value;
        const filename = document.getElementById('filename').value;
        const voice = document.getElementById('voice').value;
        const rate = document.getElementById('rate').value;
        const btn = document.getElementById('btnPlay');

        btn.disabled = true;
        const db = await initDB();

        try {
            // T·∫¶NG 1: KI·ªÇM TRA TRONG INDEXEDDB
            const cachedBlob = await new Promise(r => {
                const req = db.transaction(STORE_NAME, "readonly").objectStore(STORE_NAME).get(filename);
                req.onsuccess = () => r(req.result);
            });

            if (cachedBlob) {
                writeLog("T√¨m th·∫•y file trong m√°y. Ph√°t ngay!", true);
                playAudio(cachedBlob);
            } else {
                // T·∫¶NG 2: G·ªåI API VERCEL (STREAM)
                writeLog("Kh√¥ng c√≥ cache. ƒêang g·ªçi Azure...");
                
                const query = new URLSearchParams({ text, filename, voice, rate });
                const response = await fetch(`/api/tts?${query.toString()}`);

                if (!response.ok) throw new Error("API tr·∫£ v·ªÅ l·ªói ho·∫∑c Server ch∆∞a c·∫•u h√¨nh ENV");

                // Nh·∫≠n d·ªØ li·ªáu d∆∞·ªõi d·∫°ng Blob t·ª´ stream
                const audioBlob = await response.blob();

                // L∆∞u v√†o IndexedDB
                const tx = db.transaction(STORE_NAME, "readwrite");
                tx.objectStore(STORE_NAME).put(audioBlob, filename);
                
                writeLog("ƒê√£ t·∫£i xong v√† l∆∞u v√†o b·ªô nh·ªõ.");
                playAudio(audioBlob);
            }
        } catch (e) {
            writeLog("L·ªñI: " + e.message);
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    function playAudio(blob) {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
        audio.onended = () => URL.revokeObjectURL(url);
    }
</script>

</body>
</html>