<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Notify Manager</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; padding-bottom: 270px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-blue { background: #4facfe; color: white; }
        .btn-green { background: #55efc4; }
        .btn-red { background: #ff7675; color: white; }
        .btn-gray { background: #636e72; color: white; }
        #mobile-console { position: fixed; bottom: 0; left: 0; width: 100%; height: 250px; background: #1e2124; color: #a2fca2; padding: 15px; font-family: monospace; font-size: 11px; overflow-y: auto; box-sizing: border-box; border-top: 3px solid #4facfe; }
    </style>
</head>
<body>

<div class="card">
    <h3>üîî Qu·∫£n l√Ω Th√¥ng b√°o</h3>
    <button class="btn-green" onclick="requestPerm()">1. C·∫§P QUY·ªÄN</button>
    <button class="btn-blue" onclick="triggerTest()">2. G·ª¨I TEST</button>
    <button id="toggleBtn" class="btn-red" onclick="toggleStatus(false)">3. T·∫ÆT TH√îNG B√ÅO</button>
    <button class="btn-gray" onclick="uninstallSW()">4. G·ª† B·ªé H·ªÜ TH·ªêNG (RESET)</button>
</div>

<div id="mobile-console"><div>--- Debug Console ---</div></div>

<script>
    const addLog = (m, t="info") => {
        const d = document.createElement('div');
        d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
        d.style.color = t === "error" ? "#ff7675" : (t === "warn" ? "#fdcb6e" : "#a2fca2");
        document.getElementById('mobile-console').appendChild(d);
        document.getElementById('mobile-console').scrollTop = 99999;
    };

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(() => addLog("SW: Ready"));
        navigator.serviceWorker.addEventListener('message', e => {
            if (e.data.action === 'log_from_sw') addLog(e.data.message, e.data.logType);
        });
    }

    async function requestPerm() {
        const p = await Notification.requestPermission();
        addLog("Quy·ªÅn: " + p, p === 'granted' ? 'info' : 'error');
    }

    function triggerTest() {
        navigator.serviceWorker.controller?.postMessage({ action: 'test_notify_now' });
    }

    function toggleStatus(val) {
        navigator.serviceWorker.controller?.postMessage({ action: 'set_notify_status', value: val });
        const btn = document.getElementById('toggleBtn');
        if (val) {
            btn.innerText = "3. T·∫ÆT TH√îNG B√ÅO";
            btn.className = "btn-red";
            btn.onclick = () => toggleStatus(false);
        } else {
            btn.innerText = "3. B·∫¨T L·∫†I TH√îNG B√ÅO";
            btn.className = "btn-green";
            btn.onclick = () => toggleStatus(true);
        }
    }

    async function uninstallSW() {
        const regs = await navigator.serviceWorker.getRegistrations();
        for (let r of regs) await r.unregister();
        addLog("ƒê√£ h·ªßy ƒëƒÉng k√Ω. Vui l√≤ng t·∫£i l·∫°i trang!", "warn");
    }
</script>
</body>
</html>