<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>TTS System - Stable Version</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; line-height: 1.5; }
        .card { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; height: 250px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; margin-top: 15px; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        .info-msg { color: #5bc0de; }
        .success-msg { color: #5cb85c; }
        .error-msg { color: #d9534f; }
    </style>
</head>
<body>

<div class="card">
    <h2>TTS Audio Manager</h2>
    <input type="text" id="inputText" value="Chào bạn, đây là thử nghiệm phát nhạc qua Proxy.">
    <input type="text" id="filename" value="proxy_test_01">
    <button id="btn" onclick="executeProcess()">PHÁT & ĐỒNG BỘ</button>
    <div id="log"></div>
</div>

<script>
    const GAS_URL = "URL_WEB_APP_MỚI_CỦA_BẠN"; // PHẢI CẬP NHẬT URL SAU KHI DEPLOY

    function addLog(msg, className = '') {
        const log = document.getElementById('log');
        log.innerHTML += `<div class="${className}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    async function playFromProxy(proxyUrl) {
        addLog("Đang tải stream qua Proxy GAS...", "info-msg");
        const resp = await fetch(proxyUrl);
        const base64Data = await resp.text(); // GAS Proxy trả về chuỗi Base64
        const audioSrc = `data:audio/mpeg;base64,${base64Data}`;
        const audio = new Audio(audioSrc);
        return audio.play();
    }

    async function executeProcess() {
        const text = document.getElementById('inputText').value;
        const filename = document.getElementById('filename').value;
        const btn = document.getElementById('btn');
        btn.disabled = true;

        addLog("--- Bắt đầu quy trình ---");

        try {
            // 1. Gọi Vercel
            const vercelUrl = `/api/tts?text=${encodeURIComponent(text)}&voice=vi-VN-HoaiMyNeural&rate=1.0&filename=${filename}`;
            const res = await fetch(vercelUrl);
            const data = await res.json();

            if (data.source === 'driver') {
                addLog("DATABASE: Tìm thấy link. Đang phát từ Drive...", "success-msg");
                await playFromProxy(data.url);
            } 
            else {
                addLog("AZURE: Tạo file mới. Đang phát...", "info-msg");
                
                // Chuyển Base64 từ Vercel sang mảng Byte để lưu
                const binary = atob(data.audioData);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                // Phát ngay lập tức từ Blob nội bộ (Không bị 403)
                const audioBlob = new Blob([bytes], { type: 'audio/mpeg' });
                const audio = new Audio(URL.createObjectURL(audioBlob));
                audio.play();

                // Lưu lên GAS
                addLog("Đang đồng bộ Binary lên Drive...");
                await fetch(`${GAS_URL}?fileKey=${encodeURIComponent(data.fileKey)}`, {
                    method: 'POST',
                    body: JSON.stringify(Array.from(bytes)),
                    mode: 'no-cors'
                });
                addLog("Đồng bộ hoàn tất.", "success-msg");
            }
        } catch (e) {
            addLog("LỖI: " + e.message, "error-msg");
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>