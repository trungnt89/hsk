ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³
NGHIÃŠM Cáº¤M má»i hÃ nh vi sá»­a code ngoÃ i pháº¡m vi yÃªu cáº§u , sá»­ dá»¥ng git diff Ä‘á»ƒ check cho tÃ´i xem vÃ  phÃª duyá»‡t
chá»‰ thá»±c hiá»‡n yÃªu cáº§u dÆ°á»›i Ä‘Ã¢y, náº¿u báº¡n sá»­a src ngoÃ i pháº¡m vi yÃªu cáº§u tÃ´i sáº½ kiá»‡n báº¡n. 
Sau khi Ä‘á»‘i á»©ng cÃ¡c yÃªu cáº§u hÃ£y táº¡o file Ä‘Ã£ sá»­a hoÃ n chá»‰nh
ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³ğŸ”³
1. Chuyá»ƒn Ä‘á»•i html gá»i backend thÃ´ng qua api sá»­ dá»¥ng ajax lÃ  gas 
2. Src Gas hoÃ n chá»‰nh
3. Link sheet lÃ  :  1soOmd462Tzk3NN4pCoMfexXJUfnDLVRqFynO6VaSEW8
4.Link gas : https://script.google.com/macros/s/AKfycbyNX96iC37hc8AunT8zWlG_yTFB2ipZp90-XivW8hWzVYVne9nftCC3mSFoTk10v93t/exec
-------------------
Src gá»‘c cáº§n sá»­a:
-------------------
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Reading Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../assistive.js"></script>
  <style>
    body { font-family: system-ui, -apple-system; max-width: 900px; margin: auto; padding: 16px; background: #fcfcfc; }
    li { list-style: none; border: 1px solid #ddd; padding: 12px; margin-top: 8px; cursor: pointer; border-radius: 8px; background: white; transition: 0.2s; }
    li:hover { border-color: #aaa; }
    li.active { background: #e8f0ff; border-color: #4a7cff; font-weight: bold; }
    
    .controls, .play-modes { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .section-box { border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    
    select, button, textarea { padding: 10px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #fff; transition: 0.2s; font-weight: 500; }
    button:active { transform: translateY(1px); }
    button.active { background: #2563eb !important; color: white !important; border-color: #1d4ed8 !important; }
    
    textarea { width: 100%; box-sizing: border-box; font-family: inherit; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<h1>ğŸ“– Japanese Reading Practice</h1>

<div class="section-box controls">
  <select id="voice">
    <option value="ja-JP-NanamiNeural">Ná»¯ â€“ Nanami</option>
    <option value="ja-JP-KeitaNeural" selected>Nam â€“ Keita</option>
  </select>

  <select id="rate">
    <option value="0.7">Ráº¥t cháº­m</option>
    <option value="0.85">Cháº­m</option>
    <option value="1.0" selected>BÃ¬nh thÆ°á»ng</option>
    <option value="1.1">HÆ¡i nhanh</option>
    <option value="1.25">Nhanh</option>
  </select>
</div>

<div class="section-box play-modes">
  <button id="btnPlayCur" onclick="playCurrent()">â–¶ï¸ Äá»c Ä‘oáº¡n</button>
  <button id="btnRepeatOne" onclick="toggleRepeatOne()">ğŸ”‚ Láº·p 1 Ä‘oáº¡n</button>
  <button id="btnRepeatAll" onclick="toggleRepeatAll()">ğŸ” Láº·p cáº£ danh sÃ¡ch</button>
  <button onclick="openEditor()" style="margin-left:auto; background: #f1f5f9;">âš™ï¸ Sá»­a ná»™i dung</button>
</div>

<div id="editorModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">Quáº£n lÃ½ ná»™i dung</h3>
    <textarea id="textInput" rows="6" placeholder="Nháº­p ná»™i dung tiáº¿ng Nháº­t..."></textarea>
    <div class="controls" style="margin-top:15px; justify-content: flex-end;">
      <button onclick="addText()" style="background: #ecfdf5; color: #059669;">â• ThÃªm má»›i</button>
      <button onclick="updateText()" style="background: #eff6ff; color: #2563eb;">âœï¸ LÆ°u sá»­a</button>
      <button onclick="deleteText()" style="color: #dc2626;">ğŸ—‘ XoÃ¡</button>
      <button onclick="closeEditor()" style="margin-left: 10px;">ÄÃ³ng</button>
    </div>
  </div>
</div>

<ul id="list"></ul>

<audio id="audio" controls style="width:100%; margin-top:16px; border-radius: 8px;"></audio>

<script>
const API_URL = "https://hsk-gilt.vercel.app/api/tts1";
const DB_NAME = "tts-audio-cache";
const STORE_NAME = "audio";

const texts = [
  "æ—¥æœ¬ã§åƒãå§‹ã‚ã¦ã‹ã‚‰ã€æ¯æ—¥ã®ç”Ÿæ´»ãƒªã‚ºãƒ ãŒå¤§ããå¤‰ã‚ã‚Šã¾ã—ãŸã€‚",
  "æ—¥æœ¬èªã®å‹‰å¼·ã¯ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¯æ—¥å°‘ã—ãšã¤ç¶šã‘ã‚‹ã“ã¨ãŒå¤§åˆ‡ã ã¨æ€ã„ã¾ã™ã€‚",
  "é€±æœ«ã«ãªã‚‹ã¨ã€å…¬åœ’ã‚’æ•£æ­©ã—ãŸã‚Šã€æœ¬ã‚’èª­ã‚“ã ã‚Šã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚"
];

let currentIndex = 0;
let repeatOne = false;
let repeatAll = false;

const audio = document.getElementById("audio");
const listEl = document.getElementById("list");
const textInput = document.getElementById("textInput");

/* ====================== SETTINGS & STATE ====================== */
function loadSettings() {
  const v = localStorage.getItem("voice");
  const r = localStorage.getItem("rate");
  if (v) voiceEl().value = v;
  if (r) rateEl().value = r;
  repeatOne = localStorage.getItem("repeatOne") === "true";
  repeatAll = localStorage.getItem("repeatAll") === "true";
  updateButtonStates();
}

function updateButtonStates() {
  document.getElementById("btnRepeatOne").classList.toggle("active", repeatOne);
  document.getElementById("btnRepeatAll").classList.toggle("active", repeatAll);
}

// HÃ m má»›i Ä‘á»ƒ xá»­ lÃ½ tráº¡ng thÃ¡i nÃºt Äá»c Ä‘oáº¡n
function setPlayBtnActive(isActive) {
  document.getElementById("btnPlayCur").classList.toggle("active", isActive);
}

voiceEl().addEventListener("change", () => localStorage.setItem("voice", voiceEl().value));
rateEl().addEventListener("change", () => localStorage.setItem("rate", rateEl().value));

/* ====================== UI MODAL ====================== */
function openEditor() {
  textInput.value = texts[currentIndex] || "";
  document.getElementById("editorModal").style.display = "flex";
}
function closeEditor() { document.getElementById("editorModal").style.display = "none"; }

/* ====================== DATA STORAGE ====================== */
function saveTexts() { localStorage.setItem("texts", JSON.stringify(texts)); }
function loadTexts() {
  const saved = localStorage.getItem("texts");
  if (saved) { texts.length = 0; JSON.parse(saved).forEach(t => texts.push(t)); }
}

loadSettings();
loadTexts();
renderList();

function renderList() {
  listEl.innerHTML = "";
  texts.forEach((text, i) => {
    const li = document.createElement("li");
    li.textContent = text;
    li.onclick = () => { currentIndex = i; playCurrent(); };
    listEl.appendChild(li);
  });
  highlight();
}

function highlight() {
  [...listEl.children].forEach((li, i) => {
    li.classList.toggle("active", i === currentIndex);
  });
}

/* ====================== CRUD ====================== */
function addText() {
  const v = textInput.value.trim();
  if (!v) return;
  texts.push(v);
  saveTexts(); renderList(); closeEditor();
}
function updateText() {
  if (texts[currentIndex]) {
    texts[currentIndex] = textInput.value;
    saveTexts(); renderList(); closeEditor();
  }
}
function deleteText() {
  if (texts[currentIndex]) {
    texts.splice(currentIndex, 1);
    currentIndex = 0;
    saveTexts(); renderList(); closeEditor();
  }
}

/* ====================== INDEXED DB ====================== */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME);
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = reject;
  });
}
async function getCachedAudio(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const req = tx.objectStore(STORE_NAME).get(key);
    req.onsuccess = () => resolve(req.result || null);
  });
}
async function saveAudio(key, blob) {
  const db = await openDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).put(blob, key);
}

/* ====================== PLAY LOGIC ====================== */
function buildKey(text) { return `ja-JP|${voiceEl().value}|${rateEl().value}|${text}`; }
function buildUrl(text) { return `${API_URL}?text=${encodeURIComponent(text)}&lang=ja-JP&voice=${voiceEl().value}&rate=${rateEl().value}`; }

async function playCurrent() {
  highlight();
  const text = texts[currentIndex];
  if(!text) return;
  const key = buildKey(text);
  const cached = await getCachedAudio(key);
  if (cached) {
    audio.src = URL.createObjectURL(cached);
    audio.play();
    return;
  }
  const res = await fetch(buildUrl(text));
  const blob = await res.blob();
  await saveAudio(key, blob);
  audio.src = URL.createObjectURL(blob);
  audio.play();
}

function toggleRepeatOne() {
  repeatOne = !repeatOne; if(repeatOne) repeatAll = false;
  localStorage.setItem("repeatOne", repeatOne);
  localStorage.setItem("repeatAll", repeatAll);
  updateButtonStates();
}
function toggleRepeatAll() {
  repeatAll = !repeatAll; if(repeatAll) repeatOne = false;
  localStorage.setItem("repeatOne", repeatOne);
  localStorage.setItem("repeatAll", repeatAll);
  updateButtonStates();
}

/* Audio Events Ä‘á»ƒ nháº­n biáº¿t tráº¡ng thÃ¡i Ä‘ang phÃ¡t */
audio.addEventListener("play", () => setPlayBtnActive(true));
audio.addEventListener("pause", () => setPlayBtnActive(false));
audio.addEventListener("ended", () => {
  setPlayBtnActive(false);
  if (repeatOne) return playCurrent();
  currentIndex++;
  if (currentIndex >= texts.length) {
    if (repeatAll) currentIndex = 0; else return;
  }
  playCurrent();
});

function voiceEl() { return document.getElementById("voice"); }
function rateEl() { return document.getElementById("rate"); }
</script>
</body>
</html>