<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Debug Notification - Todo Pro</title>
    <style>
        :root { --primary: #4facfe; --bg: #f0f2f5; --text: #2d3436; }
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto; display: flex; flex-direction: column; align-items: center; padding-top: 30px; background: var(--bg); margin: 0; color: var(--text); }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; box-sizing: border-box; }
        h2 { margin-top: 0; color: var(--primary); font-size: 20px; }
        .instruction { font-size: 13px; color: #636e72; margin-bottom: 20px; line-height: 1.5; }
        button { padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 12px; font-size: 15px; transition: transform 0.1s active; }
        button:active { transform: scale(0.98); }
        .btn-test { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4); }
        .btn-perm { background: #55efc4; color: #2d3436; }
        .status { font-size: 12px; color: #636e72; background: #e9ecef; padding: 12px; border-radius: 10px; margin-bottom: 10px; word-break: break-all; }
        
        /* Mobile Console */
        #mobile-console {
            width: 100%; height: 250px; background: #1e2124; color: #a2fca2;
            position: fixed; bottom: 0; left: 0; font-family: "SF Mono", "Courier New", monospace; 
            font-size: 11px; overflow-y: auto; padding: 15px; box-sizing: border-box;
            border-top: 3px solid var(--primary); z-index: 1000;
        }
        .log-error { color: #ff7675; border-left: 2px solid #ff7675; padding-left: 5px; }
        .log-warn { color: #fdcb6e; border-left: 2px solid #fdcb6e; padding-left: 5px; }
        .log-success { color: #55efc4; font-weight: bold; }
        .log-info { border-left: 2px solid var(--primary); padding-left: 5px; opacity: 0.9; }
    </style>
</head>
<body>

<div class="card">
    <h2>üõ†Ô∏è Debug Notification</h2>
    <div class="instruction">
        N·∫øu b·∫•m n√∫t "C·∫•p quy·ªÅn" m√† kh√¥ng th·∫•y g√¨, h√£y ƒë·∫£m b·∫£o b·∫°n ƒëang d√πng <b>HTTPS</b> v√† kh√¥ng d√πng tab ·∫©n danh.
    </div>
    
    <div class="status" id="statusText">ƒêang ki·ªÉm tra tr√¨nh duy·ªát...</div>

    <button class="btn-perm" id="btnPerm" onclick="requestPerm()">1. C·∫§P QUY·ªÄN TH√îNG B√ÅO</button>
    <button class="btn-test" onclick="triggerNow()">2. G·ª¨I TH√îNG B√ÅO TEST</button>
    
    <div style="font-size: 11px; color: #b2bec3; margin-top: 10px;">
        Phi√™n b·∫£n Debug v4.1 - Mobile Console
    </div>
</div>

<div id="mobile-console">
    <div>[H·ªá th·ªëng] ƒêang ƒë·ª£i t∆∞∆°ng t√°c...</div>
</div>

<script>
    const statusText = document.getElementById('statusText');
    const mobileConsole = document.getElementById('mobile-console');

    function addLog(msg, type = "info") {
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.style.marginBottom = "5px";
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        mobileConsole.appendChild(div);
        mobileConsole.scrollTop = mobileConsole.scrollHeight;
    }

    // Ki·ªÉm tra m√¥i tr∆∞·ªùng an to√†n
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
        addLog("C·∫¢NH B√ÅO: B·∫°n ƒëang d√πng HTTP. Notification ch·ªâ ch·∫°y tr√™n HTTPS!", "error");
    }

    // 1. ƒêƒÉng k√Ω Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js?v=' + Date.now()).then(reg => {
            statusText.innerText = "SW: ƒê√£ ƒëƒÉng k√Ω (Active)";
            addLog("Service Worker ƒë√£ s·∫µn s√†ng.");
        }).catch(err => {
            addLog("L·ªói ƒëƒÉng k√Ω SW: " + err, "error");
        });

        // L·∫Øng nghe log t·ª´ SW
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.action === 'log_from_sw') {
                addLog(`[SW] ${event.data.message}`, event.data.logType);
            }
        });
    } else {
        addLog("Tr√¨nh duy·ªát KH√îNG h·ªó tr·ª£ Service Worker!", "error");
    }

    // 2. H√†m c·∫•p quy·ªÅn (Fix l·ªói treo tr√™n mobile)
    async function requestPerm() {
        addLog("B·∫Øt ƒë·∫ßu y√™u c·∫ßu quy·ªÅn...");
        
        if (!("Notification" in window)) {
            addLog("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Notification API", "error");
            return;
        }

        try {
            // Fix cho c·∫£ Chrome (Promise) v√† Safari c≈© (Callback)
            const permission = await new Promise((resolve, reject) => {
                const promise = Notification.requestPermission((result) => {
                    resolve(result);
                });
                if (promise) {
                    promise.then(resolve).catch(reject);
                }
            });

            statusText.innerText = `Quy·ªÅn hi·ªán t·∫°i: ${permission.toUpperCase()}`;
            addLog(`K·∫øt qu·∫£: ${permission}`, permission === 'granted' ? 'success' : 'warn');

            if (permission === 'denied') {
                addLog("B·∫°n ƒë√£ ch·∫∑n quy·ªÅn. H√£y click v√†o ·ªï kh√≥a tr√™n URL ƒë·ªÉ Reset.", "error");
            }
        } catch (err) {
            addLog("L·ªói th·ª±c thi y√™u c·∫ßu: " + err, "error");
        }
    }

    // 3. H√†m k√≠ch ho·∫°t Test
    function triggerNow() {
        if (!navigator.serviceWorker.controller) {
            addLog("SW ch∆∞a ki·ªÉm so√°t trang (Controller null). H√£y F5 ho·∫∑c vu·ªët xu·ªëng ƒë·ªÉ Reload!", "warn");
            return;
        }
        
        if (Notification.permission !== 'granted') {
            addLog("Ch∆∞a c√≥ quy·ªÅn! H√£y b·∫•m n√∫t 'C·∫•p quy·ªÅn' tr∆∞·ªõc.", "warn");
            return;
        }

        addLog("ƒêang g·ª≠i t√≠n hi·ªáu Test t·ªõi SW...");
        navigator.serviceWorker.controller.postMessage({
            action: 'test_notify_now'
        });
    }
</script>
</body>
</html>