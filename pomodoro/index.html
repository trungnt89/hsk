<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro Pro - Smooth Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        :root {
            --work-bg: #fff5f5; --work-color: #ff5e57;
            --break-bg: #f0fff4; --break-color: #1dd1a1;
            --dark: #1a2a6c; --gray: #95a5a6;
            --work-img: url('https://images.unsplash.com/photo-1499750310107-5fef28a66643?auto=format&fit=crop&q=80&w=1000');
            --break-img: url('https://images.unsplash.com/photo-1473116763249-2faaef81ccda?auto=format&fit=crop&q=80&w=1000');
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
            background-color: #f7f9fb; background-size: cover; background-position: center; transition: 0.5s;
        }

        .app-card, .history-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            width: 100%; max-width: 650px; padding: 25px; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px;
        }

        .timer-display { font-size: 5.5rem; font-weight: 800; color: var(--dark); margin: 10px 0; letter-spacing: -2px; }
        
        .main-btn { width: 100%; padding: 18px; font-size: 1.1rem; font-weight: 700; border: none; border-radius: 20px; cursor: pointer; transition: 0.2s; margin-top: 10px; color: white; }
        #startBtn { background: var(--dark); }
        .btn-reset { background: #27ae60; }
        .btn-stop { background: #e67e22; }
        .btn-mock { background: #8e44ad; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .input-group { display: flex; flex-direction: column; text-align: left; }
        .input-group label { font-size: 10px; font-weight: 800; color: var(--gray); margin-bottom: 5px; }
        select { padding: 12px; border-radius: 12px; border: 2px solid #eee; background: white; font-weight: 600; cursor: pointer; }

        .stats-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box { background: #ffffff; padding: 15px; border-radius: 20px; border: 1px solid #eee; }
        .stat-box small { color: var(--gray); display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        .stat-box b { color: var(--dark); font-size: 16px; display: block; }
        .stat-box i { font-style: normal; font-size: 12px; color: #ff5e57; font-weight: bold; }

        .chart-container { position: relative; height: 320px; width: 100%; margin-top: 10px; overflow: hidden; }
        
        body.work-mode { background-image: var(--work-img); }
        body.break-mode { background-image: var(--break-img); }
    </style>
</head>
<body class="work-mode">

<div class="app-card">
    <div id="status" style="font-weight: 800; color: var(--gray); letter-spacing: 2px;">POMODORO PRO</div>
    <div class="timer-display" id="timer">25:00</div>

    <button id="startBtn" class="main-btn" onclick="toggleTimer()">B·∫ÆT ƒê·∫¶U</button>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <button class="main-btn btn-reset" onclick="resetTimer()">ƒê·∫∑t l·∫°i</button>
        <button class="main-btn btn-stop" onclick="stopTimer()">D·ª´ng</button>
    </div>

    <div class="settings-grid">
        <div class="input-group">
            <label>MUSIC FOCUS (DEMO)</label>
            <select id="workMusic" onchange="previewMusic(this.value)">
                <option value="none">T·∫Øt nh·∫°c</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Lofi Chill 1</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3">Deep Focus</option>
            </select>
        </div>
        <div class="input-group">
            <label>MUSIC BREAK (DEMO)</label>
            <select id="breakMusic" onchange="previewMusic(this.value)">
                <option value="none">T·∫Øt nh·∫°c</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Nature Rain</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Ocean Waves</option>
            </select>
        </div>
    </div>
</div>

<div class="history-card">
    <h3 style="margin:0; color: var(--dark)">üìà XU H∆Ø·ªöNG H·ªåC T·∫¨P</h3>
    <p style="font-size: 11px; color: var(--gray); margin: 5px 0;">D√πng chu·ªôt cu·ªôn ho·∫∑c vu·ªët ƒë·ªÉ xem l·ªãch s·ª≠ 100 ng√†y</p>
    
    <div class="stats-summary">
        <div class="stat-box">
            <small>üèÜ CAO NH·∫§T</small>
            <b id="maxDay">-</b>
            <i id="maxVal">0h 0p</i>
        </div>
        <div class="stat-box">
            <small>üìâ TH·∫§P NH·∫§T</small>
            <b id="minDay">-</b>
            <i id="minVal">0h 0p</i>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="pomoChart"></canvas>
    </div>
    
    <button class="main-btn btn-mock" onclick="generateMockData()">GI·∫¢ L·∫¨P 100 NG√ÄY D·ªÆ LI·ªÜU</button>
</div>

<audio id="bgAudio" loop></audio>
<audio id="alarmAudio"><source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    let timer, isRunning = false, isWorkMode = true, timeLeft = 1500;
    let db, myChart;
    const APP_KEY = "pomodoro_app_data";
    const bgAudio = document.getElementById('bgAudio');

    function btnVibrate() { if (navigator.vibrate) navigator.vibrate(50); }

    function formatTime(totalMinutes) {
        if (!totalMinutes || totalMinutes === 0) return "0p";
        const h = Math.floor(totalMinutes / 60);
        const m = Math.round(totalMinutes % 60);
        return h > 0 ? `${h}h ${m}p` : `${m}p`;
    }

    const request = indexedDB.open("PomoUnifiedDB", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("app_data")) db.createObjectStore("app_data");
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadAndRender();
    };

    async function loadAndRender() {
        const data = await getAppData();
        renderChart(data.totalMinutes || {});
        calculateStats(data.totalMinutes || {});
    }

    function getAppData() {
        return new Promise((res) => {
            const tx = db.transaction("app_data", "readonly");
            const store = tx.objectStore("app_data");
            const req = store.get(APP_KEY);
            req.onsuccess = () => res(req.result ? JSON.parse(req.result) : { history:{}, totalMinutes:{} });
        });
    }

    function previewMusic(url) {
        btnVibrate();
        if (url === 'none') { bgAudio.pause(); } 
        else { bgAudio.src = url; bgAudio.play().catch(()=>{}); }
        if (isRunning) stopTimer();
    }

    function toggleTimer() {
        btnVibrate();
        if (!isRunning) {
            isRunning = true;
            document.getElementById('startBtn').textContent = "T·∫†M D·ª™NG";
            const musicUrl = document.getElementById(isWorkMode ? 'workMusic' : 'breakMusic').value;
            if (musicUrl !== 'none') { bgAudio.src = musicUrl; bgAudio.play().catch(()=>{}); }
            timer = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if (timeLeft <= 0) { clearInterval(timer); triggerAlarm(); }
            }, 1000);
        } else { stopTimer(); }
    }

    function stopTimer() {
        clearInterval(timer);
        isRunning = false;
        bgAudio.pause();
        document.getElementById('startBtn').textContent = "TI·∫æP T·ª§C";
    }

    function updateDisplay() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById('timer').textContent = `${m}:${s < 10 ? '0'+s : s}`;
    }

    function resetTimer() {
        btnVibrate();
        clearInterval(timer); isRunning = false;
        timeLeft = 1500; updateDisplay();
        bgAudio.pause();
        document.getElementById('startBtn').textContent = "B·∫ÆT ƒê·∫¶U";
    }

    function calculateStats(minutesObj) {
        const entries = Object.entries(minutesObj);
        if (entries.length === 0) return;
        const sorted = entries.sort((a, b) => b[1] - a[1]);
        document.getElementById('maxDay').textContent = sorted[0][0];
        document.getElementById('maxVal').textContent = formatTime(sorted[0][1]);
        document.getElementById('minDay').textContent = sorted[sorted.length-1][0];
        document.getElementById('minVal').textContent = formatTime(sorted[sorted.length-1][1]);
    }

    async function generateMockData() {
        btnVibrate();
        const data = { history: {}, totalMinutes: {} };
        const now = new Date();
        for(let i = 0; i < 100; i++) {
            const date = new Date(now);
            date.setDate(now.getDate() - (99 - i)); // S·∫Øp x·∫øp t·ª´ c≈© ƒë·∫øn m·ªõi
            const dateStr = date.toLocaleDateString('sv-SE');
            const randomMins = Math.floor(Math.random() * 500) + 15; 
            data.totalMinutes[dateStr] = randomMins;
            data.history[dateStr] = Math.floor(randomMins / 25);
        }
        const tx = db.transaction("app_data", "readwrite");
        tx.objectStore("app_data").put(JSON.stringify(data), APP_KEY);
        tx.oncomplete = () => loadAndRender();
    }

    function renderChart(minutesObj) {
        const ctx = document.getElementById('pomoChart').getContext('2d');
        const labels = Object.keys(minutesObj).sort();
        const data = labels.map(l => minutesObj[l]);

        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Th·ªùi gian',
                    data: data,
                    borderColor: '#1a2a6c',
                    backgroundColor: 'rgba(26, 42, 108, 0.1)',
                    borderWidth: 3,
                    pointRadius: 2,
                    pointHoverRadius: 6,
                    tension: 0.3, // ƒê∆∞·ªùng cong m∆∞·ª£t
                    fill: true,
                    spanGaps: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, // T·∫Øt animation khi scroll ƒë·ªÉ tr√°nh gi·∫≠t
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `H·ªçc t·∫≠p: ${formatTime(ctx.parsed.y)}`
                        }
                    },
                    zoom: {
                        pan: { enabled: true, mode: 'x', threshold: 10 },
                        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 9 }, maxRotation: 0 } },
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            callback: v => formatTime(v),
                            stepSize: 60,
                            font: { size: 10 }
                        } 
                    }
                }
            }
        });
        
        // Xem 14 ng√†y cu·ªëi m·∫∑c ƒë·ªãnh
        if(labels.length > 0) {
            myChart.zoomScale('x', {min: labels.length - 14, max: labels.length - 1}, 'original');
        }
    }
</script>
</body>
</html>