<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<script src="../assistive.js"></script>
    <title>Mastery Matrix V18.3 - Safari Optimized</title>
    <style>
        :root { 
            --primary: #4f46e5; --success: #10b981; --fail: #ef4444; 
            --bg: #f8fafc; --text: #1e293b; --weekend: #fff1f2; --warning: #f59e0b;
            --danger: #991b1b; --disabled: #e2e8f0;
        }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin: auto; max-width: 1300px; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-label { font-weight: 800; font-size: 1.2rem; color: var(--primary); min-width: 180px; text-align: center; background: #eef2ff; padding: 8px 15px; border-radius: 12px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .card { padding: 15px; border-radius: 12px; }
            .header-area { flex-direction: column; gap: 12px; align-items: stretch; }
            .dashboard { grid-template-columns: 1fr !important; }
            .sticky-col { width: 150px !important; min-width: 150px !important; }
        }

        .table-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 15px; margin-bottom: 30px; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; width: 100%; min-width: max-content; background: white; table-layout: fixed; }
        td, th { border: 1px solid #f1f5f9; height: 55px; overflow: hidden; }

        .sticky-col { 
            position: sticky; left: 0; z-index: 10; background: #fff !important; 
            width: 220px; min-width: 220px; 
            border-right: 4px solid #f1f5f9; padding: 10px;
            -webkit-transform: translateZ(0); 
        }
        
        .habit-name-box { 
            width: 100%; border: none; font-weight: 600; font-size: 13px; 
            color: var(--text); resize: none; background: #f8fafc; outline: none; padding: 5px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
            display: block; line-height: 1.2;
        }

        .day-col { width: 45px; min-width: 45px; text-align: center; }
        .mark { width: 32px; height: 32px; margin: auto; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #f1f5f9; }
        
        .status-done { background: var(--success) !important; color: white; }
        .status-fail { background: var(--fail) !important; color: white; }
        .is-today { background: var(--primary) !important; color: white !important; }

        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 15px; }
        
        .chart-row { margin-bottom: 12px; }
        .chart-label { font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block; }
        .bar-bg { background: #f1f5f9; height: 10px; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.6s ease; }

        .pie-item { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 65px; }
        .pie {
            width: 48px; height: 48px; border-radius: 50%;
            background: conic-gradient(var(--c) calc(var(--p)*1%), rgba(255,255,255,0.2) 0);
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 800; color: #fff;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        .pie-name { font-size: 9px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; opacity: 0.9; text-align: center; }

        .warning-alert { padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 12px; border-left: 5px solid; }
        .warn-danger { background: #450a0a; border-color: #f87171; color: #fecaca; }
        .btn-delete { color: #cbd5e1; cursor: pointer; padding: 0 5px; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 18px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }
        .btn-nav { background: #f1f5f9; color: var(--primary); padding: 10px; border-radius: 8px; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-area">
        <h2 style="margin:0; color: var(--primary)">‚öîÔ∏è K·ª∑ Lu·∫≠t V18.3</h2>
        <div style="display:flex; gap:10px; align-items:center">
            <button class="btn-nav" onclick="moveMonth(-1)">‚óÄ</button>
            <div class="month-label" id="mLabel">Th√°ng --/----</div>
            <button class="btn-nav" onclick="moveMonth(1)">‚ñ∂</button>
            <button class="btn-primary" onclick="addNewHabit()">+ Th√™m</button>
        </div>
    </div>

    <div class="chart-container" style="text-align: center; display:flex; flex-direction:column; background: var(--fail); color: white; border:none; margin-bottom: 25px;">
        <h4 style="margin:0 0 15px 0">HI·ªÜU SU·∫§T TH·ª∞C T·∫æ (SO V·ªöI NG√ÄY ƒê√É QUA) üìä</h4>
        <div id="pieChartsContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 15px;"></div>
        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px;">
            <h4 style="margin:0; font-size: 14px; opacity: 0.9;">Y·∫øu nh·∫•t th√°ng: </h4>
            <div id="worstHabit" style="font-size: 16px; font-weight: 800; color: #fff">--</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>

    <div class="dashboard">
        <div class="chart-container">
            <h4 style="margin:0 0 15px 0">T·ªâ l·ªá ho√†n th√†nh (%)</h4>
            <div id="barCharts"></div>
        </div>
        <div class="chart-container">
            <h4 style="margin:0 0 10px 0">Tr·∫°ng th√°i k·ª∑ lu·∫≠t ‚ö†Ô∏è</h4>
            <div id="streakWarnings"></div>
        </div>
    </div>
</div>

<script>
    let habits = [];
    let logs = {};
    let displayDate = new Date();
    const today = new Date(); today.setHours(0,0,0,0);

    const dbName = "MasteryMatrixDB";
    const storeName = "MainStore";
    const dataKey = "matrix_data";

    async function initDB() {
        return new Promise((resolve) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
            };
            request.onsuccess = async (e) => {
                const db = e.target.result;
                const tx = db.transaction(storeName, "readonly");
                const store = tx.objectStore(storeName);
                const res = await new Promise(r => {
                    const req = store.get(dataKey);
                    req.onsuccess = () => r(req.result);
                });
                if (res) { habits = res.habits || []; logs = res.logs || {}; }
                else { habits = [{ id: 1, name: "D·∫≠y s·ªõm 5h" }, { id: 2, name: "Ch·∫°y th·ªÉ d·ª•c" }]; await save(); }
                resolve();
            };
        });
    }

    async function save() {
        const db = await new Promise((resolve) => {
            const req = indexedDB.open(dbName, 1);
            req.onsuccess = () => resolve(req.result);
        });
        const tx = db.transaction(storeName, "readwrite");
        tx.objectStore(storeName).put({ habits, logs }, dataKey);
    }

    function moveMonth(s) { displayDate.setMonth(displayDate.getMonth() + s); render(); }
    async function addNewHabit() { habits.push({ id: Date.now(), name: "Vi·ªác m·ªõi" }); await save(); render(); }
    async function deleteHabit(id) { if(confirm('X√≥a?')) { habits = habits.filter(h => h.id !== id); await save(); render(); } }
    
    async function toggle(dStr, id) {
        const targetDate = new Date(dStr);
        if (targetDate > today) return;
        if(!logs[dStr]) logs[dStr] = {};
        let cur = logs[dStr][id];
        if (targetDate < today && !cur) logs[dStr][id] = 'done';
        else logs[dStr][id] = (cur === 'done') ? 'fail' : (cur === 'fail' ? null : 'done');
        await save(); render();
    }

    function render() {
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        document.getElementById('mLabel').innerText = `Th√°ng ${(month + 1).toString().padStart(2, '0')}/${year}`;

        let elapsedDays = 0;
        if (year < today.getFullYear() || (year === today.getFullYear() && month < today.getMonth())) {
            elapsedDays = daysInMonth;
        } else if (year === today.getFullYear() && month === today.getMonth()) {
            elapsedDays = today.getDate();
        } else {
            elapsedDays = 0;
        }

        let worstH = { name: '--', count: 999 };
        let barHtml = '';
        let warningHtml = '';
        let pieHtml = '';

        habits.forEach(h => {
            let doneCount = 0;
            let currentXStreak = 0;
            let tempStreak = 0;
            
            for (let i = 1; i <= daysInMonth; i++) {
                const checkDate = new Date(year, month, i); checkDate.setHours(0,0,0,0);
                const dStr = checkDate.toISOString().split('T')[0];
                let status = logs[dStr]?.[h.id];
                if (!status && checkDate < today) status = 'fail';
                if (status === 'done') { doneCount++; tempStreak = 0; } 
                else if (status === 'fail') { tempStreak++; } 
                else tempStreak = 0;
                if (checkDate.getTime() <= today.getTime()) currentXStreak = tempStreak;
            }

            if(doneCount < worstH.count) worstH = { name: h.name, count: doneCount };
            
            const totalPct = Math.round((doneCount / daysInMonth) * 100) || 0;
            barHtml += `<div class="chart-row">
                <span class="chart-label">${h.name} (${totalPct}%)</span>
                <div class="bar-bg"><div class="bar-fill" style="width:${totalPct}%; background:${totalPct > 70 ? 'var(--success)' : 'var(--primary)'}"></div></div>
            </div>`;

            const piePct = elapsedDays > 0 ? Math.round((doneCount / elapsedDays) * 100) : 0;
            let pieColor = piePct >= 80 ? '#10b981' : (piePct >= 60 ? '#f59e0b' : '#ef4444');

            pieHtml += `
                <div class="pie-item">
                    <div class="pie" style="--p:${piePct}; --c:${pieColor}">${piePct}%</div>
                    <div class="pie-name">${h.name}</div>
                </div>`;
            
            if (currentXStreak >= 2) {
                let cls = currentXStreak > 3 ? 'warn-danger' : 'warn-red';
                warningHtml += `<div class="warning-alert ${cls}">‚ö†Ô∏è <b>${h.name}</b>: L∆∞·ªùi ${currentXStreak} ng√†y.</div>`;
            }
        });

        document.getElementById('barCharts').innerHTML = barHtml;
        document.getElementById('streakWarnings').innerHTML = warningHtml || '<p style="font-size:12px; color:var(--success)">üî• Phong ƒë·ªô t·ªët!</p>';
        document.getElementById('worstHabit').innerText = worstH.name;
        document.getElementById('pieChartsContainer').innerHTML = pieHtml;

        // Render Table
        let headHtml = `<tr><th class="sticky-col">M·ª•c ti√™u</th>`;
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i); d.setHours(0,0,0,0);
            headHtml += `<th class="day-col ${d.getTime()===today.getTime()?'is-today':''}">
                <div style="font-size:9px">${d.toLocaleDateString('vi-VN',{weekday:'short'}).replace('Th ','T')}</div>
                <b>${i}</b></th>`;
        }
        document.getElementById('tHead').innerHTML = headHtml + `</tr>`;

        let bodyHtml = '';
        habits.forEach(h => {
            bodyHtml += `<tr><td class="sticky-col">
                <div style="display:flex; align-items:center; gap:5px;">
                    <textarea class="habit-name-box" onchange="const idx=habits.findIndex(x=>x.id===${h.id}); if(idx>-1){habits[idx].name=this.value; save(); render();}">${h.name}</textarea>
                    <span class="btn-delete" onclick="deleteHabit(${h.id})">üóë</span>
                </div>
            </td>`;
            for(let i=1; i<=daysInMonth; i++) {
                const d = new Date(year, month, i); d.setHours(0,0,0,0);
                const dStr = d.toISOString().split('T')[0];
                let st = logs[dStr]?.[h.id] || (d < today ? 'fail' : '');
                bodyHtml += `<td class="day-col">
                    <div class="mark status-${st}" onclick="toggle('${dStr}', ${h.id})">${st==='done'?'‚úì':(st==='fail'?'‚úï':'')}</div>
                </td>`;
            }
            bodyHtml += `</tr>`;
        });
        document.getElementById('tBody').innerHTML = bodyHtml;
    }

    initDB().then(() => render());
</script>
</body>
</html>