<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Simple SW Notification</title>
</head>
<body>
    <h1>Service Worker Notification</h1>
    <button onclick="sendNotification()">Hiển thị Hello World</button>

    <script>
        if ('serviceWorker' in navigator) {
            // Thêm v=... để trình duyệt luôn nạp bản mới nhất của sw.js
            navigator.serviceWorker.register('sw.js?v=' + Date.now())
            .then(reg => console.log('SW đã sẵn sàng!', reg))
            .catch(err => console.error('Lỗi đăng ký SW:', err));
        }

        async function sendNotification() {
			// 1. Kiểm tra sự tồn tại của Notification và ServiceWorker
			const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
			
			if (!('serviceWorker' in navigator)) {
				alert("Trình duyệt không hỗ trợ Service Worker!");
				return;
			}

			// 2. Ép quyền thông báo
			let permission = Notification.permission;
			if (permission === 'default') {
				permission = await Notification.requestPermission();
			}

			if (permission !== 'granted') {
				alert('Bạn cần cấp quyền thông báo trong cài đặt để tiếp tục!');
				return;
			}

			// 3. Hiển thị thông báo qua Service Worker Registration
			try {
				const reg = await navigator.serviceWorker.ready;
				
				// Trên mobile, gọi trực tiếp showNotification từ registration là cách ổn định nhất
				await reg.showNotification('Hello Mobile!', {
					body: 'Thông báo này đã vượt qua rào cản hệ thống!',
					icon: 'https://cdn-icons-png.flaticon.com/512/252/252035.png',
					vibrate: [200, 100, 200], // Rung máy (Android)
					tag: 'test-notification',
					renotify: true
				});
				
				console.log("Đã kích hoạt hiển thị thông báo.");
			} catch (err) {
				console.error("Lỗi hiển thị:", err);
				alert("Lỗi: " + err.message);
			}
		}
    </script>
</body>
</html>