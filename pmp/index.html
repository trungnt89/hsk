<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP MASTER PRO - V6 FINAL</title>
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #F2F2F7; --card: #FFFFFF; --text-main: #1C1C1E;
            --ios-blur: rgba(255, 255, 255, 0.9);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg); display: flex; flex-direction: column; overflow: hidden; 
        }

        /* 2. TOP NAV (3 N√öT) */
        .system-header { background: #fff; border-bottom: 0.5px solid #d1d1d6; flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        .nav-row { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; }
        .top-filter { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 16px 12px; }
        .tab-pill { 
            border: 1.5px solid #D1D1D6; padding: 8px 2px; border-radius: 12px; font-size: 11px; font-weight: 800; 
            background: #fff; color: #3A3A3C;
        }
        .tab-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); }

        /* 5. CAROUSEL BƒÇNG CHUY·ªÄN */
        .carousel-viewport { flex-grow: 1; overflow: hidden; position: relative; }
        .carousel-track { display: flex; height: 100%; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .slide { min-width: 100%; height: 100%; box-sizing: border-box; }
        .main-card { 
            background: var(--card); margin: 10px 15px; border-radius: 20px; 
            height: calc(100% - 20px); overflow-y: auto; position: relative;
        }
        
        /* 3. HEADER ƒê·ªò KH√ì KH√îNG CHO SCROLL */
        .question-header { 
            padding: 14px 16px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 0.5px solid #f2f2f7; position: sticky; top: 0; background: #fff; z-index: 10;
            touch-action: none; /* Kh√≥a scroll */
        }
        .difficulty-segment { display: flex; background: #F2F2F7; padding: 3px; border-radius: 10px; border: 1px solid #E5E5EA; }
        .btn-diff { border: none; padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; color: #8E8E93; background: transparent; transition: 0.2s; }
        
        /* 9. HIGHLIGHT ƒê·ªò KH√ì N·ªîI B·∫¨T */
        .btn-diff.selected-Easy { background: var(--easy) !important; color: white !important; }
        .btn-diff.selected-Medium { background: var(--medium) !important; color: white !important; }
        .btn-diff.selected-Hard { background: var(--hard) !important; color: white !important; }

        .question-body { padding: 16px; padding-bottom: 150px; }
        .option-item { 
            font-size: 16px; padding: 16px; background: #F2F2F7; border-radius: 16px; 
            margin-bottom: 12px; border: 2px solid transparent; 
        }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }

        /* 7. OVERLAY D·ªäCH THU·∫¨T GOOGLE */
        #translation-panel {
            position: fixed; top: 20%; left: 8%; width: 84%; 
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px);
            color: white; padding: 25px; border-radius: 24px; display: none; z-index: 10005;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }

        /* 10. BOTTOM BAR 6 N√öT C√ì VI·ªÄN */
        .bottom-nav-container {
            position: fixed; bottom: 0; width: 100%; background: var(--ios-blur);
            border-top: 0.5px solid rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); z-index: 999;
        }
        .bottom-nav { height: 90px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; padding: 10px; box-sizing: border-box; }
        .nav-item { 
            border: 1.5px solid #D1D1D6; background: #fff; border-radius: 14px; 
            font-size: 8px; color: #8E8E93; font-weight: 800; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item.active-blue { border: 2.5px solid var(--primary) !important; color: var(--primary); }
        .nav-item.active-Easy { border: 2.5px solid var(--easy) !important; color: var(--easy); }
        .nav-item.active-Medium { border: 2.5px solid var(--medium) !important; color: var(--medium); }
        .nav-item.active-Hard { border: 2.5px solid var(--hard) !important; color: var(--hard); }
    </style>
</head>
<body>

<header class="system-header">
    <div class="nav-row">
        <b>PMP MASTER <span style="color:var(--primary)">PRO</span></b>
        <select id="set-select" onchange="changeSet(this.value)" style="border:none; font-weight:800; color:var(--primary); background:#F2F2F7; padding:6px 12px; border-radius:10px;">
            <option value="DATA_SET_1">B·ªò ƒê·ªÄ 01</option>
            <option value="DATA_SET_2">B·ªò ƒê·ªÄ 02</option>
        </select>
    </div>
    <div class="top-filter" id="top-status"></div>
</header>

<main class="carousel-viewport" id="swipe-area">
    <div class="carousel-track" id="carousel-track"></div>
</main>

<div id="translation-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <span style="color:var(--easy); font-weight:800; font-size:12px;">GOOGLE TRANSLATE</span>
        <span onclick="closeTrans()" style="cursor:pointer; font-size:20px;">‚úï</span>
    </div>
    <div id="trans-content" style="font-size:16px; line-height:1.6;">ƒêang d·ªãch...</div>
</div>

<div class="bottom-nav-container">
    <nav class="bottom-nav">
        <button id="btn-prev" class="nav-item" onclick="flip('prev')"><i>‚óÄ</i><span>L√ôI</span></button>
        <button id="btn-ans" class="nav-item" onclick="showAns()"><i>üí°</i><span>GI·∫¢I</span></button>
        <button id="nav-Easy" class="nav-item" onclick="filterBy('Easy')"><i>üçÉ</i><span>D·ªÑ</span><b id="cnt-Easy">0</b></button>
        <button id="nav-Medium" class="nav-item" onclick="filterBy('Medium')"><i>‚ö°</i><span>V·ª™A</span><b id="cnt-Medium">0</b></button>
        <button id="nav-Hard" class="nav-item" onclick="filterBy('Hard')"><i>üî•</i><span>KH√ì</span><b id="cnt-Hard">0</b></button>
        <button id="btn-next" class="nav-item" onclick="flip('next')"><i>‚ñ∂</i><span>TI·∫æP</span></button>
    </nav>
</div>

<script>
let pmpData = []; 
let filteredQuestions = []; 
let currentIndex = 0; 
let currentTab = localStorage.getItem('PRO_V6_TAB') || 'todo'; 
let currentSetName = localStorage.getItem('PRO_V6_SET') || 'DATA_SET_1';

const DB_LV = "V6_LV_"; const DB_ANS = "V6_ANS_"; const DB_NOTE = "V6_NOTE_"; 

document.addEventListener('DOMContentLoaded', () => {
    // 5. Vu·ªët chuy·ªÉn trang
    let tStartX = 0;
    document.getElementById('swipe-area').addEventListener('touchstart', e => tStartX = e.changedTouches[0].screenX);
    document.getElementById('swipe-area').addEventListener('touchend', e => {
        let dx = e.changedTouches[0].screenX - tStartX;
        if (Math.abs(dx) > 60) dx < 0 ? flip('next') : flip('prev');
    });

    // 7. B√¥i ƒëen v√† d·ªãch
    document.addEventListener('touchend', triggerTranslation);
    document.addEventListener('mouseup', triggerTranslation);

    document.getElementById('set-select').value = currentSetName;
    changeSet(currentSetName);
});

async function triggerTranslation() {
    let text = window.getSelection().toString().trim();
    if (text.length > 3) {
        const panel = document.getElementById('translation-panel');
        const content = document.getElementById('trans-content');
        panel.style.display = 'block';
        content.innerHTML = "<i>ƒêang k·∫øt n·ªëi Google...</i>";

        try {
            const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURI(text)}`);
            const data = await res.json();
            content.innerText = data[0].map(x => x[0]).join('');
        } catch (e) {
            content.innerText = "L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra internet.";
        }
    }
}
function closeTrans() { document.getElementById('translation-panel').style.display = 'none'; window.getSelection().removeAllRanges(); }

function changeSet(v) {
    currentSetName = v;
    localStorage.setItem('PRO_V6_SET', v);
    pmpData = window[v] || [];
    updateData(true);
}

function updateData(reRender) {
    let lvData = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    let ansData = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    
    let counts = { todo: 0, done: 0, 'not-done': 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => {
        let lv = lvData[q.id];
        if (!lv) counts.todo++; else counts[lv]++;
        ansData[q.id] ? counts.done++ : counts['not-done']++;
    });

    // 2. Top Header (3 n√∫t)
    const lbls = { todo: "M·ªöI", done: "ƒê√É H·ªåC", 'not-done': "CH∆ØA H·ªåC" };
    document.getElementById('top-status').innerHTML = Object.keys(lbls).map(k => 
        `<button class="tab-pill ${currentTab===k?'active':''}" onclick="filterBy('${k}')">${lbls[k]} (${counts[k]})</button>`
    ).join('');

    // 10. Bottom Bar Counts
    ['Easy', 'Medium', 'Hard'].forEach(l => {
        document.getElementById('cnt-'+l).innerText = counts[l];
        document.getElementById('nav-'+l).className = 'nav-item' + (currentTab === l ? ` active-${l}` : '');
    });

    filteredQuestions = pmpData.filter(q => {
        if (['todo','done','not-done'].includes(currentTab)) {
            if (currentTab === 'todo') return !lvData[q.id];
            if (currentTab === 'done') return !!ansData[q.id];
            return !ansData[q.id];
        }
        return lvData[q.id] === currentTab;
    });

    if (reRender) renderSlides();
}

function renderSlides() {
    let track = document.getElementById('carousel-track');
    let lvData = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    let ansData = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    let noteData = JSON.parse(localStorage.getItem(DB_NOTE + currentSetName)) || {};

    track.innerHTML = filteredQuestions.length === 0 ? '<div class="slide"><div class="main-card" style="padding:20px">Danh s√°ch tr·ªëng</div></div>' : 
    filteredQuestions.map((q, idx) => {
        let lv = lvData[q.id];
        let userAns = ansData[q.id];
        return `
        <div class="slide">
            <div class="main-card">
                <div class="question-header">
                    <b>${idx+1} / ${filteredQuestions.length}</b>
                    <div class="difficulty-segment">
                        <button class="btn-diff ${lv==='Easy'?'selected-Easy':''}" onclick="setLv('${q.id}','Easy', this)">D·ªÑ</button>
                        <button class="btn-diff ${lv==='Medium'?'selected-Medium':''}" onclick="setLv('${q.id}','Medium', this)">V·ª™A</button>
                        <button class="btn-diff ${lv==='Hard'?'selected-Hard':''}" onclick="setLv('${q.id}','Hard', this)">KH√ì</button>
                    </div>
                </div>
                <div class="question-body">
                    <p style="font-size:18px; font-weight:700;">${q.question}</p>
                    <div class="options">
                        ${Object.entries(q.options).map(([k,v]) => `
                            <div class="option-item ${userAns===k?'selected':''}" onclick="toggleAns('${q.id}','${k}',this)">
                                <b>${k}.</b> ${v}
                            </div>`).join('')}
                    </div>
                    <div class="ex-box" style="display:none; padding:15px; background:#F2F2F7; border-radius:15px; margin-top:15px; border-left:5px solid var(--easy); font-size:14px;">${q.explanation}</div>
                    <div class="note-container" style="margin-top:20px;">
                        <textarea style="width:100%; border:1px solid #ddd; border-radius:12px; padding:10px; min-height:80px;" oninput="saveNote('${q.id}', this.value)" placeholder="Ghi ch√∫...">${noteData[q.id] || ""}</textarea>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
    moveTrack();
}

// 9. SET ƒê·ªò KH√ì: N·ªïi b·∫≠t ngay l·∫≠p t·ª©c v√† kh√¥ng b·ªã bi·∫øn m·∫•t
function setLv(id, lv, btn) {
    let data = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    if (data[id] === lv) delete data[id]; else data[id] = lv;
    localStorage.setItem(DB_LV + currentSetName, JSON.stringify(data));

    // C·∫≠p nh·∫≠t giao di·ªán n√∫t hi·ªán t·∫°i ngay l·∫≠p t·ª©c
    const parent = btn.parentElement;
    parent.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('selected-Easy', 'selected-Medium', 'selected-Hard'));
    if (data[id]) btn.classList.add('selected-' + lv);

    updateCountsOnly();
}

function updateCountsOnly() {
    let lvData = JSON.parse(localStorage.getItem(DB_LV + currentSetName)) || {};
    let counts = { Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { if(lvData[q.id]) counts[lvData[q.id]]++; });
    document.getElementById('cnt-Easy').innerText = counts.Easy;
    document.getElementById('cnt-Medium').innerText = counts.Medium;
    document.getElementById('cnt-Hard').innerText = counts.Hard;
}

// 4. Toggle ƒë√°p √°n
function toggleAns(qId, key, el) {
    let data = JSON.parse(localStorage.getItem(DB_ANS + currentSetName)) || {};
    if (data[qId] === key) { delete data[qId]; el.classList.remove('selected'); }
    else {
        data[qId] = key;
        el.parentElement.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
    }
    localStorage.setItem(DB_ANS + currentSetName, JSON.stringify(data));
    updateData(false);
}

function saveNote(id, val) {
    let data = JSON.parse(localStorage.getItem(DB_NOTE + currentSetName)) || {};
    data[id] = val; localStorage.setItem(DB_NOTE + currentSetName, JSON.stringify(data));
}

function filterBy(t) { currentTab = t; localStorage.setItem('PRO_V6_TAB', t); currentIndex = 0; updateData(true); }

function flip(d) {
    if (d==='next' && currentIndex < filteredQuestions.length-1) currentIndex++;
    if (d==='prev' && currentIndex > 0) currentIndex--;
    moveTrack();
}

function moveTrack() { document.getElementById('carousel-track').style.transform = `translateX(-${currentIndex*100}%)`; }

function showAns() {
    let slide = document.getElementById('carousel-track').children[currentIndex];
    let q = filteredQuestions[currentIndex];
    let box = slide.querySelector('.ex-box');
    box.style.display = box.style.display==='none'?'block':'none';
    document.getElementById('btn-ans').classList.toggle('active-blue');
    slide.querySelectorAll('.option-item').forEach(opt => {
        if (opt.innerText.trim().startsWith(q.answer)) opt.style.background = '#EFFFF3';
    });
}
</script>
</body>
</html>