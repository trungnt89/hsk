<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Manager Pro - Compact View</title>
    <style>
        /* GI·ªÆ NGUY√äN CSS G·ªêC */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white; padding: 25px; border-radius: 20px;
            margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .header h1 {
            font-size: 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
        }
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px; margin-top: 20px;
        }
        .stat-item {
            padding: 15px; background: #f8f9fa; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.3s;
            border: 2px solid transparent;
        }
        .stat-item.active-filter { border-color: #667eea; background: #fff; }
        .stat-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: #495057; font-weight: 700; text-transform: uppercase; }
        .stat-icon { font-size: 24px; margin-bottom: 4px; }
        .stat-item.overdue .stat-value { color: #dc3545; }
        .stat-item.safe .stat-value { color: #28a745; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .add-task-section {
            background: white; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 450px; position: relative;
        }
        .btn-open-modal {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            border-radius: 50%; background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; border: none; font-size: 30px; cursor: pointer;
            box-shadow: 0 10px 30px rgba(56, 239, 125, 0.4); z-index: 999;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; padding: 15px 20px; border-radius: 12px;
            margin-bottom: 20px; display: flex; align-items: center; gap: 16px;
            cursor: pointer; 
            animation: danger-blink 0.8s infinite alternate;
            border: 2px solid #fff;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        @keyframes danger-blink {
            0% { filter: brightness(1); transform: scale(1); }
            100% { filter: brightness(1.2); transform: scale(1.01); background: #ff0000; }
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .form-group label { font-size: 13px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea, .form-group select { padding: 12px; border: 2px solid #e9ecef; border-radius: 10px; width: 100%; }
        .btn-add {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
        }

        .tasks-grid { display: flex; flex-direction: column; gap: 8px; }
        .task-card { 
            background: white; padding: 12px 20px; border-radius: 12px; 
            border-left: 5px solid #e9ecef; transition: 0.2s;
            display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 10px;
            border-bottom: 1px solid #eee;
        }
        .task-card:last-child { border-bottom: none; }
        .task-card:hover { transform: translateX(5px); background: #fcfcfc; }
        .task-card.overdue { border-left-color: #dc3545; }
        .task-card.urgent { border-left-color: #ff6b6b; }
        .task-card.warning { border-left-color: #2196F3; }
        .task-card.safe { border-left-color: #28a745; }
        
        .task-title { font-size: 16px; font-weight: 700; color: #333; white-space: normal; word-break: break-word; }
        .task-detail-sub { font-size: 13px; color: #777; font-weight: 400; margin-left: 8px; font-style: italic; }
        .deadline-info { font-size: 13px; color: #555; font-family: monospace; min-width: 130px; text-align: right; }
        .btn-icon { width: 32px; height: 32px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .priority-badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; text-transform: uppercase; background: #eee; margin-left: 5px;}

        @media (max-width: 600px) {
            .task-card {
                grid-template-columns: 1fr;
                gap: 5px;
                padding: 10px 15px;
            }
            .task-footer-mobile { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                margin-top: 5px;
            }
            .deadline-info { text-align: left; min-width: auto; flex: 1; }
        }

        .time-tab {
            flex: 1; padding: 12px; border: none; 
            border-radius: 8px 8px 0 0; background: #e0e0e0; 
            cursor: pointer; font-size: 12px; font-weight: 700; 
            transition: 0.2s; color: #666;
            border-bottom: 2px solid transparent;
        }
        .time-tab.active {
            background: white !important;
            color: #667eea !important;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            border-bottom: 2px solid white;
            position: relative; z-index: 2;
        }
        .time-tab:hover:not(.active) { background: #d5d5d5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="alert-banner" id="alertBanner" style="display: none;" onclick="filterTasks('overdue')">
            <div class="alert-icon">üö®</div>
            <div class="alert-content"><p id="alertText"></p></div>
        </div>

        <div class="header">
            <h1>üìã Todo Manager Pro</h1>
            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Danh s√°ch c√¥ng vi·ªác r√∫t g·ªçn</p>

            <div class="stats-bar" id="statsBar">
                <div class="stat-item overdue" onclick="filterTasks('overdue', this)">
                    <div class="stat-icon">üö´</div>
                    <div class="stat-value" id="statOverdue">0</div>
                    <div class="stat-label">üî¥ Qu√° h·∫°n</div>
                </div>
                <div class="stat-item safe" onclick="filterTasks('completed', this)">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="statSafe">0</div>
                    <div class="stat-label">‚úÖ Ho√†n th√†nh</div>
                </div>
            </div>
        </div>

        <div style="display: flex; margin-top: 24px; background: #ccc; border-radius: 12px 12px 0 0; padding: 8px 8px 0 8px; gap: 4px; border-bottom: 1px solid #ddd;">
            <button id="defaultTab" class="time-tab" onclick="filterByTime('today', this)">üìÖ Ng√†y (<span id="todoToday">0</span>)</button>
            <button class="time-tab" onclick="filterByTime('week', this)">üóìÔ∏è Tu·∫ßn (<span id="todoWeek">0</span>)</button>
            <button class="time-tab" onclick="filterByTime('month', this)">üìÖ Th√°ng (<span id="todoMonth">0</span>)</button>
            <button class="time-tab" onclick="filterTasks('all', this)">üëÅÔ∏è T·∫•t c·∫£</button>
        </div>
        <div class="tasks-grid" id="tasksGrid" style="background: white; padding: 15px; border-radius: 0 0 12px 12px; min-height: 100px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);"></div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="add-task-section">
            <button onclick="toggleModal()" style="position:absolute; right:20px; top:20px; border:none; background:none; cursor:pointer; font-size:20px; color:#999">‚úï</button>
            <h2 style="margin-bottom:20px">‚ûï Th√™m vi·ªác m·ªõi</h2>
            <div id="multiTaskContainer" style="max-height: 350px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 12px;"></div>
            <button onclick="addTaskRow()" style="width:100%; padding:8px; margin-bottom:15px; border:2px dashed #ccc; background:none; border-radius:10px; cursor:pointer; color:#666; font-weight:600">+ Th√™m c√¥ng vi·ªác kh√°c</button>
            <div class="form-group"><label>∆Øu ti√™n</label><select id="taskPriority"><option value="high">Cao</option><option value="medium" selected>Trung b√¨nh</option><option value="low">Th·∫•p</option></select></div>
            <button class="btn-add" onclick="addTask()">L∆ØU C√îNG VI·ªÜC</button>
        </div>
    </div>

    <button class="btn-open-modal" onclick="toggleModal()">+</button>

    <script>
        let tasks = [];
        let currentFilter = 'all';
        let editingTaskId = null;
        let db;
        const DB_NAME = "TodoDBPro";
        const STORE_NAME = "tasks_store";

        // --- PH·∫¶N B·ªî SUNG: SERVICE WORKER TH√îNG B√ÅO 5 PH√öT ---
        const swCode = `
            const DB_NAME = "${DB_NAME}";
            const STORE_NAME = "${STORE_NAME}";
            
            async function checkAndNotify() {
                const request = indexedDB.open(DB_NAME, 1);
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) return;
                    
                    const tx = db.transaction(STORE_NAME, "readonly");
                    const store = tx.objectStore(STORE_NAME);
                    const getReq = store.get("current_tasks_list");

                    getReq.onsuccess = () => {
                        const tasks = getReq.result?.data || [];
                        const today = new Date().toDateString();
                        const hasTaskToday = tasks.some(t => new Date(t.deadline).toDateString() === today);

                        if (!hasTaskToday) {
                            self.registration.showNotification("üìã Nh·∫Øc nh·ªü Todo", {
                                body: "H√¥m nay b·∫°n ch∆∞a c√≥ c√¥ng vi·ªác n√†o. H√£y m·ªü ·ª©ng d·ª•ng ƒë·ªÉ t·∫°o vi·ªác ngay!",
                                icon: "https://cdn-icons-png.flaticon.com/512/906/906334.png",
                                tag: "remind-5m",
                                requireInteraction: true
                            });
                        }
                    };
                };
            }
            // Ki·ªÉm tra ngay khi kh·ªüi ch·∫°y v√† m·ªói 5 ph√∫t
            checkAndNotify();
            setInterval(checkAndNotify, 5 * 60 * 1000);
        `;

        if ('serviceWorker' in navigator && 'Notification' in window) {
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).then(reg => {
                if (Notification.permission !== 'granted') {
                    Notification.requestPermission();
                }
            });
        }
        // --- K·∫æT TH√öC PH·∫¶N B·ªî SUNG ---

        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
        };
        request.onsuccess = e => {
            db = e.target.result;
            loadTasksFromDB();
        };

        function saveToDB() {
            if (!db) return;
            const tx = db.transaction(STORE_NAME, "readwrite");
            const store = tx.objectStore(STORE_NAME);
            store.put({ id: "current_tasks_list", data: tasks });
        }

        function loadTasksFromDB() {
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const req = store.get("current_tasks_list");
            req.onsuccess = () => {
                if (req.result) {
                    tasks = req.result.data;
                    document.getElementById('defaultTab').click();
                }
                updateStats(); 
            };
        }

        function addTaskRow(val = "", isRequired = false) {
            const container = document.getElementById('multiTaskContainer');
            const div = document.createElement('div');
            div.className = 'task-row-input';
            div.style = 'background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:10px; position:relative; border:1px solid #eee';
            div.innerHTML = `
                <label style="font-size:12px; font-weight:700; color:#333; display:block; margin-bottom:5px;">${isRequired ? val : 'C√îNG VI·ªÜC KH√ÅC'} <span style="color:red">*</span></label>
                <input type="text" class="multi-title" required placeholder="Nh·∫≠p n·ªôi dung..." style="margin-bottom:8px; padding:8px; width:100%; border:1px solid #ddd; border-radius:6px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                    <input type="number" class="multi-duration" value="1" placeholder="S·ªë l∆∞·ª£ng" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                    <select class="multi-unit" style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                        <option value="hours">Gi·ªù</option>
                        <option value="days" selected>Ng√†y</option>
                        <option value="weeks">Tu·∫ßn</option>
                    </select>
                </div>
                ${!isRequired ? `<button onclick="this.parentElement.remove()" style="position:absolute; right:10px; top:5px; border:none; background:none; color:red; cursor:pointer; font-weight:bold">‚úï</button>` : ''}
            `;
            container.appendChild(div);
        }

        function toggleModal() {
            const modal = document.getElementById('taskModal');
            if (modal.style.display !== 'flex') {
                if (!editingTaskId) {
                    document.querySelector('#taskModal h2').textContent = "‚ûï Th√™m vi·ªác m·ªõi";
                    document.querySelector('.btn-add').textContent = "L∆ØU C√îNG VI·ªÜC";
                    resetForm();
                    document.getElementById('multiTaskContainer').innerHTML = '';
                    addTaskRow("C√¥ng vi·ªác mang l·∫°i gi√° tr·ªã nh·∫•t trong h√¥m nay l√† g√¨", true);
                    addTaskRow("C√¥ng vi·ªác c·∫£m th·∫•y phi·ªÅn ph·ª©c nh·∫•t trong h√¥m nay l√† g√¨", true);
                }
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
                resetForm();
            }
        }

        function autoCalcDeadline(val, unit) {
            if (isNaN(val)) return new Date().toISOString();
            const now = new Date();
            if (unit === 'hours') now.setHours(now.getHours() + val);
            else if (unit === 'days') now.setDate(now.getDate() + val);
            else if (unit === 'weeks') now.setDate(now.getDate() + (val * 7));
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString();
        }

        function getDeadlineStatus(deadline, completed) {
            if (completed) return 'completed';
            const diff = new Date(deadline) - new Date();
            if (diff < 0) return 'overdue';
            if (diff / 3600000 < 48) return 'urgent';
            if (diff / 3600000 < 168) return 'warning';
            return 'safe';
        }

        function updateStats() {
            const stats = { overdue: 0, completed: 0 };
            const now = new Date();
            let counts = { today: 0, week: 0, month: 0 };
            tasks.forEach(t => {
                const s = getDeadlineStatus(t.deadline, t.completed);
                if (s === 'completed') stats.completed++; 
                else if (s === 'overdue') stats.overdue++;

                if (!t.completed) {
                    const d = new Date(t.deadline);
                    if (d.toDateString() === now.toDateString()) counts.today++;
                    if ((d - now) / 86400000 <= 7 && (d-now) >= 0) counts.week++;
                    if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) counts.month++;
                }
            });
            
            if(document.getElementById('statOverdue')) document.getElementById('statOverdue').textContent = stats.overdue;
            if(document.getElementById('statSafe')) document.getElementById('statSafe').textContent = stats.completed;

            document.getElementById('todoToday').textContent = counts.today;
            document.getElementById('todoWeek').textContent = counts.week;
            document.getElementById('todoMonth').textContent = counts.month;
            
            const banner = document.getElementById('alertBanner');
            if (stats.overdue > 0) {
                banner.style.display = 'flex';
                document.getElementById('alertText').innerHTML = `<b>NGUY HI·ªÇM:</b> C√≥ ${stats.overdue} vi·ªác qu√° h·∫°n! Nh·∫•p v√†o ƒë√¢y ƒë·ªÉ xem ngay.`;
            } else banner.style.display = 'none';
        }

        function filterByTime(range, el) {
            currentFilter = range;
            document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');

            const now = new Date();
            let filtered = tasks.filter(t => {
                if (t.completed) return false;
                const d = new Date(t.deadline);
                if (range === 'today') return d.toDateString() === now.toDateString();
                if (range === 'week') return (d - now) / 86400000 <= 7 && (d-now) >= 0;
                if (range === 'month') return d.getMonth() === now.getMonth();
                return true;
            });
            renderTasks(filtered);
        }

        function renderTasks(customList = null) {
            const grid = document.getElementById('tasksGrid');
            let filtered = customList || tasks;
            if (!customList && currentFilter !== 'all') filtered = tasks.filter(t => getDeadlineStatus(t.deadline, t.completed) === currentFilter);
            grid.innerHTML = filtered.length ? filtered.map(t => `
                <div class="task-card ${getDeadlineStatus(t.deadline, t.completed)}">
                    <div class="task-title">
                        <span>${t.completed ? '‚úÖ ' : ''}${t.title} <span class="priority-badge">${t.priority}</span></span>
                        ${t.detail ? `<span class="task-detail-sub">- ${t.detail}</span>` : ''}
                    </div>
                    <div class="task-footer-mobile">
                        <div class="deadline-info">üìÖ ${new Date(t.deadline).toLocaleString('vi-VN', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'})}</div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="btn-icon" style="background:#e3f2fd" onclick="editTask(${t.id})">‚úèÔ∏è</button>
                            <button class="btn-icon" style="background:${t.completed ? '#ffeb3b' : '#d4edda'}" onclick="completeTask(${t.id})">${t.completed ? '‚Ü©Ô∏è' : '‚úì'}</button>
                            <button class="btn-icon" style="background:#f8d7da" onclick="deleteTask(${t.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('') : '<div style="text-align:center; padding:30px; color:#999;">Tr·ªëng...</div>';
        }

        function addTask() {
            const rows = document.querySelectorAll('.task-row-input');
            const priority = document.getElementById('taskPriority').value;

            if (editingTaskId) {
                const title = rows[0].querySelector('.multi-title').value.trim();
                const dur = parseFloat(rows[0].querySelector('.multi-duration').value);
                const unit = rows[0].querySelector('.multi-unit').value;
                if (!title) return alert("T√™n c√¥ng vi·ªác kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
                const index = tasks.findIndex(t => t.id === editingTaskId);
                if (index !== -1) {
                    tasks[index] = { ...tasks[index], title, deadline: autoCalcDeadline(dur, unit), priority };
                }
                editingTaskId = null;
            } else {
                let hasEmpty = false;
                rows.forEach(row => {
                    const title = row.querySelector('.multi-title').value.trim();
                    if (!title) hasEmpty = true;
                });
                if (hasEmpty) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung cho t·∫•t c·∫£ c√°c √¥ c√¥ng vi·ªác b·∫Øt bu·ªôc!");
                rows.forEach(row => {
                    const title = row.querySelector('.multi-title').value.trim();
                    const dur = parseFloat(row.querySelector('.multi-duration').value);
                    const unit = row.querySelector('.multi-unit').value;
                    if (!isNaN(dur)) {
                        tasks.unshift({ id: Date.now() + Math.random(), title, detail: "", deadline: autoCalcDeadline(dur, unit), priority, completed: false });
                    }
                });
            }
            saveToDB(); toggleModal(); updateStats(); renderTasks(); resetForm();
        }

        function editTask(id) {
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            editingTaskId = id;
            document.getElementById('multiTaskContainer').innerHTML = '';
            addTaskRow(t.title, true);
            document.querySelector('.task-row-input label').innerHTML = `S·ª¨A N·ªòI DUNG <span style="color:red">*</span>`;
            document.querySelector('.multi-title').value = t.title;
            document.getElementById('taskPriority').value = t.priority;
            document.querySelector('#taskModal h2').textContent = "üìù S·ª≠a c√¥ng vi·ªác";
            document.querySelector('.btn-add').textContent = "C·∫¨P NH·∫¨T THAY ƒê·ªîI";
            document.getElementById('taskModal').style.display = 'flex';
        }

        function resetForm() {
            document.getElementById('multiTaskContainer').innerHTML = '';
            editingTaskId = null;
        }

        function filterTasks(f, el) { 
            currentFilter = f; 
            document.querySelectorAll('.time-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            renderTasks(); 
        }
        function completeTask(id) { const t = tasks.find(x => x.id === id); if(t) t.completed = !t.completed; saveToDB(); updateStats(); renderTasks(); }
        function deleteTask(id) { if(confirm("X√≥a?")) { tasks = tasks.filter(x => x.id !== id); saveToDB(); updateStats(); if(currentFilter === 'today' || currentFilter === 'week' || currentFilter === 'month') { filterByTime(currentFilter); } else { renderTasks(); } } }
    </script>
</body>
</html>