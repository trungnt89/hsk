<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Scheduler - Single Table IndexedDB</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 20px 10px;
            margin: 0;
        }

        .container {
            background: var(--card);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        h2 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--primary); }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #64748b; }

        textarea {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: 10px; resize: vertical; box-sizing: border-box;
            font-family: inherit; transition: all 0.2s;
        }

        .quick-select { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }

        .btn-opt {
            padding: 10px; border: 1px solid var(--border); background: white;
            border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;
        }
        .btn-opt.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .btn-main {
            width: 100%; padding: 14px; background: var(--primary);
            color: white; border: none; border-radius: 10px; font-weight: 600;
            cursor: pointer; font-size: 1rem;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.75rem; color: #64748b; border-bottom: 2px solid #f1f5f9; }
        td { padding: 16px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
        .content-cell { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-test { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
        .btn-edit { background: #eff6ff; color: var(--primary); border: 1px solid #dbeafe; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; margin: 0 4px; }
        .btn-delete { background: #fef2f2; color: var(--danger); border: 1px solid #fee2e2; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
        
        .btn-test:hover, .btn-edit:hover, .btn-delete:hover { transform: translateY(-1px); opacity: 0.9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="view-list" class="view active">
        <div class="nav-header">
            <h2>H·ªá th·ªëng G·ª≠i tin</h2>
            <button class="btn-opt active" style="padding: 10px 20px;" onclick="openCreateView()">+ Th√™m C·∫•u h√¨nh</button>
        </div>
        <div id="schedule-list" style="overflow-x: auto;"></div>
    </div>

    <div id="view-form" class="view">
        <div class="nav-header">
            <h2 id="form-title">T·∫°o m·ªõi</h2>
            <button class="btn-opt" onclick="showView('view-list')">Quay l·∫°i</button>
        </div>
        
        <div class="form-group">
            <label>N·ªôi dung tin nh·∫Øn</label>
            <textarea id="msgContent" rows="6" placeholder="L∆∞u v√†o config_table..."></textarea>
        </div>

        <div class="form-group">
            <label>T·∫ßn su·∫•t g·ª≠i</label>
            <div class="quick-select">
                <button class="btn-opt active btn-q" onclick="setFreq(1, this)">1p</button>
                <button class="btn-opt btn-q" onclick="setFreq(5, this)">5p</button>
                <button class="btn-opt btn-q" onclick="setFreq(10, this)">10p</button>
                <button class="btn-opt btn-q" onclick="setFreq(30, this)">30p</button>
                <button class="btn-opt btn-q" id="btnCustom" onclick="toggleCustom(this)">...</button>
            </div>
            <div id="customGroup" style="display:none; gap:10px; margin-top:15px;">
                <input type="number" id="freqValue" value="1" min="1" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:100px;">
                <select id="freqUnit" style="padding:10px; border:1px solid var(--border); border-radius:8px;">
                    <option value="minutes">Ph√∫t</option>
                    <option value="hours">Gi·ªù</option>
                </select>
            </div>
        </div>

        <button class="btn-main" onclick="saveSchedule()">L∆∞u To√†n B·ªô D·ªØ Li·ªáu</button>
    </div>
</div>

<script>
    const DB_NAME = 'MessageSchedulerApp';
    const TABLE_NAME = 'config_table'; // 1 Table duy nh·∫•t
    const DATA_KEY = 'all_configs';    // 1 Key duy nh·∫•t
    let currentFreq = 1, currentUnit = 'minutes', isCustomMode = false, editingId = null;

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(TABLE_NAME)) db.createObjectStore(TABLE_NAME);
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-list') loadSchedules();
    }

    function openCreateView() {
        resetForm();
        document.getElementById('form-title').innerText = "T·∫°o c·∫•u h√¨nh m·ªõi";
        showView('view-form');
    }

    function setFreq(val, btn) {
        isCustomMode = false; currentFreq = val; currentUnit = 'minutes';
        document.getElementById('customGroup').style.display = 'none';
        updateActiveBtn(btn);
    }

    function toggleCustom(btn) {
        isCustomMode = true;
        document.getElementById('customGroup').style.display = 'flex';
        updateActiveBtn(btn);
    }

    function updateActiveBtn(btn) {
        document.querySelectorAll('.btn-q').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    async function saveSchedule() {
        const content = document.getElementById('msgContent').value.trim();
        if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");

        const freq = isCustomMode ? document.getElementById('freqValue').value : currentFreq;
        const unit = isCustomMode ? document.getElementById('freqUnit').value : currentUnit;

        const db = await initDB();
        const tx = db.transaction(TABLE_NAME, 'readwrite');
        const store = tx.objectStore(TABLE_NAME);

        store.get(DATA_KEY).onsuccess = (e) => {
            let list = e.target.result || [];
            const data = { 
                id: editingId || `scheduler_config_${Date.now()}`, 
                content, frequency: parseInt(freq), unit, timestamp: Date.now() 
            };

            if (editingId) {
                list = list.map(item => item.id === editingId ? data : item);
            } else {
                list.push(data);
            }
            store.put(list, DATA_KEY);
            tx.oncomplete = () => showView('view-list');
        };
    }

    async function loadSchedules() {
        const db = await initDB();
        db.transaction(TABLE_NAME, 'readonly').objectStore(TABLE_NAME).get(DATA_KEY).onsuccess = (e) => {
            const results = e.target.result || [];
            const list = document.getElementById('schedule-list');
            if (results.length === 0) { 
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">Tr·ªëng.</div>`; 
                return; 
            }
            
            let html = `<table><thead><tr><th>N·ªôi dung tin nh·∫Øn</th><th>T·∫ßn su·∫•t</th><th>Thao t√°c</th></tr></thead><tbody>`;
            html += results.map(item => `
                <tr>
                    <td class="content-cell" title="${item.content}">${item.content}</td>
                    <td>${item.frequency}${item.unit === 'minutes' ? 'p' : 'h'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn-test" onclick="testSend('${item.content.replace(/'/g, "\\'")}')">Test</button>
                        <button class="btn-edit" onclick="editSchedule('${item.id}')">S·ª≠a</button>
                        <button class="btn-delete" onclick="deleteSchedule('${item.id}')">X√≥a</button>
                    </td>
                </tr>`).join('');
            list.innerHTML = html + `</tbody></table>`;
        };
    }

    async function deleteSchedule(id) {
        if (!confirm('X√≥a b·∫£n ghi n√†y kh·ªèi Table?')) return;
        const db = await initDB();
        const tx = db.transaction(TABLE_NAME, 'readwrite');
        const store = tx.objectStore(TABLE_NAME);
        store.get(DATA_KEY).onsuccess = (e) => {
            const list = e.target.result || [];
            const newList = list.filter(item => item.id !== id);
            store.put(newList, DATA_KEY).onsuccess = loadSchedules;
        };
    }

    async function editSchedule(id) {
        const db = await initDB();
        db.transaction(TABLE_NAME, 'readonly').objectStore(TABLE_NAME).get(DATA_KEY).onsuccess = (e) => {
            const list = e.target.result || [];
            const data = list.find(item => item.id === id);
            document.getElementById('msgContent').value = data.content;
            editingId = data.id;
            document.getElementById('form-title').innerText = "Ch·ªânh s·ª≠a";
            toggleCustom(document.getElementById('btnCustom'));
            document.getElementById('freqValue').value = data.frequency;
            document.getElementById('freqUnit').value = data.unit;
            showView('view-form');
        };
    }

    function testSend(content) { alert("üöÄ TEST G·ª¨I TIN:\n\n" + content); }

    function resetForm() {
        editingId = null;
        document.getElementById('msgContent').value = '';
        setFreq(1, document.querySelector('.btn-q'));
    }

    window.onload = loadSchedules;
</script>
</body>
</html>