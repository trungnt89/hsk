<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Stable TTS Drive System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        #log { background: #000; color: #0f0; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; border-radius: 5px; margin-top: 15px; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>
    <h3>TTS Audio Storage</h3>
    <input type="text" id="inputText" value="Thử nghiệm hệ thống ổn định.">
    <input type="text" id="filename" value="final_test_stable">
    <button id="btn" onclick="runProcess()">PHÁT & LƯU</button>
    <div id="log"></div>

<script>
    const GAS_URL = "DÁN_URL_WEB_APP_GAS_CỦA_BẠN_VÀO_ĐÂY"; 

    function log(msg, color = "#0f0") {
        const el = document.getElementById('log');
        el.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        el.scrollTop = el.scrollHeight;
    }

    async function playAudioFromProxy(proxyUrl) {
        log("Đang nạp âm thanh qua Proxy...");
        const res = await fetch(proxyUrl);
        const base64 = await res.text();
        const audio = new Audio("data:audio/mpeg;base64," + base64);
        return audio.play();
    }

    async function runProcess() {
        const text = document.getElementById('inputText').value;
        const filename = document.getElementById('filename').value;
        document.getElementById('btn').disabled = true;
        log("Bắt đầu quy trình...");

        try {
            const vercelRes = await fetch(`/api/tts?text=${encodeURIComponent(text)}&voice=vi-VN-HoaiMyNeural&rate=1.0&filename=${filename}`);
            const data = await vercelRes.json();

            if (data.source === 'driver') {
                log("Đã có trên Drive. Đang phát...");
                await playAudioFromProxy(data.url);
            } else {
                log("Tạo mới từ Azure...");
                const binary = atob(data.audioData);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                const audio = new Audio(URL.createObjectURL(new Blob([bytes], {type: 'audio/mpeg'})));
                audio.play();

                log("Đang đồng bộ lên Drive...");
                await fetch(`${GAS_URL}?fileKey=${encodeURIComponent(data.fileKey)}`, {
                    method: 'POST',
                    body: JSON.stringify(Array.from(bytes)),
                    mode: 'no-cors'
                });
                log("Đã đồng bộ xong.");
            }
        } catch (e) {
            log("LỖI: " + e.message, "red");
        } finally {
            document.getElementById('btn').disabled = false;
        }
    }
</script>
</body>
</html>