<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng Qu·∫£n Tr·ªã IndexedDB To√†n Di·ªán</title>
    <style>
        :root { --primary: #3498db; --view: #9b59b6; --export: #27ae60; --import: #f39c12; --clear: #e74c3c; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; color: var(--dark); }
        .container { max-width: 1200px; margin: auto; }
        
        /* Header & Log */
        .header-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: center; }
        #log { background: #1e1e1e; color: #00ff00; padding: 12px; border-radius: 8px; max-height: 100px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-bottom: 20px; border-left: 5px solid var(--primary); text-align: left; }
        
        /* Database Card */
        .db-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .db-title { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.3em; font-weight: bold; color: var(--primary); }
        
        /* Store Item */
        .store-item { border: 1px solid #e1e4e8; border-radius: 8px; margin-bottom: 15px; overflow: hidden; }
        .store-header { background: #f8f9fa; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; border-bottom: 1px solid #e1e4e8; }
        .store-name { font-weight: bold; color: #e67e22; font-size: 15px; }
        .badge { background: #d6eaf8; color: #2980b9; padding: 3px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; margin-left: 10px; }
        
        /* Control Buttons */
        .btn-group { display: flex; gap: 8px; }
        button { padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .btn-scan { background: var(--primary); color: white; width: 100%; justify-content: center; padding: 15px; font-size: 16px; margin-bottom: 20px; }
        .btn-view { background: var(--view); color: white; }
        .btn-export { background: var(--export); color: white; }
        .btn-import { background: var(--import); color: white; }
        .btn-clear { background: var(--clear); color: white; }

        /* Data Viewer Table */
        .data-viewer { display: none; padding: 15px; background: #fff; max-height: 400px; overflow: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f1f3f5; position: sticky; top: 0; z-index: 10; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .cell-data { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: monospace; color: #666; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h2>üõ†Ô∏è IndexedDB Universal Manager</h2>
        <p style="color: #666; font-size: 14px;">T·ª± ƒë·ªông ph√°t hi·ªán v√† qu·∫£n l√Ω m·ªçi c∆° s·ªü d·ªØ li·ªáu tr√¨nh duy·ªát</p>
    </div>
    
    <div id="log">S·∫µn s√†ng th·ª±c hi·ªán y√™u c·∫ßu...</div>
    
    <button class="btn-scan" onclick="deepScan()">üîÑ QU√âT TO√ÄN B·ªò DATABASE</button>

    <div id="results"></div>
</div>

<script>
    const logEl = document.getElementById('log');
    const resultsEl = document.getElementById('results');

    function writeLog(msg) {
        const time = new Date().toLocaleTimeString();
        logEl.innerHTML += `<div>[${time}] > ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function deepScan() {
        resultsEl.innerHTML = "";
        writeLog("ƒêang qu√©t c√°c c∆° s·ªü d·ªØ li·ªáu kh·∫£ d·ª•ng...");
        try {
            const dbs = await indexedDB.databases();
            if (dbs.length === 0) {
                writeLog("Kh√¥ng t√¨m th·∫•y Database n√†o trong Origin n√†y.");
                return;
            }
            dbs.forEach(dbInfo => renderDB(dbInfo.name));
            writeLog(`ƒê√£ li·ªát k√™ ${dbs.length} Database.`);
        } catch (e) {
            writeLog("L·ªói: Kh√¥ng th·ªÉ li·ªát k√™ DB. H√£y ƒë·∫£m b·∫£o b·∫°n d√πng tr√¨nh duy·ªát hi·ªán ƒë·∫°i.");
        }
    }

    function renderDB(dbName) {
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const dbCard = document.createElement('div');
            dbCard.className = 'db-card';
            dbCard.innerHTML = `<div class="db-title">üìÇ DB: ${dbName} <small>(Version: ${db.version})</small></div>`;

            Array.from(db.objectStoreNames).forEach(sName => {
                const tx = db.transaction(sName, "readonly");
                const store = tx.objectStore(sName);
                const countReq = store.count();

                countReq.onsuccess = () => {
                    const safeId = btoa(dbName + sName).replace(/[^a-z0-9]/gi, "");
                    const storeDiv = document.createElement('div');
                    storeDiv.className = 'store-item';
                    storeDiv.innerHTML = `
                        <div class="store-header">
                            <div>
                                <span class="store-name">üì¶ ${sName}</span>
                                <span class="badge" id="count_${safeId}">${countReq.result} records</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn-view" onclick="toggleView('${dbName}', '${sName}', '${safeId}')">üëÅÔ∏è View List</button>
                                <button class="btn-import" onclick="document.getElementById('file_${safeId}').click()">üì• Import</button>
                                <button class="btn-export" onclick="exportStore('${dbName}', '${sName}')">üì§ Export</button>
                                <button class="btn-clear" onclick="clearStore('${dbName}', '${sName}', '${safeId}')">üóëÔ∏è Clear</button>
                                <input type="file" id="file_${safeId}" onchange="importToStore(event, '${dbName}', '${sName}', '${safeId}')">
                            </div>
                        </div>
                        <div class="data-viewer" id="view_${safeId}">
                            <table id="table_${safeId}"><thead></thead><tbody></tbody></table>
                        </div>
                    `;
                    dbCard.appendChild(storeDiv);
                };
            });
            resultsEl.appendChild(dbCard);
            db.close();
        };
    }

    // --- 1. VIEW LIST ---
    function toggleView(dbName, storeName, safeId) {
        const viewer = document.getElementById(`view_${safeId}`);
        if (viewer.style.display === "block") {
            viewer.style.display = "none";
            return;
        }

        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            db.transaction(storeName, "readonly").objectStore(storeName).getAll().onsuccess = (ev) => {
                const data = ev.target.result;
                const table = document.getElementById(`table_${safeId}`);
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');

                thead.innerHTML = ""; tbody.innerHTML = "";
                if (data.length > 0) {
                    const keys = Object.keys(data[0]);
                    thead.innerHTML = `<tr><th>#</th>${keys.map(k => `<th>${k}</th>`).join('')}</tr>`;
                    data.forEach((row, i) => {
                        tbody.innerHTML += `<tr><td>${i+1}</td>${keys.map(k => {
                            let val = typeof row[k] === 'object' ? JSON.stringify(row[k]) : row[k];
                            return `<td class="cell-data" title='${val}'>${val}</td>`;
                        }).join('')}</tr>`;
                    });
                } else {
                    tbody.innerHTML = "<tr><td colspan='100%'>B·∫£ng n√†y hi·ªán kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>";
                }
                viewer.style.display = "block";
                db.close();
            };
        };
    }

    // --- 2. EXPORT ---
    function exportStore(dbName, storeName) {
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            db.transaction(storeName, "readonly").objectStore(storeName).getAll().onsuccess = (ev) => {
                const blob = new Blob([JSON.stringify(ev.target.result, null, 2)], {type: 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Export_${dbName}_${storeName}.json`;
                a.click();
                writeLog(`‚úÖ ƒê√£ xu·∫•t d·ªØ li·ªáu ${storeName} th√†nh c√¥ng.`);
                db.close();
            };
        };
    }

    // --- 3. IMPORT ---
    function importToStore(event, dbName, storeName, safeId) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const items = JSON.parse(e.target.result);
                const req = indexedDB.open(dbName);
                req.onsuccess = (ev) => {
                    const db = ev.target.result;
                    const tx = db.transaction(storeName, "readwrite");
                    const store = tx.objectStore(storeName);
                    items.forEach(item => store.put(item));
                    tx.oncomplete = () => {
                        writeLog(`‚úÖ ƒê√£ nh·∫≠p ${items.length} b·∫£n ghi v√†o ${storeName}.`);
                        updateCount(dbName, storeName, safeId);
                        db.close();
                    };
                };
            } catch (err) { writeLog("‚ùå L·ªói: File JSON kh√¥ng h·ª£p l·ªá."); }
        };
        reader.readAsText(file);
    }

    // --- 4. CLEAR ---
    function clearStore(dbName, storeName, safeId) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫°ch d·ªØ li·ªáu trong b·∫£ng [${storeName}]?`)) return;
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction(storeName, "readwrite");
            tx.objectStore(storeName).clear();
            tx.oncomplete = () => {
                writeLog(`üóëÔ∏è ƒê√£ x√≥a s·∫°ch b·∫£ng ${storeName}.`);
                updateCount(dbName, storeName, safeId);
                document.getElementById(`view_${safeId}`).style.display = "none";
                db.close();
            };
        };
    }

    function updateCount(dbName, storeName, safeId) {
        const req = indexedDB.open(dbName);
        req.onsuccess = (e) => {
            const db = e.target.result;
            db.transaction(storeName, "readonly").objectStore(storeName).count().onsuccess = (ev) => {
                document.getElementById(`count_${safeId}`).innerText = `${ev.target.result} records`;
                db.close();
            };
        };
    }
</script>

</body>
</html>