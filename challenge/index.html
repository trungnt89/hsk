<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Mastery Matrix V16.1 - Auto-Expanding Rows</title>
    <style>
        :root { 
            --primary: #4f46e5; --success: #10b981; --fail: #ef4444; 
            --bg: #f8fafc; --text: #1e293b; --weekend: #fff1f2; --warning: #f59e0b;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.05); margin: auto; max-width: 1250px; }
        
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 280px; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 15px; min-height: 180px; }
        
        .chart-row { margin-bottom: 12px; }
        .chart-label { font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-bg { background: #f1f5f9; height: 10px; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.6s ease; }

        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-label { font-weight: 800; font-size: 1.2rem; color: var(--primary); min-width: 160px; text-align: center; }

        .table-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 12px; }
        table { border-collapse: collapse; width: max-content; background: white; }

        .sticky-col { 
            position: sticky; left: 0; z-index: 100; background: #fff; width: 200px; 
            border-right: 3px solid #e2e8f0; padding: 10px; box-shadow: 4px 0 6px -4px rgba(0,0,0,0.1);
            vertical-align: middle; /* CƒÉn gi·ªØa n·ªôi dung khi √¥ cao */
        }
        
        /* CSS Quan tr·ªçng ƒë·ªÉ gi√£n √¥ */
        .habit-name-box { 
            width: 100%; border: none; font-weight: 700; font-size: 14px; 
            color: var(--text); resize: none; background: transparent; outline: none;
            overflow: hidden; /* ·∫®n thanh cu·ªôn c·ªßa textarea */
            display: block;
            line-height: 1.4;
            height: auto;
            min-height: 20px;
        }

        .day-col { width: 45px; text-align: center; border: 1px solid #f1f5f9; vertical-align: middle; }
        .day-header { height: 60px; background: #f8fafc; }
        
        .mark { 
            width: 32px; height: 32px; margin: auto; border-radius: 8px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; background: #f1f5f9; transition: 0.2s; 
        }
        
        .status-done { background: var(--success) !important; color: white; }
        .status-fail { background: var(--fail) !important; color: white; }
        .is-today { background: var(--primary) !important; color: white !important; }
        .weekend { background: var(--weekend) !important; }

        .warning-alert { background: #fff7ed; border-left: 4px solid var(--warning); padding: 10px; margin-bottom: 8px; border-radius: 4px; color: #9a3412; font-size: 12px; }
        .btn-delete { color: #cbd5e1; cursor: pointer; font-size: 18px; }
        button { cursor: pointer; border: none; border-radius: 8px; padding: 10px 18px; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-nav { background: #f1f5f9; color: var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <div class="header-area">
        <h2 style="margin:0; color: var(--primary)">‚öîÔ∏è K·ª∑ Lu·∫≠t To√†n Di·ªán</h2>
        <div style="display:flex; gap:10px; align-items:center">
            <button class="btn-nav" onclick="moveMonth(-1)">‚óÄ</button>
            <div class="month-label" id="mLabel">Th√°ng 01/2026</div>
            <button class="btn-nav" onclick="moveMonth(1)">‚ñ∂</button>
            <button class="btn-primary" onclick="addNewHabit()">+ Th√™m vi·ªác</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="chart-container">
            <h4 style="margin:0 0 15px 0">T·ªâ l·ªá ho√†n th√†nh</h4>
            <div id="barCharts"></div>
        </div>
        <div class="chart-container">
            <h4 style="margin:0 0 10px 0">C·∫£nh b√°o chu·ªói X ‚ö†Ô∏è</h4>
            <div id="streakWarnings"></div>
        </div>
        <div class="chart-container" style="text-align: center; display:flex; flex-direction:column; justify-content:center; background: var(--fail); color: white; border:none">
            <h4 style="margin:0">C·∫ßn c·∫£i thi·ªán ‚ö†Ô∏è</h4>
            <div id="worstHabit" style="font-size: 18px; font-weight: 800; margin: 10px 0; color: #fff">--</div>
            <p style="margin:0; opacity: 0.9; font-size: 12px;">√çt ng√†y th·ª±c hi·ªán nh·∫•t</p>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script>
    let habits = JSON.parse(localStorage.getItem('v16_habits')) || [
        { id: 1, name: "T·∫≠p th·ªÉ d·ª•c m·ªói s√°ng ƒë·ªÉ n√¢ng cao s·ª©c kh·ªèe" }, 
        { id: 2, name: "H·ªçc ngo·∫°i ng·ªØ" }
    ];
    let logs = JSON.parse(localStorage.getItem('v16_logs')) || {};
    let displayDate = new Date();
    const today = new Date(); today.setHours(0,0,0,0);

    function save() { localStorage.setItem('v16_habits', JSON.stringify(habits)); localStorage.setItem('v16_logs', JSON.stringify(logs)); }
    function moveMonth(s) { displayDate.setMonth(displayDate.getMonth() + s); render(); }
    function addNewHabit() { habits.push({ id: Date.now(), name: "Vi·ªác m·ªõi" }); save(); render(); }
    function deleteHabit(id) { if(confirm('X√≥a th√≥i quen n√†y?')) { habits = habits.filter(h => h.id !== id); save(); render(); } }

    // T·ª± ƒë·ªông gi√£n textarea theo n·ªôi dung
    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function runAutoFailAllHistory() {
        let hasChange = false;
        let checkDate = new Date(today);
        checkDate.setMonth(checkDate.getMonth() - 2); // Qu√©t 2 th√°ng g·∫ßn nh·∫•t
        checkDate.setDate(1);
        while (checkDate < today) {
            const dStr = checkDate.toISOString().split('T')[0];
            if (!logs[dStr]) logs[dStr] = {};
            habits.forEach(h => {
                if (logs[dStr][h.id] === undefined || logs[dStr][h.id] === null) {
                    logs[dStr][h.id] = 'fail'; hasChange = true;
                }
            });
            checkDate.setDate(checkDate.getDate() + 1);
        }
        if (hasChange) save();
    }

    function toggle(d, id) {
        if(!logs[d]) logs[d] = {};
        const cur = logs[d][id];
        logs[d][id] = (cur === 'done') ? 'fail' : (cur === 'fail' ? null : 'done');
        save(); render();
    }

    function render() {
        runAutoFailAllHistory();
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        document.getElementById('mLabel').innerText = `Th√°ng ${(month + 1).toString().padStart(2, '0')}/${year}`;

        let worstH = { name: '--', count: 999 };
        let barHtml = '';
        let warningHtml = '';

        habits.forEach(h => {
            let doneCount = 0; let currentXStreak = 0;
            for (let i = 1; i <= daysInMonth; i++) {
                const dStr = new Date(year, month, i).toISOString().split('T')[0];
                const status = logs[dStr]?.[h.id];
                if (status === 'done') { doneCount++; currentXStreak = 0; }
                else if (status === 'fail') { currentXStreak++; }
            }
            if(doneCount < worstH.count) worstH = { name: h.name, count: doneCount };
            const pct = Math.round((doneCount / daysInMonth) * 100) || 0;
            barHtml += `<div class="chart-row">
                <span class="chart-label">${h.name} (${pct}%)</span>
                <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${pct > 70 ? 'var(--success)' : 'var(--primary)'}"></div></div>
            </div>`;
            if (currentXStreak >= 3) warningHtml += `<div class="warning-alert">üö© <b>${h.name}</b>: Chu·ªói l∆∞·ªùi ${currentXStreak} ng√†y!</div>`;
        });

        document.getElementById('barCharts').innerHTML = barHtml;
        document.getElementById('streakWarnings').innerHTML = warningHtml || '<p style="font-size:12px; color:var(--success)">Phong ƒë·ªô ·ªïn ƒë·ªãnh!</p>';
        document.getElementById('worstHabit').innerText = worstH.name;

        // Render Table
        let headHtml = `<tr><th class="sticky-col">M·ª•c ti√™u</th>`;
        for(let i=1; i<=daysInMonth; i++) {
            const d = new Date(year, month, i);
            const isT = d.toISOString().split('T')[0] === today.toISOString().split('T')[0];
            headHtml += `<th class="day-col ${isT ? 'is-today' : ''} ${d.getDay()%6===0?'weekend':''}">
                <div style="font-size:9px">${d.toLocaleDateString('vi-VN',{weekday:'short'}).replace('Th ','T')}</div>
                <b>${i}</b></th>`;
        }
        document.getElementById('tHead').innerHTML = headHtml + `<th>#</th></tr>`;

        let bodyHtml = '';
        habits.forEach(h => {
            bodyHtml += `<tr><td class="sticky-col">
                <textarea class="habit-name-box" oninput="autoResize(this)" onchange="h.name=this.value; save(); render();">${h.name}</textarea>
            </td>`;
            for(let i=1; i<=daysInMonth; i++) {
                const dStr = new Date(year, month, i).toISOString().split('T')[0];
                const st = logs[dStr]?.[h.id] || '';
                bodyHtml += `<td class="day-col ${new Date(year,month,i).getDay()%6===0?'weekend':''}">
                    <div class="mark status-${st}" onclick="toggle('${dStr}', ${h.id})">${st==='done'?'‚úì':(st==='fail'?'‚úï':'')}</div>
                </td>`;
            }
            bodyHtml += `<td class="day-col"><span class="btn-delete" onclick="deleteHabit(${h.id})">üóë</span></td></tr>`;
        });
        document.getElementById('tBody').innerHTML = bodyHtml;

        // K√≠ch ho·∫°t auto-resize cho t·∫•t c·∫£ textarea ngay sau khi render
        document.querySelectorAll('.habit-name-box').forEach(el => autoResize(el));
    }
    render();
</script>
</body>
</html>