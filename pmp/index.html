<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PMP Master - Book Flip Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="data1.js"></script>
    <script src="data2.js"></script>
    <script src="data3.js"></script>

    <style>
        :root { 
            --primary: #007AFF; --easy: #28CD41; --medium: #FF9500; --hard: #FF3B30;
            --bg: #8E8E93; --card: #FFFFFF; --text-main: #1C1C1E; --text-sub: #8E8E93;
            --ios-blur: rgba(255, 255, 255, 0.9);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100vw; 
            font-family: -apple-system, 'Inter', sans-serif; 
            background-color: var(--bg); display: flex; flex-direction: column; 
            overflow: hidden; touch-action: pan-y;
        }

        /* --- HEADER & NAVIGATION --- */
        .top-section { 
            background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px); 
            border-bottom: 0.5px solid rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000; 
            padding-top: env(safe-area-inset-top);
        }
        .main-nav { padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .brand { font-size: 18px; font-weight: 900; color: var(--text-main); }
        .brand span { color: var(--primary); }
        
        .set-capsule-select {
            border: none; padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 700; 
            background: rgba(0,0,0,0.08); color: var(--primary); outline: none; -webkit-appearance: none;
        }

        /* Đồng bộ thứ tự: Mới -> Dễ -> Vừa -> Khó */
        .filter-bar { padding: 4px 16px 12px; display: flex; gap: 6px; }
        .tab-btn {
            flex: 1; border: none; padding: 8px 0; border-radius: 10px; font-size: 10px; font-weight: 700; 
            background: #D1D1D6; color: #3A3A3C; transition: 0.3s;
        }
        .tab-btn[data-type="todo"].active { background: white; color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .tab-btn[data-type="Easy"].active { background: var(--easy); color: white; }
        .tab-btn[data-type="Medium"].active { background: var(--medium); color: white; }
        .tab-btn[data-type="Hard"].active { background: var(--hard); color: white; }

        /* --- VIEWPORT 3D --- */
        .viewport {
            flex-grow: 1; perspective: 2000px; position: relative;
            margin: 12px; overflow: visible;
        }

        #book-page {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            will-change: transform;
        }

        /* Hiệu ứng lật trang */
        .page-flip-next { transform: rotateY(-100deg); opacity: 0; }
        .page-flip-prev { transform: rotateY(100deg); opacity: 0; }

        .main-display { 
            position: absolute; width: 100%; height: 100%;
            background: var(--card); border-radius: 20px;
            padding: 20px; box-sizing: border-box; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backface-visibility: hidden;
        }

        /* --- CHIPS ĐỒNG BỘ: DỄ -> VỪA -> KHÓ --- */
        .chip-group { display: flex; gap: 5px; }
        .chip { 
            border: none; padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; 
            background: #E5E5EA; color: #8E8E93; transition: 0.2s;
        }
        .chip.active-easy { background: var(--easy) !important; color: white; }
        .chip.active-medium { background: var(--medium) !important; color: white; }
        .chip.active-hard { background: var(--hard) !important; color: white; }

        /* --- UI COMPONENTS --- */
        .q-text { font-size: 17px; font-weight: 700; line-height: 1.5; color: var(--text-main); margin: 15px 0; }
        .option-item { 
            font-size: 15px; padding: 15px; background: #F2F2F7; border-radius: 14px; 
            margin-bottom: 8px; border: 2px solid transparent; transition: 0.2s;
        }
        .option-item.selected { border-color: var(--primary); background: #E5F1FF; }
        .option-item.is-correct { background: #EFFFF3 !important; border-color: var(--easy) !important; color: #1A8B31 !important; }
        .option-item.is-wrong { background: #FFF2F2 !important; border-color: var(--hard) !important; color: #B71C1C !important; }

        .iphone-bar { 
            height: 65px; background: var(--ios-blur); backdrop-filter: saturate(180%) blur(20px);
            border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; align-items: center; 
            position: fixed; bottom: 0; width: 100%; z-index: 1000; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-item { flex: 1; border: none; background: transparent; display: flex; flex-direction: column; align-items: center; color: #8E8E93; }
        .tab-item i { font-style: normal; font-size: 24px; font-weight: bold; }
        .tab-item.active-nav { color: var(--primary); }
    </style>
</head>
<body>

<div class="top-section">
    <div class="main-nav">
        <div class="brand">PMP<span>MASTER</span></div>
        <select class="set-capsule-select" id="set-select" onchange="changeExamSet(this.value)">
            <option value="DATA_SET_1">ĐỀ THI 01</option>
            <option value="DATA_SET_2">ĐỀ THI 02</option>
            <option value="DATA_SET_3">ĐỀ THI 03</option>
        </select>
    </div>
    <div class="filter-bar">
        <button class="tab-btn active" data-type="todo" onclick="switchTab('todo')">MỚI</button>
        <button class="tab-btn" data-type="Easy" onclick="switchTab('Easy')">DỄ</button>
        <button class="tab-btn" data-type="Medium" onclick="switchTab('Medium')">VỪA</button>
        <button class="tab-btn" data-type="Hard" onclick="switchTab('Hard')">KHÓ</button>
    </div>
</div>

<div class="viewport">
    <div id="book-page">
        <div class="main-display" id="display-area"></div>
    </div>
</div>

<div class="iphone-bar">
    <button class="tab-item" id="prev-btn" onclick="triggerFlip('prev')"><i>‹</i><small>Trước</small></button>
    <button class="tab-item" id="info-btn" onclick="toggleInfo()">
        <i id="eye-icon">◎</i><small>Đáp án</small>
    </button>
    <button class="tab-item" id="next-btn" onclick="triggerFlip('next')"><i>›</i><small>Tiếp</small></button>
</div>

<script>
let pmpData = []; let filteredQuestions = []; let currentIndexInSet = 0; let currentTab = 'todo';
let selectedOption = null; let isConfirmed = false; let currentSetName = ""; 
const STORAGE_PREFIX = "PMP_V15_";

// --- HIỆU ỨNG LẬT TRANG SÁCH CHUYÊN NGHIỆP ---
function triggerFlip(direction) {
    const page = document.getElementById('book-page');
    if (direction === 'next' && currentIndexInSet < filteredQuestions.length - 1) {
        page.style.transformOrigin = "left center";
        page.classList.add('page-flip-next');
        setTimeout(() => {
            nextQuestion();
            page.style.transition = 'none';
            page.style.transform = 'rotateY(100deg)';
            setTimeout(() => {
                page.style.transition = 'transform 0.6s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity 0.4s';
                page.classList.remove('page-flip-next');
                page.style.transform = 'rotateY(0deg)';
            }, 50);
        }, 400);
    } else if (direction === 'prev' && currentIndexInSet > 0) {
        page.style.transformOrigin = "right center";
        page.classList.add('page-flip-prev');
        setTimeout(() => {
            prevQuestion();
            page.style.transition = 'none';
            page.style.transform = 'rotateY(-100deg)';
            setTimeout(() => {
                page.style.transition = 'transform 0.6s cubic-bezier(0.45, 0.05, 0.55, 0.95), opacity 0.4s';
                page.classList.remove('page-flip-prev');
                page.style.transform = 'rotateY(0deg)';
            }, 50);
        }, 400);
    }
}

// Cử chỉ vuốt
let touchstartX = 0;
document.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, {passive: true});
document.addEventListener('touchend', e => {
    let diffX = e.changedTouches[0].screenX - touchstartX;
    if (Math.abs(diffX) > 80) { if (diffX < 0) triggerFlip('next'); else triggerFlip('prev'); }
}, {passive: true});

// --- DỮ LIỆU & RENDER ---
function changeExamSet(v) {
    let data = window[v] || (typeof eval !== 'undefined' ? eval(v) : null);
    if (data) { pmpData = data; currentSetName = v; currentIndexInSet = 0; updateFilteredData(); }
}

function updateFilteredData() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
        btn.classList.toggle('active', type === currentTab);
    });
    filteredQuestions = pmpData.filter(q => { const lv = stored[q.id]; return currentTab === 'todo' ? !lv : lv === currentTab; });
    renderQuestion();
}

function renderQuestion() {
    const area = document.getElementById('display-area');
    const q = filteredQuestions[currentIndexInSet];
    document.getElementById('prev-btn').style.opacity = (currentIndexInSet === 0) ? "0.1" : "1";
    document.getElementById('next-btn').style.opacity = (currentIndexInSet >= filteredQuestions.length - 1) ? "0.1" : "1";
    
    resetInfoBtn();
    if (!q) { area.innerHTML = `<div style="text-align:center; padding-top:100px; color:var(--text-sub);">HẾT CÂU HỎI</div>`; return; }
    
    selectedOption = null; isConfirmed = false;
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const lv = stored[q.id];

    let opts = '';
    for (const [key, val] of Object.entries(q.options)) {
        opts += `<div class="option-item" id="opt-${key}" onclick="selectOption('${key}')"><b>${key}.</b> ${val}</div>`;
    }

    // Giao diện Chip đồng bộ: Dễ -> Vừa -> Khó
    area.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div style="font-size:12px; font-weight:800; color:var(--text-sub);">ID: #${q.id}</div>
            <div class="chip-group">
                <button class="chip ${lv==='Easy'?'active-easy':''}" onclick="updateLevel(this,'${q.id}','Easy')">DỄ</button>
                <button class="chip ${lv==='Medium'?'active-medium':''}" onclick="updateLevel(this,'${q.id}','Medium')">VỪA</button>
                <button class="chip ${lv==='Hard'?'active-hard':''}" onclick="updateLevel(this,'${q.id}','Hard')">KHÓ</button>
            </div>
        </div>
        <div style="font-size:11px; color:var(--primary); font-weight:700;">CÂU ${currentIndexInSet + 1} / ${filteredQuestions.length}</div>
        <div class="q-text">${q.question}</div>
        <div class="options-list">${opts}</div>
        <div id="explanation-area"></div>
    `;
    area.scrollTo(0,0);
}

function updateLevel(btn, id, lv) {
    const key = STORAGE_PREFIX + currentSetName;
    const stored = JSON.parse(localStorage.getItem(key) || "{}");
    if (stored[id] === lv) delete stored[id]; else stored[id] = lv;
    localStorage.setItem(key, JSON.stringify(stored));
    
    const parent = btn.parentElement;
    parent.querySelectorAll('.chip').forEach(c => c.classList.remove('active-easy','active-medium','active-hard'));
    if (stored[id]) btn.classList.add('active-' + lv.toLowerCase());
    updateTabCountsOnly();
}

function updateTabCountsOnly() {
    const stored = JSON.parse(localStorage.getItem(STORAGE_PREFIX + currentSetName) || "{}");
    const counts = { todo: 0, Easy: 0, Medium: 0, Hard: 0 };
    pmpData.forEach(q => { const lv = stored[q.id]; if (!lv) counts.todo++; else counts[lv]++; });
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const type = btn.getAttribute('data-type');
        btn.innerText = `${type==='todo'?'MỚI':type.toUpperCase()} (${counts[type]})`;
    });
}

function selectOption(k) { 
    if(isConfirmed) return; 
    selectedOption = k; 
    document.querySelectorAll('.option-item').forEach(e => e.classList.remove('selected')); 
    document.getElementById(`opt-${k}`).classList.add('selected'); 
    setTimeout(() => { if(!isConfirmed) showAnswerUI(); }, 400); // Tự động hiện đáp án sau khi chọn
}

function showAnswerUI() {
    const q = filteredQuestions[currentIndexInSet];
    isConfirmed = true; 
    document.getElementById('info-btn').classList.add('active-nav');
    document.querySelectorAll('.option-item').forEach(e => e.classList.remove('is-correct','is-wrong','selected'));
    if (selectedOption === q.answer) {
        document.getElementById(`opt-${selectedOption}`).classList.add('is-correct');
    } else {
        if(selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('is-wrong');
        document.getElementById(`opt-${q.answer}`).classList.add('is-correct');
    }
    document.getElementById('explanation-area').innerHTML = `<div style="margin-top:15px; padding:15px; background:#F2F2F7; border-radius:15px; font-size:14px; border-left:4px solid var(--primary);"><b>Giải thích:</b><br>${q.explanation}</div>`;
}

function toggleInfo() {
    if(!isConfirmed) showAnswerUI();
    else { isConfirmed = false; resetInfoBtn(); document.getElementById('explanation-area').innerHTML = ''; document.querySelectorAll('.option-item').forEach(e => e.classList.remove('is-correct','is-wrong')); if (selectedOption) document.getElementById(`opt-${selectedOption}`).classList.add('selected'); }
}

function resetInfoBtn() { document.getElementById('info-btn').classList.remove('active-nav'); }
function switchTab(t) { currentTab = t; currentIndexInSet = 0; updateFilteredData(); }
function nextQuestion() { if(currentIndexInSet < filteredQuestions.length-1) { currentIndexInSet++; renderQuestion(); } }
function prevQuestion() { if(currentIndexInSet > 0) { currentIndexInSet--; renderQuestion(); } }

window.addEventListener('DOMContentLoaded', () => { changeExamSet(document.getElementById('set-select').value); });
</script>
</body>
</html>