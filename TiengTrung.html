<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>HSK1 â€“ 10 Tá»« / Trang (Fix Shuffle Bug)</title>

<style>
body { font-family: Arial, sans-serif; background:#f7f7f7; padding:20px; }
h1 { text-align:center; }
button { padding:8px 16px; margin:4px; cursor:pointer; }
.active-btn { background:#4CAF50; color:white; }
.shuffle-btn { background:#ff9800; color:white; }
.word {
  background:white; padding:10px; margin:6px 0;
  border-radius:6px; display:flex; justify-content:space-between;
}
.highlight { background:#fff3cd !important; border-left:6px solid #ff9800; }
#list { max-height:65vh; overflow-y:auto; }
.page-info { text-align:center; font-weight:bold; margin:10px; }
</style>
</head>

<body>

<h1>ğŸ“˜ HSK1 â€“ 10 Tá»« / Trang (á»”n Ä‘á»‹nh)</h1>

<button id="maleBtn" onclick="setVoice('male')">ğŸ‘¨ Nam</button>
<button id="femaleBtn" onclick="setVoice('female')">ğŸ‘© Ná»¯</button>
<button id="shuffleBtn" onclick="toggleShuffle()">ğŸ”€ Shuffle</button><br>

<button onclick="startAuto()">â–¶ Äá»c trang</button>
<button onclick="stopAuto()">â¹ Stop</button><br>

<button onclick="prevPage()">â¬… Trang trÆ°á»›c</button>
<button onclick="nextPage()">â¡ Trang sau</button>

<div class="page-info" id="pageInfo"></div>
<div id="list"></div>

<script>
/* ===== DATA ===== */
const words = [
"çˆ±","å…«","çˆ¸çˆ¸","æ¯å­","åŒ—äº¬","æœ¬","ä¸å®¢æ°”","ä¸","èœ","èŒ¶",
"åƒ","å‡ºç§Ÿè½¦","æ‰“ç”µè¯","å¤§","çš„","ç‚¹","ç”µè„‘","ç”µè§†","ç”µå½±","ä¸œè¥¿",
"éƒ½","è¯»","å¯¹ä¸èµ·","å¤š","å¤šå°‘","å„¿å­","äºŒ","é¥­é¦†","é£æœº","åˆ†é’Ÿ",
"é«˜å…´","ä¸ª","å·¥ä½œ","ç‹—","æ±‰è¯­","å¥½","å–","å’Œ","å¾ˆ","åé¢",
"å›","ä¼š","ç«è½¦ç«™","å‡ ","å®¶","å«","ä»Šå¤©","ä¹","å¼€","çœ‹",
"çœ‹è§","å—","æ¥","è€å¸ˆ","äº†","å†·","é‡Œ","é›¶","å…­","å¦ˆå¦ˆ",
"å—","ä¹°","çŒ«","æ²¡","æ²¡å…³ç³»","ç±³é¥­","æ˜å¤©","åå­—","å“ªé‡Œ","é‚£",
"å‘¢","èƒ½","ä½ ","å¹´","å¥³å„¿","æœ‹å‹","æ¼‚äº®","è‹¹æœ","ä¸ƒ","é’±",
"å‰é¢","è¯·","å»","çƒ­","äºº","è®¤è¯†","æ—¥","ä¸‰","å•†åº—","ä¸Š",
"ä¸Šåˆ","å°‘","è°","ä»€ä¹ˆ","å","æ—¶å€™","æ˜¯","ä¹¦","æ°´","æ°´æœ",
"ç¡è§‰","è¯´è¯","å››","å²","ä»–","å¥¹","å¤ª","å¤©æ°”","å¬","åŒå­¦",
"å–‚","æˆ‘","æˆ‘ä»¬","äº”","å–œæ¬¢","ä¸‹","ä¸‹åˆ","ä¸‹é›¨","å…ˆç”Ÿ","ç°åœ¨",
"æƒ³","å°","å°å§","äº›","å†™","è°¢è°¢","æ˜ŸæœŸ","å­¦ç”Ÿ","å­¦ä¹ ","å­¦æ ¡",
"ä¸€","è¡£æœ","åŒ»ç”Ÿ","åŒ»é™¢","æ¤…å­","æœˆ","åœ¨","å†è§","æ€ä¹ˆ","æ€ä¹ˆæ ·",
"è¿™","ä¸­å›½","ä¸­åˆ","ä½","æ¡Œå­","å­—","æ˜¨å¤©","å","åš"
];

const pageSize = 10;

/* ===== STATE ===== */
let currentPage = 0;
let currentIndex = 0;
let isPlaying = false;
let isShuffle = false;

let basePageWords = [];
let playQueue = [];

let voices=[], maleVoice=null, femaleVoice=null, currentVoice=null;

/* ===== VOICE ===== */
speechSynthesis.onvoiceschanged = () => {
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith("zh"));
  maleVoice = voices[0];
  femaleVoice = voices.find(v => /female|ting|hui|mei/i.test(v.name)) || voices[0];
  currentVoice = maleVoice;
  maleBtn.classList.add("active-btn");
};

function setVoice(type){
  currentVoice = type==="male"?maleVoice:femaleVoice;
  maleBtn.classList.toggle("active-btn", type==="male");
  femaleBtn.classList.toggle("active-btn", type==="female");
}

/* ===== SHUFFLE ===== */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

/* ===== PAGE ===== */
function loadPage(){
  const start=currentPage*pageSize;
  basePageWords = words.slice(start,start+pageSize);
  prepareQueue();
  render();
}

function prepareQueue(){
  playQueue = [...basePageWords];
  if(isShuffle) shuffle(playQueue);
}

/* ===== UI ===== */
function render(){
  list.innerHTML="";
  playQueue.forEach((w,i)=>{
    const div=document.createElement("div");
    div.className="word";
    div.id="word-"+i;
    div.innerHTML=`<strong style="font-size:22px">${w}</strong>
      <button onclick="speakSingle('${w}',${i})">â–¶</button>`;
    list.appendChild(div);
  });
  pageInfo.innerText=`Trang ${currentPage+1}/${Math.ceil(words.length/pageSize)}`
    +(isShuffle?" (Shuffle má»—i vÃ²ng)":"");
}

function highlight(i){
  document.querySelectorAll(".word").forEach(e=>e.classList.remove("highlight"));
  const el=document.getElementById("word-"+i);
  if(el){
    el.classList.add("highlight");
    el.scrollIntoView({behavior:"smooth",block:"center"});
  }
}

/* ===== SPEAK ===== */
function speakSingle(word,i){
  speechSynthesis.cancel();
  highlight(i);
  const u=new SpeechSynthesisUtterance(word);
  u.lang="zh-CN"; u.voice=currentVoice;
  speechSynthesis.speak(u);
}

function startAuto(){
  if(isPlaying) return;
  isPlaying=true;
  currentIndex=0;
  prepareQueue();
  render();
  speechSynthesis.cancel();
  speakNext();
}

function speakNext(){
  if(!isPlaying) return;

  if(currentIndex>=playQueue.length){
    currentIndex=0;
    prepareQueue();   // shuffle cho vÃ²ng má»›i
    render();
  }

  const word=playQueue[currentIndex];
  highlight(currentIndex);

  const u=new SpeechSynthesisUtterance(word);
  u.lang="zh-CN"; u.voice=currentVoice;
  u.onend=()=>{ currentIndex++; setTimeout(speakNext,800); };
  speechSynthesis.speak(u);
}

function stopAuto(){
  isPlaying=false;
  speechSynthesis.cancel();
  document.querySelectorAll(".word").forEach(e=>e.classList.remove("highlight"));
}

/* ===== CONTROL ===== */
function toggleShuffle(){
  isShuffle=!isShuffle;
  shuffleBtn.classList.toggle("shuffle-btn",isShuffle);
  stopAuto();
  loadPage();
}
function nextPage(){ if((currentPage+1)*pageSize<words.length){ stopAuto(); currentPage++; loadPage(); } }
function prevPage(){ if(currentPage>0){ stopAuto(); currentPage--; loadPage(); } }

/* INIT */
loadPage();
</script>

</body>
</html>
