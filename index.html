<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>HSK1 ‚Äì Luy·ªán Nghe</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 12px;
  background: #f4f4f4;
  color: #222;
}

h1 {
  text-align: center;
  margin: 6px 0 10px;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 6px;
}

button {
  padding: 6px 10px;
  font-size: 14px;
  cursor: pointer;
}

button.active {
  background: #4caf50;
  color: #fff;
}

#pageInfo {
  text-align: center;
  font-weight: bold;
  margin: 6px 0;
}

#wordList {
  max-height: 72vh;
  overflow-y: auto;
}

.word-item {
  background: #ffffff;
  padding: 10px;
  margin-bottom: 6px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.word-item.active {
  background: #fff3cd;
  border-left: 5px solid #ff9800;
}

.word-main {
  font-size: 22px;
  font-weight: bold;
  color: #111;
}

.word-sub {
  font-size: 14px;
  color: #444;
}
</style>
</head>

<body>

<h1>üìò HSK1 ‚Äì Luy·ªán Nghe</h1>

<div class="controls">
  <button onclick="unlockAudio()">üîä K√≠ch ho·∫°t √¢m thanh</button>
  <button id="browserBtn" class="active" onclick="setTts('browser')">Browser</button>
  <button id="shuffleBtn" onclick="toggleShuffle()">üîÄ ƒê·∫£o t·ª´</button>
</div>

<div class="controls">
  <button onclick="startAuto()">‚ñ∂ ƒê·ªçc trang</button>
  <button onclick="stopAuto()">‚èπ Stop</button>
  <button onclick="prevPage()">‚¨Ö Tr∆∞·ªõc</button>
  <button onclick="nextPage()">‚û° Sau</button>
</div>

<div id="pageInfo"></div>
<div id="wordList"></div>

<script src="data.js"></script>

<script>
/* ================= CONFIG ================= */
const PAGE_SIZE = 10;

/* ================= STATE ================= */
let currentPage = Number(localStorage.getItem("hsk_page")) || 0;
let isShuffle   = localStorage.getItem("hsk_shuffle") === "1";
let audioUnlocked = false;
let isPlaying = false;
let currentIndex = 0;

/* QUEUE DUY NH·∫§T ‚Äì UI + AUDIO D√ôNG CHUNG */
let playQueue = [];

/* ================= DOM ================= */
const listEl = document.getElementById("wordList");
const pageInfo = document.getElementById("pageInfo");
const shuffleBtn = document.getElementById("shuffleBtn");
const browserBtn = document.getElementById("browserBtn");

/* ================= UTILS ================= */
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

/* ================= DATA ================= */
function getTotalPages() {
  return Math.ceil(WORDS.length / PAGE_SIZE);
}

function prepareQueue() {
  const start = currentPage * PAGE_SIZE;
  playQueue = WORDS.slice(start, start + PAGE_SIZE);
  if (isShuffle) shuffleArray(playQueue);
}

/* ================= UI ================= */
function render() {
  listEl.innerHTML = "";

  playQueue.forEach((w, i) => {
    const div = document.createElement("div");
    div.className = "word-item";
    div.innerHTML = `
      <div>
        <div class="word-main">${w.hanzi}</div>
        <div class="word-sub">${w.pinyin} ‚Äì ${w.vi}</div>
      </div>
      <button onclick="speakSingle(${i})">‚ñ∂</button>
    `;
    listEl.appendChild(div);
  });

  pageInfo.textContent = `Trang ${currentPage + 1} / ${getTotalPages()}`;
  shuffleBtn.classList.toggle("active", isShuffle);
}

function highlight(i) {
  document.querySelectorAll(".word-item").forEach((el, idx) => {
    el.classList.toggle("active", idx === i);
    if (idx === i) el.scrollIntoView({ block: "center" });
  });
}

/* ================= AUDIO ================= */
function unlockAudio() {
  // üîë B·∫ÆT BU·ªòC ƒë·ªÉ mobile cho ph√©p ph√°t √¢m thanh
  const u = new SpeechSynthesisUtterance("‰∏Ä");
  u.lang = "zh-CN";
  speechSynthesis.speak(u);

  audioUnlocked = true;
  alert("√Çm thanh ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t");
}

function speak(text, onEnd) {
  if (!audioUnlocked) return;

  speechSynthesis.cancel(); // tr√°nh ch·ªìng ti·∫øng
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "zh-CN";
  u.onend = onEnd;
  speechSynthesis.speak(u);
}

/* ================= ACTION ================= */
function speakSingle(i) {
  if (!audioUnlocked) return alert("H√£y b·∫•m 'K√≠ch ho·∫°t √¢m thanh' tr∆∞·ªõc");
  highlight(i);
  speak(playQueue[i].hanzi);
}

function startAuto() {
  if (!audioUnlocked) return alert("H√£y b·∫•m 'K√≠ch ho·∫°t √¢m thanh' tr∆∞·ªõc");
  isPlaying = true;
  currentIndex = 0;
  speakNext();
}

function speakNext() {
  if (!isPlaying) return;

  if (currentIndex >= playQueue.length) {
    currentIndex = 0;
    if (isShuffle) {
      shuffleArray(playQueue);
      render();
    }
  }

  highlight(currentIndex);
  speak(playQueue[currentIndex].hanzi, () => {
    currentIndex++;
    setTimeout(speakNext, 700);
  });
}

function stopAuto() {
  isPlaying = false;
  speechSynthesis.cancel();
}

/* ================= PAGINATION ================= */
function nextPage() {
  if (currentPage < getTotalPages() - 1) {
    currentPage++;
    localStorage.setItem("hsk_page", currentPage);
    stopAuto();
    prepareQueue();
    render();
  }
}

function prevPage() {
  if (currentPage > 0) {
    currentPage--;
    localStorage.setItem("hsk_page", currentPage);
    stopAuto();
    prepareQueue();
    render();
  }
}

function toggleShuffle() {
  isShuffle = !isShuffle;
  localStorage.setItem("hsk_shuffle", isShuffle ? "1" : "0");
  stopAuto();
  prepareQueue();
  render();
}

/* ================= INIT ================= */
prepareQueue();
render();
</script>

</body>
</html>
